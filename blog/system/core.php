<?php $stopwatch=microtime(); define('E2_VERSION',2858); define('E2_RELEASE','2.4'); define('E2_UA_STRING','E2 (v'.E2_VERSION.'; Aegea)'); header('X-Powered-By: E2 Aegea v'. E2_VERSION); define('OUTPUT_CHARSET','UTF-8'); define('TRANS_TAGS_UTF8_URLS',false); define('TRANS_TAGS_INTERSECT',true); setlocale(LC_CTYPE,'ru_RU.UTF'); mb_internal_encoding('UTF-8'); define('HSC_ENC','UTF-8'); if(function_exists('date_default_timezone_set'))date_default_timezone_set('GMT'); error_reporting(E_ALL); define('RUN_ID',chr(rand(65,90))); define('DEV_TRACK_TIME',false); define('DEV_HOST','e2'); define('E2_WEBSITE_HOST','blogengine.ru'); define('E2_WEBSITE','http://'. E2_WEBSITE_HOST .'/'); define('SECONDS_IN_A_MINUTE',60); define('SECONDS_IN_AN_HOUR',3600); define('SECONDS_IN_A_DAY',86400); define('SECONDS_IN_A_MONTH',2592000); define('SECONDS_IN_A_YEAR',31536000); define('YEAR_DISPLAY_THRESH',7884000); define('KILO_THRESH',768); define('BYTES_DECIMALS',1); define('FILE_READ_BUFFER',64*1024); define('KEYWORDS_MANY_THRESH',50); define('SCALE_FACTOR_THRESH',0.75); define('NEW_FILES_RIGHTS',0777); if (!empty ($_SERVER['HTTPS']) && $_SERVER['HTTPS']!=='off' || $_SERVER['SERVER_PORT']==443){ $_protocol='https'; $g08054=443; } else { $_protocol='http'; $g08054=80; } $va57c1=substr($_SERVER['PHP_SELF'],0,strpos($_SERVER['PHP_SELF'],'/index.php')); list ($z57de2, ) = explode(':',$_SERVER['HTTP_HOST']); if($_SERVER['SERVER_PORT']!=$g08054)$z57de2.=':'. $_SERVER['SERVER_PORT']; $full_blog_url=$_protocol. '://'. $z57de2.$va57c1; $u097cc=$_protocol. '://'. $z57de2.$_SERVER['REQUEST_URI']; $_user_folder_name=str_replace('/','--',$z57de2.$va57c1); if(substr($_user_folder_name,0,4)=='www.'){ $_user_folder_name=substr($_user_folder_name,4); } if(is_file('superconfig.php')) { include 'superconfig.php'; } if(is_file('multiuser')) { define('USER_MODE','multi'); if(array_key_exists($_user_folder_name,$_superconfig['rewrites'])) { $_user_folder_name=$_superconfig['rewrites'][$_user_folder_name]; } } else { define('USER_MODE','single'); } define('ROOT_FOLDER',$_SERVER['DOCUMENT_ROOT'] . (($_SERVER['DOCUMENT_ROOT']!='/')?'/':'')); if(USER_MODE=='multi'){ define('USER_FOLDER','users/'. $_user_folder_name .'/'); } else { define('USER_FOLDER', @$__E2_FOLDER_PREFIX__.'user/'); } define('EXTRAS_FOLDER',USER_FOLDER.'extras/'); define('BACKUP_FOLDER',USER_FOLDER.'backup/'); define('CACHES_FOLDER',USER_FOLDER.'caches/'); define('USER_LIBRARY_FOLDER',USER_FOLDER.'library/'); define('TEMPLATES_FOLDER','themes/'); define('PICTURES_FOLDER','pictures/'); define('AUDIO_FOLDER','audio/'); define('THUMBNAILS_FOLDER','pictures/thumbs/'); define('SCALED_IMAGES_FOLDER','pictures/scaled/'); define('SYSTEM_FOLDER','system/'); define('SCRIPTS_FOLDER','system/js/'); define('SYSTEM_LIBRARY_FOLDER','system/library/'); define('LANGUAGES_FOLDER','system/languages/'); define('DEFAULT_TEMPLATE_FOLDER','system/theme/'); define('DEFAULTS_FOLDER','system/default/'); define('MTMPL_FOLDER','system/default/mail/'); if(substr(@$_SERVER['HTTP_ACCEPT_LANGUAGE'],0,2)=='ru'){ define('DEFAULT_LANGUAGE','ru'); } else { define('DEFAULT_LANGUAGE','en'); } define('NO_REASON',''); define('CACHE',true); define('CACHE_NOTES',CACHE and true); define('CACHE_NOTES_COMMENTS',CACHE and true); define('CACHE_POPULAR',CACHE and true); define('CACHE_HOT',CACHE and true); define('CACHE_FAVS',CACHE and true); define('CACHE_TAGS',CACHE and true); define('CACHE_FAVTAGS',CACHE and true); define('CACHE_NOTES_COUNTS',CACHE and true); define('CACHE_EDGE_TIMEINFO',CACHE and true); define('CACHE_FRONTPAGE',CACHE and true); define('CACHE_FRONTPAGE_RSS',CACHE and true); define('CACHE_FULLLIST',CACHE and true); define('CACHE_DRAFTS',CACHE and true); define('CACHE_DRAFTS_ALIAS_USE_COUNTS',CACHE and true); define('CACHE_FILENAMES_NOTES',CACHES_FOLDER.'note-*.ctree.psa'); define('CACHE_FILENAMES_NOTES_COMMENTS', CACHES_FOLDER.'note-*-comments.ctree.psa' ); define('CACHE_FILENAMES_NOTES_COUNTS',CACHES_FOLDER.'notes-count-*.txt'); define('CACHE_FILENAMES_EDGE_TIMEINFO',CACHES_FOLDER.'*.e2time.psa'); define('CACHE_FILENAME_POPULAR',CACHES_FOLDER.'popular.ctree.psa'); define('CACHE_FILENAME_POPULAR_EXPIRES',CACHES_FOLDER.'popular-expires.txt'); define('CACHE_FILENAME_HOT',CACHES_FOLDER.'hot.ctree.psa'); define('CACHE_FILENAME_HOT_EXPIRES',CACHES_FOLDER.'hot-expires.txt'); define('CACHE_FILENAME_FAVS',CACHES_FOLDER.'favourites.ctree.psa'); define('CACHE_FILENAME_TAGS',CACHES_FOLDER.'tags.psa'); define('CACHE_FILENAME_FAVTAGS',CACHES_FOLDER.'favtags.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE',CACHES_FOLDER.'frontpage.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_AUTHOR',CACHES_FOLDER.'frontpage-author.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_RSS',CACHES_FOLDER.'frontpage-rss.psa'); define('CACHE_FILENAME_FULLLIST',CACHES_FOLDER.'notes-list.ctree.psa'); define('CACHE_FILENAME_DRAFTS',CACHES_FOLDER.'drafts.psa'); define('CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS',CACHES_FOLDER.'drafts-auc.psa'); define('E2E_STRANGE_ERROR',10); define('E2E_USER_ERROR',20); define('E2E_PERMISSIONS_ERROR',30); define('E2E_DATABASE_ERROR',40); define('E2E_MESSAGE',100); define('E2E_DIAGNOSTICS_MESSAGE',110); define('IMPORT_DB_SETTINGS',true); define('DB_PASSWORD_RECOVER_AND_SHOW',false); define('DEFAULT_ITEMS_PER_PAGE',10); define('MAX_ITEMS_PER_PAGE',100); define('MAX_SEARCH_RESULTS',50); define('DB_CANNOT_FIND', -1); define('DB_CANNOT_CONNECT', -2); define('FP_NO_ID_OR_NEW', -1); define('FP_INSERT_ERROR', -10); define('FP_UPDATE_ERROR', -11); define('FP_EMPTY_FIELD', -20); define('FP_TITLE_OR_TEXT_EMPTY', -21); define('FP_NOT_COMMENTABLE', -30); define('FP_COMMENT_DOUBLE_POST', -101); define('FP_COMMENT_TOO_LONG', -102); define('FP_COMMENT_SPAM_SUSPECT', -103); define('NOTE_COMMENTABLE_NOW', -1); define('NOTE_COMMENTABLE_NOW_CONDITIONALLY', -2); define('CSS_CLASS_HIGHLIGHT','e2-marked'); define('THUMB_WIDTH',86); define('THUMB_HEIGHT',64); define('THUMB_JPG_QUALITY',80); define('SCALED_IMAGE_JPG_QUALITY',80); define('USERPIC_WIDTH',128); define('USERPIC_HEIGHT',128); define('USERPIC_JPG_QUALITY',90); @include DEFAULTS_FOLDER. 'config.php'; $_default_config=$_config; @include USER_FOLDER. 'config.php'; $_config=array_merge($_default_config,$_config); if($_config['write_log'])define('__LOG',1); else define('__LOG',0); $h5269f=@$_SERVER['HTTP_USER_AGENT'] or $h5269f=''; $_ios=strstr($h5269f,'iPhone') || strstr($h5269f,'iPad'); $_macintosh=strstr($h5269f,'Macintosh'); error_reporting(E_ALL); $_db_error=false; $_fp_error=false; $n589b3=true; if(strstr(__FILE__,'all.php'))$n589b3=false; function __log($x1cb25,$lc9e9a=0){ global$stopwatch,$_log_depth; if ($x1cb25===null){ if(function_exists('file_put_contents')) { @file_put_contents(USER_FOLDER.'log.txt',''); @chmod(USER_FOLDER.'log.txt',NEW_FILES_RIGHTS); } return; } $a605ac=''; $caf240=str_pad(round(r7f78()-$stopwatch,5),10,' ',STR_PAD_RIGHT); if ($x1cb25[0]=='}'){ -- $_log_depth; if($_log_depth < 0)$_log_depth=0; } $v8e13f=( RUN_ID .' '. $a605ac .''. $caf240 .' '. str_repeat(' ',$_log_depth*2). $x1cb25."\n" ); if ($x1cb25[strlen($x1cb25)-1]=='{'){ ++ $_log_depth; } $a15d61=FILE_APPEND; if(function_exists('file_put_contents')) { @file_put_contents(USER_FOLDER.'log.txt',$v8e13f,$a15d61); @chmod(USER_FOLDER.'log.txt',NEW_FILES_RIGHTS); } } function e2_go_to($y56790=''){ global$_protocol,$errors,$z57de2,$va57c1; @session_start(); $_SESSION['errors']=$errors; if(substr($y56790,0,strlen($_protocol)+3)!=$_protocol .'://'){ header('Location: '. $_protocol .'://'. $z57de2.$va57c1 .'/'. $y56790); } else { header('Location: '. $y56790); } flush(); return true; } function p4930(){ $x469bb=$_SERVER['HTTP_REFERER']; return e2_go_to($x469bb); } function v4924($y56790){ if($_SERVER['HTTP_REFERER'])$y56790=$_SERVER['HTTP_REFERER']; return e2_go_to($y56790); } function m8c3b($qb2145=''){ $l9dd4e=substr_count($_SERVER['HTTP_HOST'],'.'); $t2cb9d=@str_repeat('_',$l9dd4e).$qb2145; return $t2cb9d; } function jc64a($qb2145,$e2063c='',$yb0b70=true){ $acd91e=$yb0b70? (time()+3600*24*365) : (0); $ead5f8=$_SERVER['HTTP_HOST']; $be9c6c=substr_count($ead5f8,'.'); if ($be9c6c < 3)$ead5f8=str_repeat('.',3-$be9c6c).$ead5f8; $l9dd4e=setcookie(m8c3b($qb2145),$e2063c,$acd91e,'/'); } function r163d($l183d6,$nb45cf,$pcadc8=''){ if(trim($nb45cf)!=''){ $nb45cf=explode($l183d6,$nb45cf); foreach ($nb45cf as $g865c0 => $a8ce4b)$nb45cf[$g865c0]=trim($a8ce4b); foreach ($nb45cf as $g865c0 => $a8ce4b) if ($a8ce4b=='') unset ($nb45cf[$g865c0]); $x7b774=array_unique($nb45cf); if ('sort'==$pcadc8)sort($x7b774); return $x7b774; } else return array (); } function gbb8d($nb45cf){ global$_macintosh,$_ios; if($_ios) return ''; if ($nb45cf=='submit'){ if($_macintosh){ return '&#x2303; &#x21a9;'; } else { return 'Ctrl + Enter'; } } if ($nb45cf=='livesave'){ if($_macintosh){ return '&#x2318; S'; } else { return 'Ctrl + S'; } } if ($nb45cf=='navigation'){ if($_macintosh){ return '&#x2325;'; } else { return 'Ctrl'; } } if ($nb45cf=='navigation-later'){ if($_macintosh){ return '&#x2325; &uarr;'; } else { return 'Ctrl + &uarr;'; } } if ($nb45cf=='navigation-earlier'){ if($_macintosh){ return '&#x2325; &darr;'; } else { return 'Ctrl + &darr;'; } } } function a01d3($nb45cf){ $j2db95=strlen($nb45cf); return (strspn($nb45cf,'abcdefghijklmnopqrstuvwxyz-1234567890')==$j2db95 and $j2db95 > 0); } function x7b91($x1cb25){ $x1cb25=str_replace('<','&lt;',$x1cb25); $x1cb25=str_replace('>','&gt;',$x1cb25); return $x1cb25; } function wc4b6($x1cb25){ $x1cb25=str_replace('"','&quot;',$x1cb25); return $x1cb25; } function zd056($e2063c,$w5d6db){ return str_replace('.',',',round($e2063c,$w5d6db)); } function e2_stripslashes_array($of1f71){ return is_array($of1f71)?array_map('e2_stripslashes_array',$of1f71):stripslashes($of1f71); } function v269a(){ if(get_magic_quotes_runtime()) { set_magic_quotes_runtime(0); } if(get_magic_quotes_gpc()) { $_GET=e2_stripslashes_array($_GET); $_POST=e2_stripslashes_array($_POST); $_COOKIE=e2_stripslashes_array($_COOKIE); $_REQUEST=e2_stripslashes_array($_REQUEST); } } function c0786($p957b5){ return sprintf('%u',ip2long($p957b5)); } function y7c85($rb1bc2){ return long2ip(sprintf('%d',$rb1bc2)); } function e2_decline_for_number($x1cb25,$rb1bc2=null){ $o2f713=$x1cb25; if ($rb1bc2===null){ $rb1bc2=substr($x1cb25,0,strpos($x1cb25,' ')); $o2f713=substr($x1cb25,strpos($x1cb25,' ')+1); } $kf07c9=strpos($o2f713,'('); $z46901=strpos($o2f713,')'); if ($z46901 > $kf07c9)$b22b9f=substr($o2f713,$kf07c9,$z46901-$kf07c9+1); $h93da6=explode(',',trim(@$b22b9f,'()')); if(count($h93da6)==2)array_unshift($h93da6,''); $kc78bd=array (2,0,1,1,1,2,2,2,2,2); if ($rb1bc2%100 > 10 and $rb1bc2%100 < 20)$ccd14c=2; else $ccd14c=$kc78bd[$rb1bc2%10]; $jef3e3=$h93da6[$ccd14c]; $x1cb25=str_replace($b22b9f,$jef3e3,$x1cb25); if(strstr($x1cb25,'(') and strstr($x1cb25,')')) { return e2_decline_for_number($x1cb25,$rb1bc2); } else { return $x1cb25; } } function xc5a6($gf2ce1){ $c87e9e=glob($gf2ce1,GLOB_NOSORT); if(is_array($c87e9e)) { foreach ($c87e9e as $i435ed){ @unlink($i435ed); } } } function f74dc($d73600){ $c87e9e=glob($d73600 .'*',GLOB_NOSORT); if(is_array($c87e9e)) { foreach ($c87e9e as $i435ed){ if(basename($i435ed)!='.' and basename($i435ed)!='..'){ if(is_dir($i435ed)) { if (f74dc($i435ed .'/')) { if (!rmdir($i435ed)) { return false; } } else { return false; } } else { @unlink($i435ed); } } } return true; } else { return false; } } function xcc38($t572d4){ global $z57de2,$va57c1; if(g)__log('Spawn '. $t572d4 .'...'); $t572d4=str_replace('http://'. $z57de2,'',$t572d4); $t0666f=@fsockopen($_SERVER['HTTP_HOST'],$_SERVER['SERVER_PORT'],$x70106,$y809b1,1); if(__LOG)__log('Spawn fsockopen returns '. $t0666f .', (errno='. $x70106 .', errstr='. $y809b1 .')...'); if ($t0666f){ @socket_set_timeout($t0666f,1); $s8d777 = 'GET '. $t572d4 ." HTTP/1.0\r\n". 'Host: '. $z57de2 ."\r\n". 'User-Agent: '. E2_UA_STRING ."\r\n". fff2e(); $x5e369=@fwrite($t0666f,$s8d777 ."\r\n"); $x5e369=@fclose($t0666f); return true; } else { return false; } } function naf42($cd6fe1){ $cd6fe1=trim($cd6fe1,'/'); $cd6fe1=explode('/',$cd6fe1); $d73600=''; foreach ($cd6fe1 as $t83878){ $d73600=$d73600.$t83878; if (!is_dir($d73600)) { if (@mkdir($d73600)) { @chmod($d73600,NEW_FILES_RIGHTS); } else { return false; } } $d73600=$d73600.'/'; } return true; } function n4d36($cd6fe1){ return preg_replace('/\/([^\/]+?)\/\.\./','',$cd6fe1); } function lce9b($nb45cf){ $jcee6f=get_html_translation_table(HTML_ENTITIES); $jcee6f=array_flip($jcee6f); return strtr($nb45cf,$jcee6f); } function r7f78($q32c11=NULL){ if(NULL==$q32c11)$q32c11=microtime(); list ($j6021b,$q74459)=explode(' ',$q32c11); return ((float)$j6021b + (float)$q74459); } define('HEL_SPECIAL_CHAR',"\x1"); define('HEL_SPECIAL_SEQUENCE_LENGTH',6); function r4e85($q6a992){ return str_pad($q6a992,HEL_SPECIAL_SEQUENCE_LENGTH,'0',STR_PAD_LEFT); } function hel_savetag($ge4d23){ global $z16234; $q6a992=count($z16234); $z16234[$q6a992]=$ge4d23[0]; return HEL_SPECIAL_CHAR.r4e85($q6a992).HEL_SPECIAL_CHAR; } function sdae3($x1cb25){ global $z16234; if ($z16234){ foreach ($z16234 as $q6a992 => $e2063c){ $x1cb25=str_replace(HEL_SPECIAL_CHAR. r4e85($q6a992).HEL_SPECIAL_CHAR,$e2063c,$x1cb25); } } return $x1cb25; } $stopwatch=r7f78($stopwatch); function o3aa5($l9dd4e){ global$_e2utf8__unformat_htmlentity_neasden; if($_e2utf8__unformat_htmlentity_neasden){ return $l9dd4e; } else { return '((html '. $l9dd4e .'))'; } } function dedd9($ne98a6,$v98df3=false){ $p80a41=''; $ff5a8e=strlen($ne98a6); for ($g865c0=0; $g865c0 < 256; ++ $g865c0){ $jf3d13[$g865c0]=0; $a0fc3c=$g865c0; while ($a0fc3c & 0x00000080){ $a0fc3c <<= 1; ++ $jf3d13[$g865c0]; } } for ($g865c0=0xd090; $g865c0 <= 0xd0bf; $g865c0++)$e84a26[$g865c0]=chr(($g865c0 & 0x000000ff)+48); for ($g865c0=0xd180; $g865c0 <= 0xd18f; $g865c0++)$e84a26[$g865c0]=chr(($g865c0 & 0x000000ff)+112); $e84a26[0xd081]="\xa8"; $e84a26[0xd191]="\xb8"; $e84a26[0xc299]="\x99"; $e84a26[0xc2a9]="\xa9"; $e84a26[0xc2ae]="\xae"; $e84a26[0xc2ab]="\xab"; $e84a26[0xc2bb]="\xbb"; $e84a26[0xc2a0]="\xa0"; $g865c0=0; while ($g865c0 < $ff5a8e){ $kac558=$ne98a6{$g865c0}; $hc267c=ord($kac558); if ($jf3d13[$hc267c]==0){ $p80a41.=$kac558; ++ $g865c0; } elseif ($jf3d13[$hc267c]==2){ $p06214=$e84a26[($hc267c << 8) | ord($ne98a6{$g865c0+1})]; $p80a41 .= ($p06214!=null)? $p06214 : ( $v98df3? (o3aa5( qebe5(substr($ne98a6,$g865c0,2)) )) : '?' ); $g865c0+=2; } else { $ndfbc9=substr($ne98a6,$g865c0,$jf3d13[$hc267c]); if ($ndfbc9=="\xe2\x84\x96")$p80a41.="\xb9"; elseif ($ndfbc9=="\xe2\x80\x93")$p80a41.="\x96"; elseif ($ndfbc9=="\xe2\x80\x94")$p80a41.="\x97"; elseif ($ndfbc9=="\xe2\x80\x98")$p80a41.="\x91"; elseif ($ndfbc9=="\xe2\x80\x99")$p80a41.="\x92"; elseif ($ndfbc9=="\xe2\x80\x9a")$p80a41.="\x82"; elseif ($ndfbc9=="\xe2\x80\x9c")$p80a41.="\x93"; elseif ($ndfbc9=="\xe2\x80\x9d")$p80a41.="\x94"; elseif ($ndfbc9=="\xe2\x80\x9e")$p80a41.="\x84"; elseif ($ndfbc9=="\xe2\x80\xa6")$p80a41.="\x85"; elseif ($ndfbc9=="\xe2\x80\xb9")$p80a41.="\x8b"; elseif ($ndfbc9=="\xe2\x80\xba")$p80a41.="\x9b"; elseif ($ndfbc9=="\xe2\x82\xac")$p80a41.="\x88"; elseif ($ndfbc9=="\xe2\x84\xa2")$p80a41.="\x99"; else $p80a41.=$v98df3? (o3aa5( qebe5($ndfbc9) )) : '?'; $g865c0+=$jf3d13[$hc267c]; } } return $p80a41; } function qebe5($q4a8a0){ $vcc411=''; $ff5a8e=strlen($q4a8a0); for ($g865c0=0; $g865c0 < $ff5a8e; ++ $g865c0){ $vcc411.=preg_replace('/^1*0/','',decbin(ord($q4a8a0{$g865c0}))); } return '&#'. bindec($vcc411) .';'; } function efd97($q341be) { $t2cb9d=$q341be; $t2cb9d=preg_replace_callback('/([\x80-\xFF])/','e2_utf_from_windows_1251_char',$t2cb9d); return $t2cb9d; } function e2_utf_from_windows_1251_char($q4a8a0){ list (, $q4a8a0)=$q4a8a0; if ($q4a8a0=="\xa8") return "\xd0\x81"; if ($q4a8a0=="\xb8") return "\xd1\x91"; if ($q4a8a0 >= "\xc0" && $q4a8a0 <= "\xef") return "\xd0".chr(ord($q4a8a0)-48); if ($q4a8a0 >= "\xf0") return "\xd1".chr(ord($q4a8a0)-112); if ($q4a8a0=="\x85") return "\xe2\x80\xa6"; if ($q4a8a0=="\x96") return "\xe2\x80\x93"; if ($q4a8a0=="\x97") return "\xe2\x80\x94"; if ($q4a8a0=="\xab") return "\xc2\xab"; if ($q4a8a0=="\xbb") return "\xc2\xbb"; if ($q4a8a0=="\x91") return "\xe2\x80\x98"; if ($q4a8a0=="\x92") return "\xe2\x80\x99"; if ($q4a8a0=="\x93") return "\xe2\x80\x9c"; if ($q4a8a0=="\x94") return "\xe2\x80\x9d"; if ($q4a8a0=="\x84") return "\xe2\x80\x9e"; if ($q4a8a0=="\x99") return "\xe2\x84\xa2"; if ($q4a8a0=="\xb9") return "\xe2\x84\x96"; if ($q4a8a0=="\xa0") return "\xc2\xa0"; return '?'; }; function e2_utf8_version_of_array_($of1f71){ foreach ($of1f71 as $a8ce4b => $z9e366){ if (!array_key_exists($a8ce4b.'.u?',$of1f71)) { if(is_string($of1f71[$a8ce4b])) { $of1f71[$a8ce4b]=efd97($of1f71[$a8ce4b]); } elseif(is_array($of1f71[$a8ce4b])) { $of1f71[$a8ce4b]=e2_utf8_version_of_array_($of1f71[$a8ce4b]); } } } return $of1f71; } $_folders_written=array ( '.', USER_FOLDER, CACHES_FOLDER, BACKUP_FOLDER, PICTURES_FOLDER, THUMBNAILS_FOLDER, SCALED_IMAGES_FOLDER, AUDIO_FOLDER, ); $_files_written=array ( USER_FOLDER.'password-hash.psa', USER_FOLDER.'settings.psa', USER_FOLDER.'auth.psa', USER_FOLDER.'log.txt', ); function kea70(){ global$_folders_written,$_files_written; clearstatcache(); $j10ae9=array(); foreach($_folders_written as $t8fa14){ if(is_dir($t8fa14) and !is_writable($t8fa14)) { $j10ae9[] = $t8fa14; } } foreach($_files_written as $t8fa14){ if(is_file($t8fa14) and !is_writable($t8fa14)) { $j10ae9[] = $t8fa14; } } return $j10ae9; } function tcdf0($w8c7dd){ if(function_exists('file_get_contents')) { return @file_get_contents($w8c7dd); } else { $t8fa14=fopen($w8c7dd,"rb"); clearstatcache(); $he358e=fread($t8fa14,filesize($w8c7dd)); fclose($t8fa14); return $he358e; } } function v6e52($w8c7dd,$nb45cf){ if(function_exists('file_put_contents')) { if (!file_put_contents($w8c7dd,$nb45cf,LOCK_EX)) { return false; } } else { if ($t0666f=@fopen($w8c7dd,'a+b')) { flock($t0666f,LOCK_EX); ftruncate($t0666f,0); fseek($t0666f,0); fwrite($t0666f,$nb45cf); fclose($t0666f); } else { return false; } } @chmod($w8c7dd,NEW_FILES_RIGHTS); return true; } function acd2d($w8c7dd,$nb45cf){ if(function_exists('file_put_contents')) { $t2cb9d=@file_put_contents($w8c7dd,$nb45cf); @chmod($w8c7dd,NEW_FILES_RIGHTS); return $t2cb9d; } else { $t8fa14=@fopen($w8c7dd,'ab'); if ($t8fa14){ if (@flock($t8fa14,LOCK_EX)) { $lb92d9=ignore_user_abort(1); @ftruncate($t8fa14,0); @fseek($t8fa14,0); fwrite($t8fa14,$nb45cf); fflush($t8fa14); @flock($t8fa14,LOCK_UN); fclose($t8fa14); @chmod($w8c7dd,NEW_FILES_RIGHTS); ignore_user_abort($lb92d9); return true; } else { fclose($t8fa14); return false; } } else { return false; } } } function if5a9(){ global$settings,$_template; if(__LOG)__log('Files: Prepage to scale images for template <'. $_template['name'] .' : '. $_template['max_image_width'] .'>'); if($settings['max-image-width']!=$_template['max_image_width']) { if(__LOG)__log('Files: max_image_width changed to '. $_template['max_image_width']); $settings['max-image-width']=$_template['max_image_width']; if(__LOG)__log('Files: Cleaning cached notes'); t7996(); if(__LOG)__log('Files: Cleaning pre-scaled images'); xc5a6(SCALED_IMAGES_FOLDER.'*'); if(__LOG)__log('Files: Saving updated settings for max-image-width'); if (!@v6e52(USER_FOLDER.'settings.psa',serialize($settings))) { f8a40('',E2E_PERMISSIONS_ERROR); } } if(__LOG)__log('Files: Done preparing to scale images'); } function q25cb($i435ed,$u3dbb8){ if ($u3dbb8){ $k80127=explode('/',$i435ed); $f954eb=array_pop($k80127); $d35b88=explode('.',$f954eb); if(count($d35b88) < 2)$d35b88[] = ''; $aabf77=array_pop($d35b88); $d35b88[] = $u3dbb8; if ($aabf77)$d35b88[] = $aabf77; $f954eb=implode('.',$d35b88); $k80127[] = $f954eb; $i435ed=implode('/',$k80127); } return $i435ed; } function m291d($paf721){ $ud1789=array ( 'w' => THUMB_WIDTH, 'h' => THUMB_HEIGHT, 'q' => THUMB_JPG_QUALITY ); return s8611( PICTURES_FOLDER.$paf721, THUMBNAILS_FOLDER.q25cb($paf721,'thumb'), $ud1789 ); } function s8611($paf721,$r6efa1,$v93a57){ global$_config; if(__LOG)__log('Scale image: <'. $paf721 .'>'); $u8743c=pathinfo($paf721); $aabf77=$u8743c['extension']; $e7ae08=pathinfo($r6efa1); if(in_array(strtolower($aabf77), array ('jpg','jpeg','gif','png'))) { if(__LOG)__log('Scale image: source_name <'. $paf721 .'>'); if(__LOG)__log('Scale image: dest_name <'. $r6efa1 .'>'); if ($v93a57['h'] == -1)$v93a57['h']=999999; if (!is_file($r6efa1)) { if (@naf42($e7ae08['dirname'])) { s6b7f( $paf721, $v93a57['w'],$v93a57['h'],$v93a57['q'], $r6efa1 ); if(is_file($r6efa1)) { if(__LOG)__log('Scale image: done'); chmod($r6efa1,$_config['uploaded_files_mode']); } else { if(__LOG)__log('Scale image: error (no php_gd?)'); return false; } } } return $r6efa1; } return false; } function h9c0a($zb0689){ if(preg_match('//u',$zb0689))$zb0689=dedd9($zb0689,false); $j96704=''; for ($g865c0=0; $g865c0 < strlen($zb0689); $g865c0++) { if ($zb0689[$g865c0]=='?'){ $j96704.=''; } elseif ($zb0689[$g865c0]==' '){ $j96704.='-'; } elseif(ord($zb0689[$g865c0]) <= 127){ $j96704.=$zb0689[$g865c0]; } } if ($j96704=='')$j96704='picture'; if ($j96704[0]=='.')$j96704='picture'. $j96704; if(is_file(PICTURES_FOLDER.$j96704)) { $p5c917=substr($j96704,0,strrpos($j96704,'.')); $aabf77=substr($j96704,strrpos($j96704,'.')); $g865c0=0; while (is_file(PICTURES_FOLDER.$p5c917.'_'.(++$g865c0).$aabf77)); $j96704=$p5c917 .'_'. $g865c0.$aabf77; } return $j96704; } function e2j_file_upload(){ global$_config; @naf42(PICTURES_FOLDER); @chmod(PICTURES_FOLDER,$_config['uploaded_files_mode']); @naf42(AUDIO_FOLDER); @chmod(AUDIO_FOLDER,$_config['uploaded_files_mode']); if(count($_FILES) > 0){ foreach($_FILES as $w8c7dd){ if (!$w8c7dd['error']) { if(__LOG)__log('Ajax file upload: <'. $w8c7dd['name'].'>'); $j96704=h9c0a($w8c7dd['name']); if(__LOG)__log('Ajax file upload: Safe name is <'. $j96704.'>'); $k9f57c=PICTURES_FOLDER.$j96704; $r12e09='image'; if(substr($w8c7dd['name'],strrpos($w8c7dd['name'],'.')) == '.mp3'){ $k9f57c=AUDIO_FOLDER.$j96704; $r12e09='audio'; } move_uploaded_file($w8c7dd['tmp_name'],$k9f57c); @chmod($k9f57c,$_config['uploaded_files_mode']); if ($r12e09=='image'){ if ($jf1210=m291d($j96704)) { if(__LOG)__log('Ajax file upload: thumbnail, done'); die ('image|'. $j96704 .'|'. $jf1210); } else { @unlink($k9f57c); die ('error|could-not-create-thumbnail'); } } if ($r12e09=='audio'){ if(__LOG)__log('Ajax file upload: audio, done'); $jf1210=DEFAULTS_FOLDER.'audio.png'; die ('audio|'. $j96704 .'|'. $jf1210); } } elseif(4!=$w8c7dd['error']) { if ($w8c7dd['error']==1){ die ('error|too-big'); } elseif ($w8c7dd['error']==2){ die ('error|too-big'); } elseif ($w8c7dd['error']==3){ die ('error|partial'); } else { die ('error|'. $w8c7dd['error']); } } } } else { if(__LOG)__log('Ajax file upload error: no files'); die ('error|no-files'); } } function e2j_userpic_upload(){ global$_config; if(count($_FILES)==1){ $w8c7dd=array_pop($_FILES); if (!$w8c7dd['error']) { if(__LOG)__log('Ajax userpic upload: <'. $w8c7dd['name'].'>'); $fa93b8=pathinfo($w8c7dd['name']); $aabf77=strtolower($fa93b8['extension']); if ($aabf77!='png')$aabf77='jpg'; $i435ed='userpic.original.'. $aabf77; move_uploaded_file($w8c7dd['tmp_name'],USER_FOLDER.$i435ed); @chmod(USER_FOLDER.$i435ed,$_config['uploaded_files_mode']); $ud1789=array ( 'w' => USERPIC_WIDTH, 'h' => USERPIC_HEIGHT, 'q' => USERPIC_JPG_QUALITY ); @unlink(USER_FOLDER.'userpic.png'); @unlink(USER_FOLDER.'userpic.jpg'); $jf1210=s8611( USER_FOLDER.$i435ed, USER_FOLDER .'userpic.jpg', $ud1789 ); @unlink(USER_FOLDER.$i435ed); if ($jf1210){ if(__LOG)__log('Ajax userpic upload: userpic, done'); die ('image|'. $jf1210); } else { die ('image|system/default/userpic.png'); } } elseif(4!=$w8c7dd['error']) { if ($w8c7dd['error']==1){ die ('error|too-big'); } elseif ($w8c7dd['error']==2){ die ('error|too-big'); } elseif ($w8c7dd['error']==3){ die ('error|partial'); } else { die ('error|'. $w8c7dd['error']); } } } else { if(__LOG)__log('Ajax userpic upload error: no or too many files'); die ('error|no-or-too-many-files'); } die ('error|uncatched-error'); } function e2s_scale_image($parameters){ global$settings; $i435ed=$parameters['picture']; list ($x137ae,) = getimagesize(PICTURES_FOLDER.$i435ed); $ice62f=$settings['max-image-width']/$x137ae; if ($ice62f < SCALE_FACTOR_THRESH){ $ud1789=array ( 'w' => $settings['max-image-width'], 'h' => -1, 'q' => SCALED_IMAGE_JPG_QUALITY ); if ($a72f31=s8611( PICTURES_FOLDER.$i435ed, SCALED_IMAGES_FOLDER.q25cb($i435ed,'scaled'), $ud1789 )) { e2_go_to($a72f31); die; } } e2_go_to(PICTURES_FOLDER.$i435ed); die; } function e2j_file_remove(){ $w8c7dd=$jf1210=''; if(array_key_exists('file',$_POST))$w8c7dd=$_POST['file']; if(array_key_exists('thumb',$_POST))$jf1210=$_POST['thumb']; if(substr($w8c7dd,strrpos($w8c7dd,'.')) == '.mp3'){ @unlink(AUDIO_FOLDER.$w8c7dd); die ('nothing'); } else { $jf1210=q25cb($w8c7dd,'thumb'); $nd911a=q25cb($w8c7dd,'scaled'); if ($w8c7dd){ $hf6347=@unlink(PICTURES_FOLDER.$w8c7dd); $z8f458=@unlink(THUMBNAILS_FOLDER.$jf1210); $xe57e0=@unlink(SCALED_IMAGES_FOLDER.$nd911a); die ('nothing'); } } die ('error|no-filename-passed'); } function s6b7f($afce75,$wc69cd,$fd35fb,$md6663,$q1c925=''){ if (!extension_loaded('gd')) { if (!dl('gd.so')) { header('Content-type: image/gif'); return false; } } $pcaf9b=@getimagesize($afce75); if (!$pcaf9b or $pcaf9b[2] > 3) return; $s599dc=$pcaf9b[2]; if ($s599dc==1 and function_exists('imagecreatefromgif')) { list ($u73beb,$s599dc) = array (imagecreatefromgif($afce75),'gif'); } if ($s599dc==2 and function_exists('imagecreatefromjpeg')) { list ($u73beb,$s599dc) = array (imagecreatefromjpeg($afce75),'jpeg'); } if ($s599dc==3 and function_exists('imagecreatefrompng')) { list ($u73beb,$s599dc) = array (imagecreatefrompng($afce75),'png'); } if (!$u73beb) return false; $qeaae2=imagesx($u73beb); $hb435e=imagesy($u73beb); $o0cb47=min($wc69cd/$qeaae2,$fd35fb/$hb435e); if ($o0cb47 < 1){ $wc69cd=round($qeaae2*$o0cb47); $fd35fb=round($hb435e*$o0cb47); } else { $wc69cd=$qeaae2; $fd35fb=$hb435e; } $h28e3d=imagecreatetruecolor($wc69cd,$fd35fb); imageinterlace($h28e3d,1); if (empty ($q1c925)) { $d19229=stat($afce75); $d19229=date('r',$d19229['mtime']); header('Last-Modified: '.$d19229); } imagecopyresampled($h28e3d,$u73beb,0,0,0,0,$wc69cd,$fd35fb,$qeaae2,$hb435e); imagejpeg($h28e3d,$q1c925,$md6663); return true; } function s74e0(){ global$settings; if (!isset ($settings))$settings=array(); if(is_file(USER_FOLDER.'settings.psa')) { $ifa816=unserialize(tcdf0(USER_FOLDER.'settings.psa')); if (!is_array($ifa816))$ifa816=array(); $settings=array_merge($settings,$ifa816); } if ( !is_numeric(@$settings['appearance']['notes_per_page']) or @$settings['appearance']['notes_per_page'] < 1 ){ $settings['appearance']['notes_per_page']=DEFAULT_ITEMS_PER_PAGE; } if ( @$settings['appearance']['notes_per_page'] > MAX_ITEMS_PER_PAGE ){ $settings['appearance']['notes_per_page']=MAX_ITEMS_PER_PAGE; } if ( !array_key_exists('comments',$settings) or !array_key_exists('on', @$settings['comments']) ) { $settings['comments']['on']=true; } return true; } function e2m_name_and_author(){ global$settings,$_template,$_strings; $t2cb9d['title']=$_strings['pt--name-and-author']; $t2cb9d['heading']=$_strings['pt--name-and-author']; $t2cb9d['form']='form-name-and-author'; $t2cb9d['form-name-and-author'] = array ( 'form-action' => d83c8('e2s_name_and_author'), 'blog-title-default' => htmlspecialchars($_strings['e2--default-blog-title'],ENT_COMPAT,HSC_ENC), 'blog-title' => htmlspecialchars(r6f51(),ENT_COMPAT,HSC_ENC), 'blog-description' => htmlspecialchars(@$settings['description'],ENT_COMPAT,HSC_ENC), 'blog-author-default' => htmlspecialchars($_strings['e2--default-blog-author'],ENT_COMPAT,HSC_ENC), 'blog-author' => htmlspecialchars(@$settings['author'],ENT_COMPAT,HSC_ENC), 'submit-text' => $_strings['fb--save-changes'], ); return $t2cb9d; } function e2s_name_and_author(){ global$settings,$_strings; $m05df2=$t67daf=''; if(array_key_exists('blog-title',$_POST)) { $m05df2=trim($_POST['blog-title']); } if(array_key_exists('blog-description',$_POST)) { $t67daf=trim($_POST['blog-description']); } if(array_key_exists('blog-author',$_POST)) { $s02bd9=trim($_POST['blog-author']); } $settings['site_title']=$m05df2; $settings['site_title']=r6f51(); $settings['description']=$t67daf; $settings['author']=$s02bd9; xc5a6(CACHE_FILENAMES_NOTES_COMMENTS); if (!@v6e52(USER_FOLDER.'settings.psa',serialize($settings))) { f8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(d83c8('e2m_name_and_author')); die; } e2_go_to(d83c8('e2m_frontpage')); die; } function e2m_settings(){ global$settings,$_template,$_strings; $wf3e33=array(); $t5e107=@$settings['language']? $settings['language']:DEFAULT_LANGUAGE; foreach(glob(LANGUAGES_FOLDER. '*.php') as $i435ed){ $c5b54c=substr(basename($i435ed),0,2); $m98bf7=file_get_contents($i435ed); if(preg_match( '/^ *\/\/ *display_name *\= *(.*?) *$/ismu',$m98bf7,$e9c28d )) { $tc2657=$e9c28d[1]; } else { $tc2657=$c5b54c; } $wf3e33[$c5b54c] = array ( 'selected?' => (bool) ($t5e107==$c5b54c), 'display-name' => $tc2657, ); } $t2cb9d['title']=$_strings['pt--settings']; $t2cb9d['heading']=$_strings['pt--settings']; $t2cb9d['form']='form-preferences'; $t2cb9d['form-preferences'] = array ( 'languages' => $wf3e33, 'language' => $t5e107, 'form-action' => d83c8('e2s_settings_save'), 'notes-per-page' => $settings['appearance']['notes_per_page'], 'email-notify?' => (bool) @$settings['notifications']['new_comments'], 'email' => htmlspecialchars(@$settings['user']['email'],ENT_NOQUOTES,HSC_ENC), 'comments-on?' => (bool) @$settings['comments']['on'], 'comments-fresh-only?' => (bool) @$settings['comments']['fresh_only'], 'hot-block?' => (bool) (@$settings['appearance']['hot_frontpage']), 'show-sharing-buttons?' => (bool)$settings['appearance']['show_sharing_buttons'], 'template-name' => $_template['name'], 'templates' => f94dd(), 'submit-text' => $_strings['fb--save-changes'], ); return $t2cb9d; } function e2s_settings_save(){ global$settings,$_strings; $m05df2=$t67daf=''; if(array_key_exists('language',$_POST)) $r8512a=$_POST['language']; if(array_key_exists('email',$_POST)) $c0c83f=trim($_POST['email']); if(array_key_exists('template',$_POST)) $b66f61=trim($_POST['template']); $s0c2bd=(int)$_POST['notes-per-page']; $settings['user']['email']=$c0c83f; $settings['notifications']['new_comments'] = isset ($_POST['email-notify']); $settings['appearance']['hot_frontpage'] = isset ($_POST['hot-block']); $settings['template']=$b66f61; if ( $settings['language']!=$r8512a or $settings['appearance']['notes_per_page']!=$s0c2bd or $settings['appearance']['show_sharing_buttons'] != isset ($_POST['show-sharing-buttons']) or $settings['comments']['on'] != isset ($_POST['comments-on']) or $settings['comments']['fresh_only'] != isset ($_POST['comments-fresh-only']) ) { @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); $settings['language']=$r8512a; $settings['appearance']['notes_per_page']=$s0c2bd; $settings['appearance']['show_sharing_buttons'] = isset ($_POST['show-sharing-buttons']); $settings['comments']['on'] = isset ($_POST['comments-on']); $settings['comments']['fresh_only'] = isset ($_POST['comments-fresh-only']); } if (!@v6e52(USER_FOLDER.'settings.psa',serialize($settings))) { f8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(d83c8('e2m_settings')); die; } e2_go_to(d83c8('e2m_frontpage')); die; } function e2m_database(){ global$settings,$_strings,$_superconfig; if (@$_superconfig['disallow_db_config']) { die ('DB Configuration not allowed'); } $t2cb9d['title']=$_strings['pt--database']; $t2cb9d['heading']=$_strings['pt--database']; $t2cb9d['form']='form-database'; $t2cb9d['form-database'] = array ( 'form-action' => d83c8('e2s_database_save'), 'db-server' => htmlspecialchars(@$settings['db']['server']? $settings['db']['server']:'localhost'), 'db-user' => htmlspecialchars(@$settings['db']['user_name']? $settings['db']['user_name']:'root'), 'db-password' => htmlspecialchars(ree85(@$settings['db']['passw'])), 'db-database' => htmlspecialchars(@$settings['db']['name']), 'db-prefix' => htmlspecialchars(@$settings['db']['table_prefix']? $settings['db']['table_prefix']:'e2Blog'), 'submit-text' => $_strings['fb--connect-to-this-db'], ); return $t2cb9d; } function e2s_database_save(){ global$settings,$_superconfig,$_strings; if (@$_superconfig['disallow_db_config']) { die ('DB Configuration not allowed'); } if(array_key_exists('db-server',$_POST)) { $settings['db']['server'] = @$_POST['db-server']; $settings['db']['user_name'] = @$_POST['db-user']; $settings['db']['passw']=m1305(@$_POST['db-password']); $settings['db']['name'] = @$_POST['db-database']; $settings['db']['table_prefix'] = @$_POST['db-prefix']; if (!@v6e52(USER_FOLDER.'settings.psa',serialize($settings))) { f8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(d83c8('e2m_database')); die; } e2_drop_all_kinds_of_cache(); } e2_go_to(d83c8('e2m_settings')); die; } s74e0(); function f8a40($t67daf,$s599dc=E2E_STRANGE_ERROR){ global$errors,$settings, $_config, $_strings, $_diagnose; $q1897a=(!oe852()+1 <= (int)$_config['show_call_stack']); if ($t67daf){ if ($t67daf[0]!='<')$t67daf='<p>'.$t67daf .'</p>'; $jcd1dd=array ( 'description' => $t67daf, 'type' => $s599dc, ); if ( $s599dc==E2E_STRANGE_ERROR and $q1897a and function_exists('debug_backtrace') ) { $jcd1dd['backtrace']=debug_backtrace(); } $errors[] = $jcd1dd; } if ($s599dc==E2E_PERMISSIONS_ERROR){ $_diagnose['need?']=true; jc64a('diagnose','1'); } if ($s599dc==E2E_DATABASE_ERROR){ } return true; } function p8739(){ global$errors,$s1c0b7,$_strings,$_diagnose; $n7287a=kea70(); if(count($n7287a)==0){ jc64a('diagnose',''); unset($_COOKIE['diagnose']); $_diagnose['need?']=false; $_diagnose['ok?']=true; return true; } else { $j6e2ba=''; $j6e2ba.='<p>'. $_strings['gs--enable-write-permissions-for-the-following'] .'</p>'; $j6e2ba.='<ul>'; foreach ($n7287a as $t8fa14){ if ($t8fa14=='.')$t8fa14=''; if ($s1c0b7){ $j6e2ba.='<li><tt>'. ROOT_FOLDER.$t8fa14 .'</tt></li>'; } else { $j6e2ba.='<li><tt>/'. $t8fa14 .'</tt></li>'; } if(__LOG)__log('Diagnostics: cannot write <'. $t8fa14 .'>'); } $j6e2ba.='</ul>'; $jcd1dd=array ( 'title' => $_strings['et--fix-permissions-on-server'], 'description' => $j6e2ba, 'type' => E2E_DIAGNOSTICS_MESSAGE, 'class' => 'serious', ); $errors[] = $jcd1dd; $_diagnose['ok?']=false; return false; } } function re1c4($tc1336,$t67daf){ global$errors; if(0==error_reporting() or ($tc1336 & 8)) return; f8a40('PHP ('.$tc1336.'): '.$t67daf); $errors[count($errors)-1]['phpcode']=$tc1336; } function bec07(){ global$errors,$settings,$_config; @session_start(); if(is_array(@$_SESSION['errors'])) { $je1671=array_merge(@$_SESSION['errors'],$errors); } else { $je1671=$errors; } $q1897a=(!oe852()+1 <= (int)$_config['show_call_stack']); if (@$_config['store_backtrace'] and $q1897a and $je1671!=NULL){ @v6e52('backtrace.psa',serialize($je1671)); } else { @unlink('backtrace.psa'); } if (isset ($_SESSION['errors'])) unset($_SESSION['errors']); $t2cb9d=array(); $ob8735=false; if(count($je1671) > 0){ foreach ($je1671 as $g865c0 => $y08a44){ if ($y08a44['type']==E2E_STRANGE_ERROR){ $y08a44['class']='serious'; $ob8735=true; if ($q1897a){ $y08a44['backtrace']=r2616($y08a44['backtrace']); } } if ($y08a44['type']==E2E_MESSAGE){ $y08a44['class']='info'; } $je1671[$g865c0]=$y08a44; } $t2cb9d['each']=$je1671; if ( $ob8735 and @$_config['store_backtrace'] and $q1897a and is_file('debug.php') ) { $t2cb9d['debug-link']='debug.php'; } } return $t2cb9d; } function r2616($z69206){ global $va57c1; $z69206=array_reverse($z69206); $z69206=array_splice($z69206,0,count($z69206)-1); $je1671='<p style="background: #fea; padding: .25em .5em; line-height: 1em; overflow: hidden">'; foreach ($z69206 as $g865c0 => $he358e){ $w195df=@$he358e['args'] or $w195df=array(); $na956a=array(); foreach ($w195df as $g5919c){ $na956a[] = var_export($g5919c,true); } $w8c7dd=@$he358e['file']; $w8c7dd=str_replace($_SERVER['DOCUMENT_ROOT'],'',$w8c7dd); $z6438c=(@$he358e['line']? (' #'. $he358e['line']) : '?'); $je1671.='<div style="margin: .25em 0 .5em '. $g865c0*3 .'em">'; $je1671.='<span style="float: right; color: #666"> '. $w8c7dd.$z6438c .'</span>'; $je1671.='<tt><b>'. @$he358e['function'] .' (</b>'; if(count($na956a)) { $veb84a=str_replace("array (\n)",'array ()',$na956a); $veb84a=implode(', ',$veb84a); if(0){ $veb84a=highlight_string('<?'. $veb84a .'?'.'>',true); $veb84a=substr($veb84a,77, -28); } $veb84a=str_replace('&nbsp;',' ',$veb84a); $veb84a=nl2br($veb84a); $je1671.='<div style="margin: 0 0 0 1.12em">'. $veb84a .'</div>'; } $je1671.='<b>)</b> &rarr;</tt></div>'; } $je1671.='</p>'; return $je1671; } set_error_handler('re1c4'); function e2_error404_mode(){ global$_strings; header('HTTP/1.1 404 Not found'); $te70c4['heading']=$_strings['pt--page-not-found']; $te70c4['title']=$_strings['pt--page-not-found']; return $te70c4; } include_once 'neasden/neasden.php'; function q6f10($x1cb25){ $Nn=new Neasden; $Nn->profile_name='kavychki'; return$Nn->format($x1cb25); } function y8447($qf2ffc,$x1cb25,$m5c18e){ if ($qf2ffc=='calliope'){ preg_match_all('/\(\(([^ ]*)( |\)\))/',$x1cb25,$e9c28d); return $e9c28d[1]; } elseif ($qf2ffc=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$m5c18e; $Nn->format($x1cb25); return$Nn->resources_detected; } else { return array (); } } function x154e($qf2ffc,$x1cb25,$m5c18e){ if(__LOG)__log('Format: format with formatter "'. $qf2ffc .'" in context "'. $m5c18e.'"'); if ($qf2ffc=='calliope'){ $x1cb25=dedd9($x1cb25); $x1cb25=m5599($x1cb25,$m5c18e); $meta=array(); $x1cb25=efd97($x1cb25); $x1cb25='<div class="e2-text-calliope-formatted">'. q6f10($x1cb25) .'</div>'; } elseif ($qf2ffc=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$m5c18e; $x1cb25=$Nn->format($x1cb25); $meta=array ( 'links-required' => $Nn->links_required, 'resources-detected' => $Nn->resources_detected ); } return array ( 'text-final' => $x1cb25, 'meta' => $meta, ); } function nb7f1($x1cb25,$m5c18e){ global$_config; return x154e($_config['default_formatter'],$x1cb25,$m5c18e); } function m5599($x1cb25,$m5c18e){ global$_config,$settings,$full_blog_url; @ (list ($m5c18e,$qe8fab)=explode('|',$m5c18e)); require_once 'calliope/WikiFormatter.php'; if ('full'==$m5c18e)$cad910=WF_FULL_MODE; elseif ('simple'==$m5c18e)$cad910=WF_SIMPLE_MODE; else return $x1cb25; $r0a1d3=new WikiFormatter(); $r0a1d3 -> replace=array ( '/' => 'i', '+' => 'small', '-' => 's', '*' => 'b', '^' => 'sup', 'v' => 'sub', '#' => 'tt', '!' => 'blockquote', ); $r0a1d3 -> settings=array ( 'hrefSize' => 100, 'localImgDir' => $full_blog_url .'/'. PICTURES_FOLDER, 'localImgDirScaled' => $full_blog_url .'/'. SCALED_IMAGES_FOLDER, 'localImgScalingProvider' => '?go=@scale-image:', 'maxImgWidth' => $settings['max-image-width'], 'mode' => $cad910, 'enableShrinkLongHref' => 1, 'enableHr' => 0, 'enableBr' => 1, 'enableHeaders' => 1, 'headersStartWith' => 1, 'enableTables' => 1, 'simpleTableCSSClass' => 'e2-text-table', 'enableAutoAcronymEngine' => 0, 'enableAcronym' => 0, 'acronymBase' => '', 'enableList' => 1, 'mailSafe' => "<a href=\"\" onmouseover=\"this.href='mailto:'+{email}\">{icon}<script language=\"JavaScript\">document.write({name});</script></a>", 'ljUserTag' => '<a href="http://livejournal.com/users/{name}/">{name}</a>', 'fullVersionURL' => $qe8fab, 'enableTagIcons' => 0, 'outerUrlInNewWindow' => 0, 'lineBreak' => "\n", 'extLinkHrefPrefix' => '', ); $x1cb25=$r0a1d3 -> Wiki2HTML($x1cb25); return $x1cb25; } function e2m_timezone(){ global$_strings,$settings; $jde2fd=array ( 'form-action' => d83c8('e2s_select_timezone'), 'submit-text' => $_strings['fb--select'], 'timezone-selector' => c9fe5($settings['timezone']['offset'],1), 'dst?' => $settings['timezone']['is_dst'], ); return array ( 'title' => $_strings['pt--default-timezone'], 'heading' => $_strings['pt--default-timezone'], 'form' => 'form-timezone', 'form-timezone' => $jde2fd, ); } function l4c37(){ global$_strings; $t5cacd=array ( -720 => '', -660 => '', -600 => '', -540 => '', -480 => $_strings['tt--zone-pt'], -420 => $_strings['tt--zone-mt'], -360 => $_strings['tt--zone-ct'], -300 => $_strings['tt--zone-et'], -240 => '', -210 => '', -180 => '', -120 => '', -60 => '', 0 => $_strings['tt--zone-gmt'], 60 => $_strings['tt--zone-cet'], 120 => $_strings['tt--zone-eet'], 180 => '', 210 => '', 240 => $_strings['tt--zone-msk'], 270 => '', 300 => '', 330 => '', 345 => '', 360 => $_strings['tt--zone-ekt'], 390 => '', 420 => '', 480 => '', 540 => '', 570 => '', 600 => '', 660 => '', 720 => '', 780 => '', 840 => '', ); return $t5cacd; } function z82a3($t7a86c){ $t5cacd=l4c37(); return @$t5cacd[(int)$t7a86c/SECONDS_IN_A_MINUTE]; } function d9515($t7a86c){ $l04b29='+'; if ($t7a86c < 0)$l04b29='&ndash;'; $m73cdd=str_pad((int) (abs($t7a86c)/3600),2,'0',STR_PAD_LEFT); $j640fd=str_pad(abs($t7a86c)/60 % 60,2,'0',STR_PAD_LEFT); return 'GMT'. $l04b29.$m73cdd .':'. $j640fd; } function c9fe5($u0743a,$e5784d=''){ global$_strings; $t5cacd=l4c37(); $t2cb9d=''; if (!$e5784d)$e5784d=count($t5cacd); $t2cb9d.='<select name="offset" size="'. $e5784d .'">'; foreach ($t5cacd as $t7a86c => $x83bce){ $ec03a8=''; if ($t7a86c*SECONDS_IN_A_MINUTE==$u0743a)$ec03a8=' selected="selected"'; $t2cb9d.='<option'. $ec03a8 .' value="'.$t7a86c.'">'; $l04b29=''; if ($t7a86c < 0)$l04b29='−'; if ($t7a86c > 0)$l04b29='+'; $m73cdd=(int) (abs($t7a86c*SECONDS_IN_A_MINUTE)/3600); $j640fd=(int) (abs($t7a86c*SECONDS_IN_A_MINUTE)/60 % 60); if ($m73cdd){ $t2cb9d .= ( $l04b29 .' '. $m73cdd .' '. $_strings['gs--timezone-offset-hours'] .' '. ($j640fd? ($j640fd .' '. $_strings['gs--timezone-offset-minutes']) : '') ); if ($x83bce){ $t2cb9d .= ' ('. $x83bce. ')'; } } else { $t2cb9d .= $x83bce; } $t2cb9d.='</option>'; } $t2cb9d.='</select>'; return $t2cb9d; } function e2s_select_timezone(){ global$settings,$_strings; if (@$_POST['offset'] >= -720 and @$_POST['offset'] <= 780){ $settings['timezone']['offset'] = @$_POST['offset']*SECONDS_IN_A_MINUTE; $settings['timezone']['is_dst'] = isset ($_POST['is_dst']); } if (!@v6e52(USER_FOLDER.'settings.psa',serialize($settings))) { f8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(d83c8('e2m_timezone')); die; } e2_go_to(d83c8('e2m_settings')) and die (); } function r0923($saad65){ return array ( 'offset' => (int)$saad65['Offset'], 'is_dst' => (bool)$saad65['IsDST'], ); } function r3211(){ return array ( 'offset' => 0, 'is_dst' => false, ); } function g5c05(){ global$settings; return$settings['timezone']; } function h7770($qb2c6c,$adf491){ if (@$qb2c6c['is_dst']) { $x30481=(int)date('I',$adf491); $z6b7ea=date('Z',$adf491)-$x30481*SECONDS_IN_AN_HOUR; $p3e61a=$qb2c6c['offset']; $w178ae=$p3e61a-$z6b7ea; $z75b02=date('I',$adf491+$w178ae); return $z75b02; } else { return 0; } } function wb2bf($qb2c6c,$adf491){ global$settings; if ($qb2c6c and is_array($qb2c6c)) { return ( $qb2c6c['offset'] + h7770($qb2c6c,$adf491)*SECONDS_IN_AN_HOUR ); } } function t8afe($adf491){ return wb2bf(g5c05(),$adf491); } function s5a2f($l1ddcb,$j4a202,$qb2c6c){ return gmdate($l1ddcb,$j4a202+wb2bf($qb2c6c,$j4a202)); } function pa846($l1ddcb,$j4a202){ return s5a2f($l1ddcb,$j4a202,g5c05()); } function p66cd($g41529,$k6f8f5=false,$e8277e=false){ if(is_numeric($e8277e)) { $zea2b2=gmmktime(0,0,0,$k6f8f5,$e8277e,$g41529); $d7f021=gmmktime(0,0,0,$k6f8f5,$e8277e+1,$g41529)-1; } elseif(is_numeric($k6f8f5)) { $zea2b2=gmmktime(0,0,0,$k6f8f5,1,$g41529); $d7f021=gmmktime(0,0,0,$k6f8f5+1,1,$g41529)-1; } else { $zea2b2=gmmktime(0,0,0,1,1,$g41529); $d7f021=gmmktime(0,0,0,1,1,$g41529+1)-1; } return array ($zea2b2,$d7f021); } function s2143($qb2c6c,$g41529,$k6f8f5=false,$e8277e=false){ list ($zea2b2,$d7f021)=p66cd($g41529,$k6f8f5,$e8277e); $zea2b2 -= wb2bf($qb2c6c,$zea2b2); $d7f021 -= wb2bf($qb2c6c,$d7f021); return array ($zea2b2,$d7f021); } function yac5b($g41529,$k6f8f5=false,$e8277e=false){ return s2143(g5c05(),$g41529,$k6f8f5,$e8277e); } function f5273($g41529,$k6f8f5=false,$e8277e=false){ $s32038=13; $pda4f0=-12; $s32038+=1; $pda4f0 -= 1; list ($zea2b2,$d7f021)=p66cd($g41529,$k6f8f5,$e8277e); $zea2b2 -= $s32038*3600; $d7f021 -= $pda4f0*3600; return array ($zea2b2,$d7f021); } function ed17a($t7a86c){ if ((int) @$t7a86c > 0) return (string)'+'.abs(@$t7a86c); elseif ((int) @$t7a86c < 0) return (string)'-'.abs(@$t7a86c); else return ''; } function qd536($adf491){ $q2ab64=t8afe($adf491); $l04b29=($q2ab64 >= 0)?'+':'-'; $q2ab64=abs($q2ab64); $i03c7c=$q2ab64 % 60; $q2ab64 -= $i03c7c; $k6f8f5=$q2ab64 % 3600/60; $q2ab64 -= $k6f8f5*60; $s2510c=$q2ab64/3600; if ($s2510c < 10)$s2510c='0'.$s2510c; if ($k6f8f5 < 10)$k6f8f5='0'.$k6f8f5; return $l04b29.$s2510c.$k6f8f5; } function na618($haa759){ global$settings; if(is_numeric($haa759)) { $result['offset']=SECONDS_IN_A_MINUTE*$haa759; $result['is_dst']=false; $sd8935=SECONDS_IN_A_MINUTE*$haa759-SECONDS_IN_AN_HOUR; $ma6cfc=array ('offset' => $sd8935,'is_dst' => true); $ma6cfc=(int)wb2bf($ma6cfc,time()); if($result['offset']==$ma6cfc){ $result['offset']=$sd8935; $result['is_dst']=true; } } else { if(array_key_exists('timezone',$settings)) { $result=$settings['timezone']; } else { $result['offset']=0; $result['is_dst']=false; } } return$result; } function x692f($a96b8c){ $s2510c=pa846('H',$a96b8c); if ($s2510c <= 4) return 4; elseif ($s2510c <= 10) return 1; elseif ($s2510c <= 16) return 2; elseif ($s2510c <= 22) return 3; else return 4; } function j7a0b($e0e524,$yb65f7=null){ global$_strings; if ($yb65f7===null)$yb65f7=g5c05(); $kdb42a=s5a2f('d.m.Y',$y97bc5,$yb65f7); $c33284=s5a2f('d.m.Y',$e0e524,$yb65f7); $hed79a=SECONDS_IN_A_MINUTE; $d77cbc=SECONDS_IN_AN_HOUR; $y97bc5=time(); $u0b375=x692f($y97bc5); $y3dfda=x692f($e0e524); $q74459=$y97bc5-$e0e524; if ($q74459 < 0) return$_strings['tt--from-the-future']; if ($q74459 >= 0 and $q74459 < 54) return$_strings['tt--just-published']; if ($q74459 >= 54 and $q74459 < 108) return$_strings['tt--one-minute-ago']; $e7eccb=$q74459+12; $s7828e=floor($e7eccb/$hed79a); if ($q74459 >= 108 and $q74459 < 54*$hed79a) return e2l_get_string( 'tt--minutes-ago', array ('minutes' => $s7828e) ); if ($q74459 >= 54*$hed79a and $q74459 < 108*$hed79a) return$_strings['tt--one-hour-ago']; $e7eccb=$q74459+12*$hed79a; $y6b497=floor($e7eccb/$d77cbc); if ($q74459 >= 108*$hed79a and $q74459 < 4*$d77cbc) return e2l_get_string( 'tt--hours-ago', array ('hours' => $y6b497) ); $t07cc6=s5a2f('G:i',$e0e524,$yb65f7); if ($q74459 >= 4*$d77cbc and $u0b375 > $y3dfda and $kdb42a==$c33284){ return e2l_get_string( 'tt--today-at', array ('time' => $t07cc6) ); } if ((($y97bc5-$e0e524) <= YEAR_DISPLAY_THRESH)) { return e2l_get_string( 'tt--date-and-time', array ( 'day' => s5a2f('j',$e0e524,$yb65f7), 'month' => s5a2f('m',$e0e524,$yb65f7), 'time' => $t07cc6, ) ); } return e2l_get_string( 'tt--date-year-and-time', array ( 'day' => s5a2f('j',$e0e524,$yb65f7), 'month' => s5a2f('m',$e0e524,$yb65f7), 'year' => s5a2f('Y',$e0e524,$yb65f7), 'time' => $t07cc6, ) ); } $_model_contractions=array ( 'key' => "INT UNSIGNED AUTO_INCREMENT PRIMARY KEY", 'pkey' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'int' => "INT DEFAULT '0' NOT NULL", 'uint' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'time' => "INT UNSIGNED DEFAULT '0' NOT NULL", '0' => "TINYINT( 1 ) DEFAULT '0' NOT NULL", '1' => "TINYINT( 1 ) DEFAULT '1' NOT NULL", 'v8' => "VARCHAR( 8 ) DEFAULT '' NOT NULL", 'v15' => "VARCHAR( 15 ) DEFAULT '' NOT NULL", 'v32' => "VARCHAR( 32 ) DEFAULT '' NOT NULL", 'v64' => "VARCHAR( 64 ) DEFAULT '' NOT NULL", 'fid' => "VARCHAR( 32 ) DEFAULT '". $_config['default_formatter'] ."' NOT NULL", 'v255' => "VARCHAR( 255 ) DEFAULT '' NOT NULL", 'text' => "TEXT NOT NULL", ); $_model=array ( 'Actions' => array ( array ('ID', 'key'), array ('EntityID', 'pkey'), array ('Stamp', 'time'), array ('HitCount', 'int'), ), 'Aliases' => array ( array ('ID', 'key'), array ('EntityID', 'pkey'), array ('Alias', 'v64'), array ('Stamp', 'time'), ), 'Notes' => array ( array ('ID', 'key'), array ('Title', 'v255'), array ('OriginalAlias', 'v64'), array ('Text', 'text'), array ('FormatterID', 'fid'), array ('IsPublished', '0'), array ('IsIssue', '0'), array ('IsCommentable', '0'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('Offset', 'int'), array ('IsDST', '0'), array ('IP', 'v15'), ), 'Comments' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('AuthorName', 'v255'), array ('AuthorEmail', 'v255'), array ('Text', 'text'), array ('Reply', 'text'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('IsReplyVisible', '0'), array ('IsReplyFavourite', '0'), array ('IsAnswerAware', '1'), array ('IsSubscriber', '0'), array ('IsSpamSuspect', '0'), array ('IsNew', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('ReplyStamp', 'time'), array ('ReplyLastModified','time'), array ('IP', 'v15'), ), 'Keywords' => array ( array ('ID', 'key'), array ('ParentKeywordID', 'pkey'), array ('Keyword', 'v255'), array ('URLName', 'v32'), array ('Description', 'text'), array ('IsFavourite', '0'), ), 'NotesKeywords' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('KeywordID', 'pkey'), ), ); function tf1ac($oaab9e){ global$settings,$_model,$_model_contractions; if(array_key_exists($oaab9e,$_model)) { $x54ca8=array(); foreach($_model[$oaab9e] as $f1afd3){ list ($zb0689,$s599dc)=$f1afd3; $x54ca8[] = "`". $zb0689 ."` ". $_model_contractions[$s599dc]; } $x1b1cc=( "CREATE TABLE `". $settings['db']['table_prefix'].$oaab9e ."` ". "(". implode(" ,",$x54ca8) .") ". "ENGINE=MyISAM DEFAULT CHARSET=utf8" ); if (t0738($x1b1cc)) return true; } } function m9943($oaab9e,$dde17f,$qb512d='INSERT',$c07ccf=''){ global$settings; $dd05b6="`". implode("`, `",array_keys($dde17f)). "`"; $tf09cc="'". implode("', '",array_values($dde17f)). "'"; $x1b1cc=( $qb512d ." INTO `". $settings['db']['table_prefix'].$oaab9e ."` ". "(".$dd05b6 .") VALUES (". $tf09cc .")". ($c07ccf? (' '. $c07ccf):'') ); if (t0738($x1b1cc)) { $dde17f['ID']=mysql_insert_id(); return $dde17f; } } function baa79($oaab9e,$dde17f,$u7692d=false,$t0f543=false){ global$settings; if(__LOG)__log('Model: update record, table <'. $oaab9e .'>'); $k6a7f2=array(); foreach(e2model__soft_fields_for_table_($oaab9e) as $d06e3d){ if(array_key_exists($d06e3d,$dde17f)) { $l10249=e7928($dde17f[$d06e3d]); if ($l10249[0]=='`'){ $rbcf11=$l10249; } else { $rbcf11="'". $l10249 ."'"; } $k6a7f2[] = '`'. $d06e3d .'`'."=". $rbcf11 .""; } } $vb5b39=array(); if(is_array($u7692d)) { foreach(e2model__soft_fields_for_table_($oaab9e) as $d06e3d){ if(array_key_exists($d06e3d,$u7692d)) { $vb5b39[] = '`'. $d06e3d .'`'."='". e7928($u7692d[$d06e3d]) ."'"; } } } if(count($vb5b39)) { $y56790=implode(" AND ",$vb5b39); } else { if (!array_key_exists('ID',$dde17f) or !is_numeric($dde17f['ID'])) { die ('API MISUSE: e2_update_record must be called with an ID field in $record when updating single row'); } $y56790="`ID`=". $dde17f['ID']; } if(count($k6a7f2) > 0){ $x91179=$t0f543? 'LOW_PRIORITY ':''; $x1b1cc=( "UPDATE ". $x91179 ."`". $settings['db']['table_prefix'].$oaab9e ."` ". "SET ". implode(', ',$k6a7f2) ." WHERE ". $y56790 ); if (t0738($x1b1cc)) return true; } } function e2model__soft_fields_for_table_($oaab9e){ global$_model; $t2cb9d=array(); if(array_key_exists($oaab9e,$_model)) { foreach($_model[$oaab9e] as $d06e3d){ if (!in_array($d06e3d[1], array ('key'))) { $t2cb9d[] = $d06e3d[0]; } } } return $t2cb9d; } function e2m_install(){ global$settings,$_strings,$_superconfig,$_files_written,$_folders_written,$_diagnose; $t2cb9d=array(); if(e2_is_installed()) { e2_go_to(''); } else { if($_superconfig['disallow_installer']) { die ('Installer disabled by superconfig'); } if(__LOG)__log('Installer: not installed, present user with form'); $t2cb9d['title']=$_strings['pt--install']; $t2cb9d['heading']=$_strings['pt--install']; $sc50d0=$_strings['fb--begin']; $zd77d5['server'] = @$_COOKIE[m8c3b('install_db_server')]; $zd77d5['user_name'] = @$_COOKIE[m8c3b('install_db_user_name')]; $zd77d5['passw']=ree85(@$_COOKIE[m8c3b('install_db_passw')]); $zd77d5['name'] = @$_COOKIE[m8c3b('install_db_name')]; $zd77d5['table_prefix'] = @$_COOKIE[m8c3b('install_db_table_prefix')]; $zd77d5['exists'] = @$_COOKIE[m8c3b('install_db_exists')]; $t2cb9d['form-install'] = array ( 'form-action' => d83c8('e2s_install'), 'form-check-db-config-action' => d83c8('e2j_check_db_config'), 'form-list-databases-action' => d83c8('e2j_list_databases'), 'submit-text' => $sc50d0, 'retry-text' => $_strings['fb--retry'], 'db-server' => htmlspecialchars(@$zd77d5['server']? $zd77d5['server']:'localhost'), 'db-user' => htmlspecialchars(@$zd77d5['user_name']? $zd77d5['user_name']:'root'), 'db-password' => htmlspecialchars(DB_PASSWORD_RECOVER_AND_SHOW? (@$zd77d5['passw']) : ''), 'db-database' => htmlspecialchars(@$zd77d5['name']), 'db-prefix' => htmlspecialchars(@$zd77d5['table_prefix']? $zd77d5['table_prefix']:'e2Blog'), 'db-exists?' => (bool)$zd77d5['exists'], ); $t2cb9d['form-install']['installation-possible?']=true; if(__LOG)__log('Installer: force directories'); foreach($_folders_written as $v45684){ @naf42($v45684); } if (!@isset ($_diagnose['ok?']))p8739(); if($_diagnose['ok?']) { if(__LOG)__log('Installer: everything is fine'); } else { if(__LOG)__log('Installer: problems, tell user'); $t2cb9d['form-install']['installation-possible?']=false; } } if(__LOG)__log('Installer: return'); return $t2cb9d; } function e2_instantiate($c2af72){ global$_instance; $_instance['version']=$c2af72; if (v6e52(USER_FOLDER. '/instance.psa',serialize($_instance))) { return true; } else { die ('Cannot instantiate v'. $c2af72 .': probably permission denied'); } } function e2s_instantiate($parameters){ global$_strings; if(e2_is_installed()) { die ('Remove the file "'. USER_FOLDER .'instance.psa" first'); } else { if(is_numeric($parameters['version'])) { if(e2_instantiate($parameters['version'])) { f8a40($_strings['gs--instantiated-version'] .' v'. $parameters['version'],E2E_MESSAGE); e2_go_to(d83c8('e2m_frontpage')); die; } } } die ('Could not create instance of engine'); } function e2s_install(){ global$settings,$_strings,$_instance; if(e2_is_installed()) { e2_go_to(d83c8('e2m_install')); die; } else { e2_drop_all_kinds_of_cache(); $zd77d5['server'] = @$_POST['db-server']; $zd77d5['user_name'] = @$_POST['db-user']; $zd77d5['passw']=m1305(@$_POST['db-password']); $zd77d5['name'] = @$_POST['db-database']; $zd77d5['table_prefix'] = @$_POST['db-prefix']; $zd77d5['exists'] = isset ($_POST['db-exists']); $qb2c6c=na618(@$_POST['gmt-offset']); foreach ($zd77d5 as $a8ce4b => $z9e366){ jc64a('install_db_' .$a8ce4b,$z9e366); } @session_start(); if (!array_key_exists('password',$_POST) or trim($_POST['password']) == ''){ f8a40($_strings['er--no-password-entered'],E2E_USER_ERROR); e2_go_to(d83c8('e2m_install')); die; } $y88162=trim($_POST['password']); $x2d6d8['sessions'] = array (array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => te8ed(true), 'ua' => $_SERVER['HTTP_USER_AGENT'], )); $j444bc=true; if (!n1d21($x2d6d8)) { f8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); $j444bc=false; } if (!@v6e52(USER_FOLDER.'password-hash.psa',serialize(z4c49($y88162)))) { f8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); $j444bc=false; } if (!$zd77d5['exists']) { $settings=array(); } $settings['db']=$zd77d5; $settings['timezone']=$qb2c6c; $settings['template']='classical'; $settings['language']=DEFAULT_LANGUAGE; if (!@v6e52(USER_FOLDER.'settings.psa',serialize($settings))) { f8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); $j444bc=false; } if ($j444bc){ if ($zd77d5['exists']) { if(__LOG)__log('Installer: No need to create DB'); $bba46b=r0f7c(); if (!$bba46b){ if(__LOG)__log('Installer: DB not OK'); f8a40($_strings['er--double-check-db-params']); } } else { if(__LOG)__log('Installer: Creating DB...'); $bba46b=( tf1ac('Notes') and tf1ac('Comments') and tf1ac('Keywords') and tf1ac('NotesKeywords') and tf1ac('Aliases') and tf1ac('Actions') ); if (!$bba46b){ if(__LOG)__log('Installer: DB not OK'); f8a40($_strings['er--double-check-db-params']); } } if ($bba46b){ if(__LOG)__log('Installer: DB OK, instantiating...'); e2_instantiate(E2_VERSION); if(__LOG)__log('Installer: Done'); if (!$zd77d5['exists']) { if(__LOG)__log('Installer: Adding indexes...'); t0738( "ALTER TABLE `". $settings['db']['table_prefix']."Notes` ". "ADD FULLTEXT (`Title`, `Text`)" ); t0738( "ALTER TABLE `". $settings['db']['table_prefix']."Notes` ". "ADD INDEX (`Stamp`);" ); t0738( "ALTER TABLE `". $settings['db']['table_prefix']."Comments` ". "ADD INDEX (`NoteID`);" ); t0738( "ALTER TABLE `". $settings['db']['table_prefix']."NotesKeywords` ". "ADD INDEX (`NoteID`)" ); t0738( "ALTER TABLE `". $settings['db']['table_prefix']."Aliases` ". "ADD INDEX (`Alias`);" ); t0738( "ALTER TABLE `". $settings['db']['table_prefix']."Aliases` ". "ADD INDEX (`EntityID`);" ); if(__LOG)__log('Installer: Done'); } if(__LOG)__log('Installer: Complete'); } e2_go_to(); die; } else { e2_go_to(d83c8('e2m_install')); die; } } } function e2_is_installed(){ global$_instance; return (bool)$_instance; } function e2_make_sure_that_installed(){ global $z57de2,$va57c1,$_instance,$_superconfig; if(e2_is_installed()) { if(E2_VERSION < $_instance ['version']) { if(__LOG)__log('Installer: cannot downdate'); header('HTTP/1.1 503 Service Unavailable'); die ('E2 does not support automatic downgrade.'); } elseif(E2_VERSION > $_instance ['version']) { if(__LOG)__log('Installer: need to update'); header('Location: http://'. $z57de2.$va57c1 .'/perform_update/'); header('Location: '. d83c8('e2s_update_perform')); die; } else { if(__LOG)__log('Installer: no job for me'); return; } } if(__LOG)__log('Installer: not installed {'); if ((strpos($_SERVER['SERVER_SOFTWARE'],'Apache')===0)) { if(__LOG)__log('Installer: running on Apache'); $sefe79=DEFAULTS_FOLDER.'default.htaccess'; $hd5c54=false; if (!is_file($sefe79)) { echo 'File not found: '.$sefe79. '. Please use the full E2 installation package.'; die; } if(is_file('.htaccess')) { if(__LOG)__log('Installer: there is a .htaccess file in the installation directory'); $fe6f97=file_get_contents($sefe79); $kc6680=file_get_contents('.htaccess'); if ($kc6680!=$fe6f97){ $hd5c54=true; $f6a9d4=$zd1813='.htaccess.old'; $z3c549=1; while (is_file($zd1813)) { $zd1813=$f6a9d4 .'.'. $z3c549 ++; } if(__LOG)__log('Installer: existing .htaccess wrong, backing up as <'. $zd1813 .'>'); if (!@rename('.htaccess',$zd1813)) { if(__LOG)__log('Installer: fuck'); echo 'Looks like you are using Apache and have put an incorrect ".htaccess" file in the installation directory. Additionally, the installer was not able to back up your existing ".htaccess" file in order to replace it with the correct one. Please use the full E2 installation package and grant write access on the installation target directory, all the files and subdirectories.'; die; } } } else { $hd5c54=true; } if ($hd5c54){ if(__LOG)__log('Installer: writing a correct .htaccess file'); if (!@copy($sefe79,'.htaccess')) { if(__LOG)__log('Installer: fuck'); echo 'The installer was not able to create a correct ".htaccess" file. Please grant write access on the installation target directory.'; die; } } } if($_superconfig['disallow_installer']) { die ('Not installed'); } else { $d601f0=d83c8('e2m_install'); if(__LOG)__log('Installer: will need to install, going to '. $d601f0); if(__LOG)__log('}'); e2_go_to($d601f0); die; } } function e2_htaccess_on_apache(){ } function e2_dbserver_usable_databases($ecf1e8,$wee11c,$g5f4dc){ $u32e95=array(); if (($y2a304=mysql_connect($ecf1e8,$wee11c,$g5f4dc)) !== false){ $ke61ce=mysql_list_dbs($y2a304); while ($of1965=mysql_fetch_row($ke61ce)) { if ( mysql_select_db($of1965[0],$y2a304) and !in_array($of1965[0], array ('information_schema','mysql')) ) { $u32e95[] = $of1965[0]; } } } return $u32e95; } function e2j_check_db_config(){ global$_model; $ecf1e8=$wee11c=$g5f4dc=$t11e0e=$d851f5=''; if(array_key_exists('server',$_POST)) $ecf1e8= $_POST['server']; if(array_key_exists('user',$_POST)) $wee11c= $_POST['user']; if(array_key_exists('password',$_POST))$g5f4dc=$_POST['password']; if(array_key_exists('database',$_POST))$t11e0e=$_POST['database']; if(array_key_exists('prefix',$_POST)) $d851f5= $_POST['prefix']; $ye0879=(bool) ($_POST['exists']=='true'); ini_set('mysql.connect_timeout',1); if (($w098f6=mysql_connect($ecf1e8,$wee11c,$g5f4dc)) === false){ if (($w098f6=mysql_connect($ecf1e8)) === false){ die ('no-connect'); } else { die ('server-responding'); } } else { if (!$t11e0e){ $u32e95=e2_dbserver_usable_databases($ecf1e8,$wee11c,$g5f4dc); $t11e0e=$u32e95[0]; } if(mysql_select_db($t11e0e,$w098f6)===false){ die ('server-lets-in'); } else { $q08cfc=false; $s35f9b=array(); $pac5c7='SHOW TABLES FROM `'. e7928($t11e0e). '`'; $result=mysql_query($pac5c7,$w098f6); if($result){ while ($of1965=mysql_fetch_row($result)) { foreach(array_keys($_model) as $nd2ffa){ if(strcasecmp($of1965[0],$d851f5.$nd2ffa)===0){ $q08cfc=true; $s35f9b[] = $nd2ffa; } } } } $i6cfe6=true; foreach(array_keys($_model) as $nd2ffa){ if (!in_array($nd2ffa,$s35f9b)) { $i6cfe6=false; } } if (!$ye0879 and $q08cfc){ die ('prefix-occupied'); } if ($ye0879 and !$q08cfc){ die ('prefix-not-found'); } die ('bingo'); } } } function e2j_list_databases(){ $ecf1e8=$wee11c=$g5f4dc=''; if(array_key_exists('server',$_POST)) $ecf1e8= $_POST['server']; if(array_key_exists('user',$_POST)) $wee11c= $_POST['user']; if(array_key_exists('password',$_POST))$g5f4dc=$_POST['password']; $u32e95=e2_dbserver_usable_databases($ecf1e8,$wee11c,$g5f4dc); if ($u32e95) die (implode('|',$u32e95)); die; } function ebef8($s7d0db,$icb5e1){ $k076ae['update-failed-at']=$s7d0db; @v6e52(USER_FOLDER.'update-state.psa',serialize($k076ae)); header('HTTP/1.1 503 Service Unavailable'); die ('Update stuck at v'. $s7d0db .' with message:<br /><br />' .$icb5e1); } function e2s_update_perform(){ global$_instance,$_model,$settings; $rd98a0=max((int) ($_instance['version']), 2285); if($_instance['version']==E2_VERSION){ p4930(); die; } $k076ae=@unserialize(tcdf0(USER_FOLDER. '/update-state.psa')); if (isset ($k076ae['update-failed-at'])) { $rd98a0=$k076ae['update-failed-at']-1; @unlink(USER_FOLDER. '/update-state.psa'); } if ($rd98a0 < 2344){ @unlink(USER_FOLDER. 'last-update.psa'); e2_instantiate(2344); } if ($rd98a0 < 2411){ t0738( "ALTER TABLE `". $settings['db']['table_prefix']."Notes` ". "ADD `FormatterID` VARCHAR( 32 ) DEFAULT 'calliope' NOT NULL AFTER `Text`" ); e2_drop_all_kinds_of_cache(); e2_instantiate(2411); } if ($rd98a0 < 2425){ t0738( "ALTER TABLE `". $settings['db']['table_prefix']."Notes` ". "CHANGE `URLName` `URLName` VARCHAR( 32 ) DEFAULT '' NOT NULL" ); e2_drop_all_kinds_of_cache(); e2_instantiate(2425); } if ($rd98a0 < 2560){ e2_drop_all_kinds_of_cache(); } if ($rd98a0 < 2587){ xc5a6('caches/*'); rmdir('caches'); @naf42(CACHES_FOLDER); } if ($rd98a0 < 2609){ tf1ac('Aliases'); e2_instantiate(2609); } if ($rd98a0 < 2610){ t0738( "ALTER TABLE `". $settings['db']['table_prefix']."Notes` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `FormatterID`" ); e2_instantiate(2610); } if ($rd98a0 < 2661){ @naf42(BACKUP_FOLDER); e2_drop_all_kinds_of_cache(); } if ($rd98a0 < 2688){ foreach(array_keys($_model) as $nd2ffa){ t0738( "SHOW TABLE STATUS LIKE '". $settings['db']['table_prefix'].$nd2ffa ."' " ); $g4b43b=b0d6b(); if(count($g4b43b) > 0){ $td89e2=$g4b43b[0]['Collation']; if ($td89e2!='utf8_general_ci'){ t0738( "ALTER TABLE `". $settings['db']['table_prefix'].$nd2ffa ."` ". "CONVERT TO CHARACTER SET utf8 COLLATE utf8_general_ci" ); } } } e2_instantiate(2688); e2_drop_all_kinds_of_cache(); } if ($rd98a0 < 2691){ $settings=e2_utf8_version_of_array_($settings); if (!@v6e52(USER_FOLDER.'settings.psa',serialize($settings))) { f8a40($_strings['er--cannot-save-data'],E2E_PERMISSIONS_ERROR); } e2_drop_all_kinds_of_cache(); } if ($rd98a0 < 2750){ tf1ac('Actions'); t0738( "ALTER TABLE `". $settings['db']['table_prefix']."Actions` ". "ADD UNIQUE INDEX (`EntityID`, `Stamp`);" ); e2_instantiate(2750); } if ($rd98a0 < 2753){ t0738( "ALTER TABLE `". $settings['db']['table_prefix']."Notes` ". "ADD INDEX (`Stamp`);" ); t0738( "ALTER TABLE `". $settings['db']['table_prefix']."Aliases` ". "ADD INDEX (`Alias`);" ); t0738( "ALTER TABLE `". $settings['db']['table_prefix']."Aliases` ". "ADD INDEX (`EntityID`);" ); t0738( "ALTER TABLE `". $settings['db']['table_prefix']."Comments` ". "ADD INDEX (`NoteID`);" ); } if ($rd98a0 < 2821){ if (@$settings['template']==''){ $settings['template']='classical'; } } if ($rd98a0 < 2850){ @unlink(CACHES_FOLDER.'index.xml'); } @v6e52(USER_FOLDER.'settings.psa',serialize($settings)); e2_instantiate(E2_VERSION); if (oe852()) { f8a40(e2l_get_string('gs--updated-successfully', array ( 'from' => 'v'. $rd98a0, 'to' => 'v'. $_instance['version'], )), E2E_MESSAGE); } e2_go_to(); die; } function r0f7c(){ global$settings,$_db,$_db_error; if (@$_db['connected']!==true){ $sd7909=$settings['db']['passw']; if ( ( $z3d801=@mysql_connect( $settings['db']['server'], $settings['db']['user_name'], $sd7909 ) ) !== false ){ mysql_close($z3d801); if(__LOG)__log('DB: storing password in a new way'); $sd7909=m1305($sd7909); $settings['db']['passw']=$sd7909; @v6e52(USER_FOLDER.'settings.psa',serialize($settings)); } $sd7909=ree85($sd7909); if ( ( $_db['link'] = @mysql_connect( $settings['db']['server'], $settings['db']['user_name'], $sd7909 ) ) !== false ){ if(mysql_select_db($settings['db']['name'])) { $_db['connected']=true; return true; } else { $_db_error=DB_CANNOT_FIND; return false; } } else { $_db_error=DB_CANNOT_CONNECT; return false; } } else { return true; } } function t0738($b7694f){ global $y11755,$_db,$_db_error,$settings,$_strings; if(__LOG)__log('DB: query <'. $b7694f .'>'); $k9b54f=r7f78(); @$y11755 ++; if (r0f7c()) { $h8e815='utf8'; if ( version_compare(mysql_get_server_info(),'4.1','>=') and @$_db['latest_setnames']!=$h8e815 ){ mysql_query("SET NAMES ". $h8e815); $_db['latest_setnames']=$h8e815; } if($_db['result']=mysql_query($b7694f,$_db['link'])) { if(__LOG)__log('DB: done in '. round(r7f78()-$k9b54f,3)); return true; } else { f8a40($_strings['er--error-in-query']. ': <br /><code>'.nl2br($b7694f).'</code><br />'. mysql_error(),E2E_DATABASE_ERROR); return false; } } else { if($_db_error==DB_CANNOT_FIND){ if(__LOG)__log('DB: cannot find db'); f8a40($_strings['er--cannot-find-db'],E2E_DATABASE_ERROR); } elseif($_db_error==DB_CANNOT_CONNECT){ if(__LOG)__log('DB: cannot connect to db'); f8a40($_strings['er--cannot-connect-to-db'],E2E_DATABASE_ERROR); } else { if(__LOG)__log('DB: db error '. $_db_error); f8a40($_strings['er--error-occurred'].' ('. $_db_error .')',E2E_DATABASE_ERROR); } return false; } } function b0d6b($s599dc=MYSQL_ASSOC){ global$_db; $t2cb9d=array(); while ($y0cc17=@mysql_fetch_array($_db['result'],$s599dc)) { foreach ($y0cc17 as $g865c0 => $j4921c){ if(is_string($j4921c)) { $y0cc17[$g865c0]=$j4921c; } } $t2cb9d[] = $y0cc17; } return $t2cb9d; } function e7928($nb45cf){ r0f7c(); return mysql_real_escape_string($nb45cf); } function fb488(){ echo '<pre>'; echo 'Sifting backups...<br>'; $j10ae9=array(); foreach(glob(BACKUP_FOLDER. '*.sql') as $w8c7dd){ if(preg_match('/^backup\-(\d+)\-(\d+)\-(\d+)\-at\-(\d+)\-(\d+)\-(\d+)\.sql$/is',basename($w8c7dd),$e9c28d)) { list (, $g41529,$k6f8f5,$e8277e,$s2510c,$g865c0,$i03c7c)=$e9c28d; $a96b8c=gmmktime($s2510c,$g865c0,$i03c7c,$k6f8f5,$e8277e,$g41529); $j10ae9[$a96b8c]=$w8c7dd; } } if(count($j10ae9) > 3){ echo 'More than 3 backups, time to sift...<br>'; $c536a1=-1; $gf46c9=array (SECONDS_IN_A_MINUTE,SECONDS_IN_AN_HOUR,SECONDS_IN_A_DAY, -1); $g865c0=0; foreach(array_reverse($j10ae9,true) as $a96b8c => $w8c7dd){ echo '-> '. $w8c7dd .' ('. gmdate('r',$a96b8c) .')<br>'; if ($c536a1 == -1){ echo '   latest, leave<br>'; $c536a1=$a96b8c; } elseif ($gf46c9[$g865c0] == -1){ echo '   too old, remove<br>'; unlink($w8c7dd); } else { if ($c536a1-$a96b8c < $gf46c9[$g865c0]) { echo '   no need (not long ago), remove<br>'; unlink($w8c7dd); } else { $g865c0 ++; echo '   ok, leave, set interval to '. $gf46c9[$g865c0] .'<br>'; $c536a1=$a96b8c; } } } } else { echo 'No need to sift<br>'; } echo '</pre>'; return; } function e2s_dump(){ global$_model,$settings,$_db; if (r0f7c()) { if($_db['link']) { $r68720=time() - (SECONDS_IN_A_DAY); t0738( "DELETE FROM `". $settings['db']['table_prefix']."Actions` ". "WHERE (`Stamp` < ". (time() - (SECONDS_IN_A_DAY*7)) ." AND `HitCount` <= 1) ". "OR (`Stamp` < ". (time() - (SECONDS_IN_A_MONTH)) ." AND `HitCount` <= 5)". "OR (`Stamp` < ". (time() - (SECONDS_IN_A_YEAR)) ." AND `HitCount` <= 10)" ); $x9ab2e=array(); foreach(array_keys($_model) as $oaab9e){ $x9ab2e[] = $settings['db']['table_prefix'].$oaab9e; } e2_backup( $_db['link'], $x9ab2e, BACKUP_FOLDER .'backup-'.gmdate('Y-m-d-\a\t-H-i-s').'.sql' ); fb488(); die ('Done'); } } die ('Could not backup'); } function e2ali__alias_from_title_($z36cd3){ global$_config; $f3e891=$z36cd3; if(array_key_exists('autoreplace_for_aliases',$_config)) { $f3e891=strtr( $f3e891, $_config['autoreplace_for_aliases'] ); } $f3e891=e2l_transliterate($f3e891); $f3e891=str_replace('\'','',$f3e891); $f3e891=str_replace('’','',$f3e891); $f3e891=str_replace(chr(146),'',$f3e891); $b17901=''; for ($g865c0=0; $g865c0 < strlen($f3e891); ++ $g865c0){ if ( (ord($f3e891[$g865c0]) >= 48 and ord($f3e891[$g865c0]) <= 57) or (ord($f3e891[$g865c0]) >= 65 and ord($f3e891[$g865c0]) <= 90) or (ord($f3e891[$g865c0]) >= 97 and ord($f3e891[$g865c0]) <= 122) or 0 ){ $b17901.=$f3e891[$g865c0]; } else { $b17901.='-'; } } $b17901=preg_replace('/\-+/','-',$b17901); $b17901=trim($b17901,'-'); $b17901=strtolower($b17901); if ($b17901=='-')$b17901=''; return $b17901; } function e2_aliasrec_of_alias_($m72487){ global$settings; if (!$m72487) return false; if (t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Aliases` ". "WHERE `Alias` = '" .$m72487. "' ". "ORDER BY Stamp LIMIT 1" )) { $result=b0d6b(); if(count($result)==1){ return$result[0]; } } } function e2_active_alias_for_note_with_id_($y21158){ global$settings,$_e2_active_alias_for_note_by_ids; if ($y21158){ if ( is_array($_e2_active_alias_for_note_by_ids) and array_key_exists($y21158,$_e2_active_alias_for_note_by_ids) ) { return @$_e2_active_alias_for_note_by_ids[$y21158]; } else { if (t0738( "SELECT `Alias` ". "FROM `". $settings['db']['table_prefix']."Aliases` ". "WHERE `EntityID` = ". $y21158 ." ". "ORDER BY `Stamp` DESC LIMIT 1" )) { $result=b0d6b(); $_e2_active_alias_for_note_by_ids[$y21158]=$result[0]['Alias']; } } return @$_e2_active_alias_for_note_by_ids[$y21158]; } else { } } function qd712($a15d61,$y21158,$z36cd3,$ffb873=1){ global$settings; if ($a15d61=='set' and !$y21158) return false; $b17901=e2ali__alias_from_title_($z36cd3); if ($ffb873 > 1){ $b17901.='-'. $ffb873; } if ( $b17901!='' and $kc45dd=e2_aliasrec_of_alias_($b17901) ) { $u1123c=$kc45dd['EntityID']; if ( ($y21158 and $u1123c==$y21158) or $b17901!=e2_active_alias_for_note_with_id_($u1123c) ) { if ($a15d61=='find'){ return $b17901; } if ($a15d61=='set'){ if (baa79('Aliases', array ( 'ID' => $kc45dd['ID'], 'EntityID' => $y21158, 'Alias' => $b17901, 'Stamp' => time(), ))) { return $b17901; } } } else { return qd712($a15d61,$y21158,$z36cd3,$ffb873+1); } } else { if ($y21158 and $b17901==''){ if(e2_active_alias_for_note_with_id_($y21158)==''){ return ''; } } if ($a15d61=='find'){ return $b17901; } if ($a15d61=='set'){ if (m9943('Aliases', array ( 'EntityID' => $y21158, 'Alias' => $b17901, 'Stamp' => time(), ))) { return $b17901; } } } return ''; } function vb7c3($y21158,$z36cd3,$ffb873=1){ return qd712('set',$y21158,$z36cd3,$ffb873=1); } function e2m_note($parameters=array ()) { global$settings,$z57de2,$_config,$_strings; if(__LOG)__log('Note {'); $saad65=$parameters['*note']; $v229c3=$parameters['day-number']; $b80791=-1; if($_config['note_url_slidedown']) { if(__LOG)__log('Slidedown {'); while (1){ if ( $saad65==false or !($saad65['IsVisible'] or oe852()) ) { if ($b80791 == -1){ $b80791=kf9fb( $parameters['year'],$parameters['month'],$parameters['day'] ); } if ($v229c3 > 1){ -- $v229c3; $saad65=@$b80791[$v229c3-1]; continue; } return e2_error404_mode(); } else { break; } } if ($saad65['Stamp'] > time() and !oe852()) { return e2_error404_mode(); } if(__LOG)__log('redirect if necessary'); if ($v229c3!=$parameters['day-number']) { $parameters['day-number']=$v229c3; e2_go_to(d83c8('e2m_note',$parameters)); } if(__LOG)__log('} // Slidedown'); } if ($saad65==false){ return e2_error404_mode(); } $nd58c0=d83c8('e2m_note',$parameters); if($settings['comments']['on']) { v3010( $_strings['nf--comments-on-this-post'], d83c8('e2m_note_comments_rss',$parameters) ); } if(__LOG)__log('Navigation {'); $ifcb08=qcca7($saad65,'prev'); $jd0cab=qcca7($saad65,'next'); if ($ifcb08){ $gb3b32['prev-href']=d83c8('e2m_note', array ('*note' => $ifcb08)); $gb3b32['prev-title']=q6f10(htmlspecialchars(vea9c($ifcb08),ENT_NOQUOTES,HSC_ENC)); } if ($jd0cab){ $gb3b32['next-href']=d83c8('e2m_note', array ('*note' => $jd0cab)); $gb3b32['next-title']=q6f10(htmlspecialchars(vea9c($jd0cab),ENT_NOQUOTES,HSC_ENC)); } $gb3b32['title']=$_strings['nm--posts']; $gb3b32['timeline?']=false; $gb3b32['this-title']=q6f10(htmlspecialchars(vea9c($saad65),ENT_NOQUOTES,HSC_ENC)); if(__LOG)__log('}'); if(__LOG)__log('packaging...'); $saad65['_']['_id']=$saad65['ID']; $saad65['_']['_ord']=0; $saad65['_']['_ord_max']=0; $r8e4cd=d6791($saad65); if(__LOG)__log('update read count...'); $tff089=time(); $tff089=$tff089 - ($tff089 % SECONDS_IN_AN_HOUR); m9943( 'Actions', array ( 'EntityID' => $saad65['ID'], 'Stamp' => $tff089, 'HitCount' => 1, ), 'INSERT LOW_PRIORITY', 'ON DUPLICATE KEY UPDATE `HitCount` = `HitCount` + 1' ); $xe35b1=''; $x01a5b=''; $n33ff2=false; $p905f7=false; $x7bae4=''; $pd09b4=''; if(1 or @$settings['comments']['on']) { $o83625=e2_note_cache_filename_with_id_($saad65['_']['_id'] .'-comments'); $i1e8cc=null; if(CACHE_NOTES_COMMENTS and !oe852() and is_file($o83625)) { $i1e8cc=@unserialize(tcdf0($o83625)); } if(__LOG)__log('Comments {'); if(is_array($i1e8cc)) { if(__LOG)__log('retrieve cached ctree'); $xe35b1=$i1e8cc; } else { if(__LOG)__log('assemble ctree...'); $wc1fdc=o1baf($saad65['ID'],"ORDER BY `Stamp`"); $ma5d49=array(); $s04c25=true; foreach ($wc1fdc as $a8ce4b => $h4032b){ if ($h4032b['IsVisible']) { $h4032b['_']['_id']=$h4032b['ID']; $h4032b['_']['_ord']=$a8ce4b; $h4032b['_']['_ord_max']=count($wc1fdc)-1; $p06d4c=o86f8( $saad65, $h4032b, $a8ce4b+1 ); if ($p06d4c['new?'] and $s04c25){ $p06d4c['first-new?']=true; $s04c25=false; } $ma5d49[] = $p06d4c; } } $xe35b1=$ma5d49; if(CACHE_NOTES_COMMENTS and !oe852())v6e52($o83625,serialize($xe35b1)); } if(__LOG)__log('} // Comments'); $x01a5b=d83c8('e2m_note_comments_rss', array ('*note' => $saad65)); if ($r8e4cd['commentable-now?']) { $y80f02=d66aa($saad65); } if (oe852() and ob387($saad65,NOTE_COMMENTABLE_NOW_CONDITIONALLY)) { if ($saad65['IsCommentable']) { $x7bae4['href']=d83c8('e2m_note_flag', array ( '*note' => $saad65, 'flag' => 'IsCommentable', 'value' => 0, )); $x7bae4['text']=$_strings['bt--close-comments-to-post']; } else { $x7bae4['href']=d83c8('e2m_note_flag', array ( '*note' => $saad65, 'flag' => 'IsCommentable', 'value' => 1, )); $x7bae4['text']=$_strings['bt--open-comments-to-post']; } } } if ( oe852() and array_key_exists('new-comments-count',$r8e4cd) and $r8e4cd['new-comments-count'] ) { if(__LOG)__log('mark comments as not new'); e2_drop_caches_for_note_($y21158); baa79('Comments', array ('IsNew' => 0), array ('NoteID' => $saad65['_']['_id'])); } if(__LOG)__log('more work...'); $ya80da=l5421($r8e4cd['text']); $te70c4['class']='note'; $te70c4['title']=vea9c($saad65); $te70c4['pages']=$gb3b32; $te70c4['summary']=$ya80da; $te70c4['notes'] = array ('only' => $r8e4cd); if ($xe35b1) $te70c4['comments']=$xe35b1; if ($x01a5b) $te70c4['comments-rss-href']=$x01a5b; if ($x7bae4) $te70c4['comments-toggle']=$x7bae4; if ($y80f02) $te70c4['form-comment']=$y80f02; if(__LOG)__log('} // Note'); return $te70c4; } function e2m_note_hitinfo($parameters=array ()) { global$settings; $saad65=$parameters['*note']; echo '<table>'; echo '<tr valign="top">'; foreach ( array ('day','week','month','year','ever') as $na0acf ){ echo '<td>'; echo '<h2>'. $na0acf.' hits</h2>'; echo '<p>'; $d632a2=time()-w35c3($na0acf); if (t0738( "SELECT SUM(`HitCount`) HitCount FROM `". $settings['db']['table_prefix']."Actions` ". "WHERE `EntityID` = ". $saad65['ID'] ." ". "AND `Stamp` > ". $d632a2 ." ". "GROUP BY `EntityID`" )) { $a9b207=b0d6b(); echo $a9b207[0]['HitCount']; } echo '</p>'; if (t0738( "SELECT n.`ID`, n.`Title`, n.`IsFavourite`, a.`EntityID`, SUM(a.`HitCount`) HitCount ". "FROM `". $settings['db']['table_prefix']."Actions` a, ". "`". $settings['db']['table_prefix']."Notes` n  ". "WHERE a.`Stamp` > ". $d632a2 ." ". "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, HitCount DESC ". "LIMIT 10" )) { echo mysql_error(); $a9b207=b0d6b(); echo '<h3>Popular</h3>'; foreach ($a9b207 as $g4b43b){ echo '<p><a href="'. $g4b43b['ID']. '">'. $g4b43b['Title'] .'</a> ('. $g4b43b['HitCount'] .')</p>'; } } } die ('!'); } function e2m_note_withdraw($parameters=array ()) { global$settings,$_strings; $zea59a=$parameters['*note']; if (!$zea59a) return e2_error404_mode(); $zea59a['IsPublished']=0; $zea59a['IsCommentable']=0; $zea59a['IsVisible']=1; $zea59a['Stamp']=time(); $zea59a['IP']=$_SERVER['REMOTE_ADDR']; if($parameters['alias']) { $zea59a['OriginalAlias']=$parameters['alias']; } else { $zea59a['OriginalAlias']=qd712( 'find',$zea59a['ID'],$zea59a['Title'] ); } e2_drop_caches_for_note_($zea59a['ID']); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); if ($zea59a['IsFavourite']) { @unlink(CACHE_FILENAME_FAVS); } if (baa79('Notes',$zea59a)) { vb7c3($zea59a['ID'],''); e2_go_to(d83c8('e2m_draft', array ( 'draft' => $y21158, 'oalias' => $zea59a['OriginalAlias'], ))); } else { p4930(); } } function e2m_note_delete($parameters=array()) { global$settings,$_strings; $zea59a=$parameters['*note']; if (!$zea59a) return e2_error404_mode(); $cf91b2=!$zea59a['IsPublished']; if ($cf91b2){ $f72bd7=e2l_get_string('gs--draft-will-be-deleted', array ( 'draft' => htmlspecialchars($zea59a['Title'],ENT_NOQUOTES,HSC_ENC), )); } else { $f72bd7=e2l_get_string('gs--post-will-be-deleted', array ( 'post' => htmlspecialchars($zea59a['Title'],ENT_NOQUOTES,HSC_ENC), )); } $kd5d3d=$cf91b2? $_strings['pt--draft-deletion']:$_strings['pt--post-deletion']; $x57529=array ( '.note-id' => $zea59a['ID'], '.is-draft' => (int)$cf91b2, 'note-title' => htmlspecialchars($zea59a['Title'],ENT_COMPAT,HSC_ENC), 'caution-text' => $f72bd7, 'form-action' => d83c8('e2s_note_delete'), 'submit-text' => $_strings['fb--delete'], 'draft?' => (int)$cf91b2, ); $t2cb9d=array ( 'title' => $kd5d3d. ': '. htmlspecialchars($zea59a['Title'],ENT_NOQUOTES,HSC_ENC), 'heading' => $kd5d3d, 'form' => 'form-note-delete', 'form-note-delete' => $x57529, ); return $t2cb9d; } function e2m_note_flag_favourite($parameters){ global$_config; $parameters['flag']='IsFavourite'; if (a7e6c($parameters)) { $b67142=$parameters; $b67142['value'] = !$parameters['value']; if($parameters['value']==1){ $l99859=d83c8('e2m_note_flag_favourite',$b67142); $k1fa03='on-rehref|'. $l99859; } else { $l99859=d83c8('e2m_note_flag_favourite',$b67142); $k1fa03='off-rehref|'. $l99859; } } else { $k1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($k1fa03); } else { e2_go_to(d83c8('e2m_note',$parameters)); die; } } function e2m_note_flag($parameters){ a7e6c($parameters); if(array_key_exists('draft',$parameters)) { e2_go_to(d83c8('e2m_draft',$parameters)); } else { e2_go_to(d83c8('e2m_note',$parameters)); } die; } function a7e6c($parameters){ $y21158=$parameters['*note']['ID']; if (!is_numeric($y21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($y21158); if($parameters['flag']=='IsFavourite'){ @unlink(CACHE_FILENAME_FAVS); } $result=baa79('Notes', array ( 'ID' => $y21158, $parameters['flag'] => (int) ($parameters['value']==1), )); return$result; } function e2m_note_use_formatter($parameters){ $y21158=$parameters['*note']['ID']; if (!is_numeric($y21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($y21158); if (!$parameters['*note']['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); } if(in_array($parameters['formatter'], array ('calliope','raw','neasden'))) { $result=baa79('Notes', array ( 'ID' => $y21158, 'FormatterID' => $parameters['formatter'], )); echo 'formatter set to '. $parameters['formatter']; } else { echo 'unknown formatter'; } die; } function e2m_note_use_alias($parameters){ $y21158=$parameters['*note']['ID']; if (!is_numeric($y21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($y21158); if (!$parameters['*note']['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } $f3e891=$parameters['newalias']; if (($b17901=vb7c3($y21158,$f3e891)) !== false){ echo 'alias set to "'. $b17901 .'"'; } else { echo 'error setting alias'; } die; } function e2m_note_edit($parameters=array ()) { return w7dd3('edit',$parameters); } function w7dd3($j60cd8,$parameters=array ()) { global$full_blog_url,$settings,$_strings,$_config; $kd5d3d=$_strings['pt--new-post']; $uf74f5=$_strings['pt--new-post']; $y21158='new'; $q9763c=$_config['default_formatter']; if ($j60cd8=='edit'){ $zea59a=$parameters['*note']; if (!$zea59a) return e2_error404_mode(); if ($zea59a){ if ($zea59a['IsPublished']) { $uf74f5=$_strings['pt--edit-post']; $m72487=$parameters['alias']; } else { $uf74f5=$_strings['pt--edit-draft']; if (@$zea59a['OriginalAlias']) { $m72487=$zea59a['OriginalAlias']; } else { $m72487=qd712('find',$zea59a['ID'],$zea59a['Title']); } } } $y21158=$zea59a['ID']; $q9763c=$zea59a['FormatterID']; $kd5d3d=vea9c($zea59a); } $a04868=y3873(); $o77b75=array(); foreach ($a04868 as $nd7df5){ $o77b75[] = htmlspecialchars($nd7df5['Keyword'],ENT_COMPAT,HSC_ENC); } $yd2e3e=array(); if ($j60cd8=='edit' and count($o77b75)) { $a04868=fa463($zea59a['ID']); foreach ($a04868 as $nd7df5){ $yd2e3e[] = htmlspecialchars($nd7df5['Keyword'],ENT_NOQUOTES,HSC_ENC); } } $bc93df=array(); foreach ($o77b75 as $nd7df5){ $dfd2ef['name']=$nd7df5; $dfd2ef['selected?']=in_array($nd7df5,$yd2e3e); $bc93df[] = $dfd2ef; } $v9dbb8=''; $yd2e3e=implode(', ',$yd2e3e); if ($yd2e3e)$v9dbb8=$yd2e3e; if ($j60cd8=='write'){ $sc50d0=$_strings['fb--save-and-preview']; } if ($j60cd8=='edit'){ if(array_key_exists('draft',$parameters)) { $sc50d0=$_strings['fb--save-and-preview']; } else { $sc50d0=$_strings['fb--save-changes']; } } $e9c28d=array(); if ($e9c28d=y8447($zea59a['FormatterID'],$zea59a['Text'],'full')) { foreach ($e9c28d as $qe3cc9){ if(is_file(PICTURES_FOLDER.$qe3cc9)) { if ($jf1210=m291d($qe3cc9)) { $s59b51[] = array ('name' => $qe3cc9,'thumb' => $jf1210); } } if(is_file(AUDIO_FOLDER.$qe3cc9)) { $s59b51[] = array ('name' => $qe3cc9,'thumb' => DEFAULTS_FOLDER.'audio.png'); } } } if ($j60cd8=='edit' and array_key_exists('draft',$parameters)) { $e3aa13=qd712('find',$zea59a['ID'],$zea59a['Title']); } $t2cb9d['title']=$kd5d3d; $t2cb9d['heading']=$uf74f5; $t2cb9d['form']='form-note'; $t2cb9d['form-note'] = array ( '.note-id' => $y21158, '.formatter-id' => $q9763c, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($full_blog_url)+1), '.old-tags-hash' => md5($v9dbb8), '.instant-publish' => 'no', '.action' => $j60cd8, 'form-action' => d83c8('e2s_note_process'), 'form-note-livesave-action' => d83c8('e2j_note_livesave'), 'form-file-upload-action' => d83c8('e2j_file_upload'), 'form-file-remove-action' => d83c8('e2j_file_remove'), 'create:edit?' => (bool) ($j60cd8=='write'), 'title' => htmlspecialchars($zea59a['Title'],ENT_COMPAT,HSC_ENC), 'tags' => $v9dbb8, 'tags-info' => $bc93df, 'text' => htmlspecialchars($zea59a['Text'],ENT_NOQUOTES,HSC_ENC), 'images' => $s59b51, 'all-tags' => $o77b75, 'stamp-formatted' => s5a2f('d.m.Y H:i:s',$zea59a['Stamp'],r0923($zea59a)), 'time' => $zea59a['IsPublished']? array ((int)$zea59a['Stamp'],r0923($zea59a)) : false, 'alias-autogenerated' => $e3aa13, 'alias' => $m72487, 'submit-text' => $sc50d0, ); if ($j60cd8=='edit'){ $t2cb9d['form-note']['delete-href']=d83c8( 'e2m_note_delete', array ('*note' => $zea59a) ); if (!array_key_exists('draft',$parameters)) { $zea59a['_']['_id']=$zea59a['ID']; $zea59a['_']['_ord']=0; $zea59a['_']['_ord_max']=0; $t2cb9d['form-note']['note']=d6791($zea59a); } } return $t2cb9d; } function e2m_write(){ return w7dd3('write'); } function e2s_note_process(){ global$_fp_error,$_strings; $y21158=ka21e(); if (!$y21158){ if($_fp_error==FP_TITLE_OR_TEXT_EMPTY){ f8a40($_strings['er--post-must-have-title-and-text'],E2E_USER_ERROR); } elseif($_fp_error==FP_NO_ID_OR_NEW){ } else { f8a40($_strings['er--error-occurred'].' ('. $_fp_error .')'); } e2_go_to(d83c8('e2m_write')); die; } $saad65=w4627($y21158); if ($saad65['IsPublished']) { e2_go_to(d83c8('e2m_note', array ('*note' => $saad65))); } else { e2_go_to(d83c8('e2m_draft', array ('*note' => $saad65))); } die; } function e2s_note_publish(){ global$settings,$_strings,$_config; $y21158=false; if(array_key_exists('note-id',$_POST)) { $y21158=$_POST['note-id']; $zea59a=w4627($y21158); $n82b30=$zea59a['OriginalAlias']; $zea59a=array ( 'ID' => $y21158, 'IsPublished' => 1, 'IsCommentable' => (int)$_config['publish_with_comments_on'], 'IsFavourite' => 0, 'Stamp' => time(), 'IP' => $_SERVER['REMOTE_ADDR'], ); $qb2c6c=na618(@$_POST['gmt-offset']); if ($qb2c6c){ $zea59a['Offset'] = (int)$qb2c6c['offset']; $zea59a['IsDST'] = (int)$qb2c6c['is_dst']; } e2_drop_caches_for_note_($y21158); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); if (baa79('Notes',$zea59a)) { if ($n82b30){ $m72487=vb7c3($y21158,$n82b30); $zea59a['OriginalAlias']=$m72487; } if ($m72487!=$n82b30){ baa79('Notes',$zea59a); } e2_go_to(d83c8('e2m_note', array ('*note' => $zea59a))); die; } else { p4930(); die; } } e2_go_to(); die; } function e2s_note_delete(){ global$settings,$_strings; $y21158=$_POST['note-id']; $cf91b2=(bool)$_POST['is-draft']; e2_drop_caches_for_note_($y21158); if ($cf91b2){ @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } else { @unlink(CACHE_FILENAME_FAVS); } if (t0738( "DELETE FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `ID` = '".((int)$y21158)."'" )) { t0738( "DELETE FROM `". $settings['db']['table_prefix']."Aliases` ". "WHERE `EntityID`=". ((int)$y21158) ); t0738( "DELETE FROM `". $settings['db']['table_prefix']."NotesKeywords` ". "WHERE `NoteID`=". ((int)$y21158) ); if ($cf91b2){ e2_go_to(d83c8('e2m_drafts')); } else { e2_go_to(); } die; } else { e2_go_to(); die; } } function e2j_note_livesave(){ die (ka21e('ajaxresult')); } function d6791($saad65,$e4dd42=array (), $w8698e=false){ global $settings, $_config, $_candy, $_current_tag, $z57de2, $ue5564, $ue9bf8, $full_blog_url, $u097cc; $vda497=e2_note_cache_filename_with_id_($saad65['_']['_id']); $se244c=null; if(CACHE_NOTES and is_file($vda497)) { $se244c=@unserialize(tcdf0($vda497)); } if(__LOG)__log('Notes: package note <'. $saad65['_']['_id'] .'>...'); $he919a=r7f78(); if(CACHE_NOTES and is_array($se244c)) { if(__LOG)__log('Notes: retrieve cached ctree'); $yc6827=$se244c; } else { if(__LOG)__log('Notes: assemle cacheable ctree...'); if(__LOG)__log('Notes: formatter ID = '. $saad65['FormatterID']); $t2bfe4=x154e($saad65['FormatterID'], @$saad65['Text'],'full'); $yc6827['title'] = q6f10(htmlspecialchars(vea9c($saad65),ENT_NOQUOTES,HSC_ENC)); $yc6827['text'] = $t2bfe4['text-final']; $yc6827['format-info'] = $t2bfe4['meta']; $yc6827['time'] = array ((int)$saad65['Stamp'],r0923($saad65)); $yc6827['last-modified'] = array ((int)$saad65['LastModified'],r0923($saad65)); $yc6827['last-ip'] = $saad65['IP']; $yc6827['published?'] = (bool)$saad65['IsPublished']; $yc6827['commentable?'] = (bool) ($saad65['IsCommentable'] && $saad65['IsPublished']); $yc6827['favourite?'] = (bool) ($saad65['IsFavourite'] && $saad65['IsPublished']); $yc6827['visible?'] = (bool) ($saad65['IsVisible'] || !$saad65['IsPublished']); if (!$yc6827['published?']) unset ($yc6827['time']); $g0dff3=hce23($saad65['ID']); $ad57ac=array(); foreach ($g0dff3 as $g865c0 => $zb19ad){ $ge4d23['name']=htmlspecialchars($zb19ad['Keyword'],ENT_NOQUOTES,HSC_ENC); $ge4d23['href']=d83c8( 'e2m_tag', TRANS_TAGS_UTF8_URLS ? array ('tag' => htmlspecialchars($zb19ad['Keyword']), ENT_NOQUOTES,HSC_ENC) : array ('tag-urlname' => $zb19ad['URLName']) ); $ad57ac[] = $ge4d23; } $yc6827['tags']=$ad57ac; $p905f7=h254f($saad65['ID']); if ($yc6827['published?']) { $yc6827['comments-count']=$p905f7; $yc6827['your-comment-href'] = ( d83c8('e2m_note_comment', array ('*note' => $saad65)) ); } $se244c=$yc6827; if(CACHE_NOTES) @v6e52($vda497,serialize($se244c)); } if ($w8698e){ if(__LOG)__log('Notes: short-track package for caching only'); if(__LOG)__log('Notes: package note done in '. round(r7f78()-$he919a,3)); return $yc6827; } if(__LOG)__log('Notes: continue with the uncacheable, '. round(r7f78()-$he919a,3) .' so far...'); $yc6827['commentable-now?']=ob387($saad65); $yc6827['can-be-commentable?']=$settings['comments']['on'] && $yc6827['published?']; if(array_key_exists('comments-count',$yc6827)) { $yc6827['comments-count-text']=e2l_get_string('gs--n-comments', array ( 'number' => $yc6827['comments-count'] )); } foreach ($yc6827['tags'] as $a8ce4b => $z9e366){ $yc6827['tags'][$a8ce4b]['current?'] = (bool) ($yc6827['tags'][$a8ce4b]['name']==$_current_tag); } $r2e88c=$saad65['IsPublished']?'e2m_note':'e2m_draft'; $yc6827['href']=d83c8($r2e88c, array ('*note' => $saad65)); if ($saad65['IsPublished']) { if ($saad65['OriginalAlias']) { $yc6827['href-original']=d83c8('e2m_note', array ('alias' => $saad65['OriginalAlias'])); } else { $y010d9=$saad65; $y010d9['__noalias!']=true; $yc6827['href-original']=d83c8('e2m_note', array ('*note' => $y010d9)); } } $yc6827['comments-link?'] = (bool) ( $saad65['IsPublished'] && ($settings['comments']['on'] && ob387($saad65) or ($yc6827['comments-count'] > 0)) && ('e2m_note'!=$_candy) ); if (oe852()) { $afe9e2=h254f($saad65['ID'],'new'); $yc6827['new-comments-count']=$afe9e2; $yc6827['new-comments-count-text']=e2l_get_string('gs--comments-n-new', array ( 'number' => $afe9e2 )); if ($saad65['IsPublished']) { if ($saad65['IsFavourite']) { $yc6827['favourite-toggle-href']=d83c8( 'e2m_note_flag_favourite', array ('*note' => $saad65,'value' => 0) ); } else { $yc6827['favourite-toggle-href']=d83c8( 'e2m_note_flag_favourite', array ('*note' => $saad65,'value' => 1) ); } } $yc6827['edit-href']=d83c8( 'e2m_note_edit', array ('*note' => $saad65) ); $c9920c=$yc6827['edit-href']; if (!$saad65['IsPublished']) { $yc6827['delete-href']=d83c8( 'e2m_note_delete', array ('*note' => $saad65) ); } } $yc6827['future?']=$saad65['Stamp'] > time(); if($settings['appearance']['show_sharing_buttons']) { $ieb769=$_config['share_to']; $j21bdd='|twitter|facebook|vkontakte|'; if (@$_config['share_to_twitter_via']) { $s8d777['twitter']['via']=$_config['share_to_twitter_via']; } if ($yc6827['format-info']['resources-detected'][0]) { $x62933=PICTURES_FOLDER.$yc6827['format-info']['resources-detected'][0]; if(is_file($x62933)) { $j21bdd.='pinterest|'; $s8d777['pinterest']['media']=$full_blog_url .'/'. $x62933; } } $yc6827['shareable?']=false; foreach(explode(',',$ieb769) as $z5a9d3){ $z5a9d3=trim($z5a9d3); if(strstr($j21bdd,'|'. $z5a9d3. '|')) { $yc6827['shareable?']=true; $yc6827['share-to'][$z5a9d3]['share?']=true; if ($s8d777[$z5a9d3]) { $yc6827['share-to'][$z5a9d3]['data']=$s8d777[$z5a9d3]; } } } } if (@is_array($e4dd42) and count($e4dd42) > 0){ foreach (array ('title','text') as $j65d3b){ $yc6827[$j65d3b]=preg_replace_callback('/<[^>]+>/isu','hel_savetag',$yc6827[$j65d3b]); foreach ($e4dd42 as $s2510c){ if ($s2510c=='-') continue; $yc6827[$j65d3b]=preg_replace('/(?<=^|\W)('.preg_quote($s2510c,'/').')(?=^$|\W)/iu','<span class="'.CSS_CLASS_HIGHLIGHT.'">$1</span>',$yc6827[$j65d3b]); } $yc6827[$j65d3b]=str_replace('</span> <span class="'.CSS_CLASS_HIGHLIGHT.'">',' ',$yc6827[$j65d3b]); $yc6827[$j65d3b]=sdae3($yc6827[$j65d3b]); } } if(array_key_exists('_',$saad65))$yc6827['_']=$saad65['_']; if(__LOG)__log('Notes: package note done in '. round(r7f78()-$he919a,3)); return $yc6827; } function w4627($lb80bb){ global$settings,$_strings; if (t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `ID` = '".$lb80bb."'" )) { $ifa816=b0d6b(); if(count($ifa816) > 0){ return $ifa816[0]; } else { return false; } } else { f8a40($_strings['er--cannot-get-post-from-db'],E2E_DATABASE_ERROR); p4930(); die; } } function qcca7($saad65,$nb4ca4,$h8f888=1){ global$settings,$_strings; $n7ffc4=($nb4ca4=='next')?'>':'<'; $q1dee8=($nb4ca4=='next')?'':'DESC '; if (!oe852()) { $d91d12=' AND `IsVisible`=1'; } if (t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=". $h8f888 ." AND `Stamp` ".$n7ffc4." '".$saad65['Stamp']."'".@$d91d12." ". "ORDER BY STAMP ".$q1dee8. "LIMIT 1" )) { $ifa816=b0d6b(); if(count($ifa816) > 0) return $ifa816[0]; else return FALSE; } else { f8a40($_strings['er--cannot-get-post-from-db'],E2E_DATABASE_ERROR); p4930(); die; } } function vea9c($saad65){ if ($saad65['Title']) { return $saad65['Title']; } else { return '#'. $saad65['ID']; } } function m50d7($ed5566,$i71860=1){ global$settings,$_config; $ib01a5=$ed5566; $r8b7af='all'; if ('rss'==$ed5566 or !oe852()) { $n25715="AND `IsVisible`=1 "; $r8b7af='visible'; } if ('web'==$ed5566)$ib01a5.='_'.$r8b7af; if ('web'==$ed5566){ $e19ee4=($i71860-1)*$settings['appearance']['notes_per_page']; $maa9f7=$e19ee4 .', '. $settings['appearance']['notes_per_page']; } if ('rss'==$ed5566){ $maa9f7=$_config['rss_items']; } if (t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 " .@$n25715. "ORDER BY `Stamp` DESC ". "LIMIT ". $maa9f7 )) { $result=b0d6b(); return$result; } else { return false; } } function f82dc($g41529,$k6f8f5){ global$settings; list ($hfc6b2,$z10df4)=f5273($g41529,$k6f8f5); if (!oe852())$ff79b1="`IsVisible`=1 AND "; if (t0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND " .@$ff79b1. "`Stamp` BETWEEN '". $hfc6b2 ."' AND '". $z10df4 ."'" )) { $result=b0d6b(); $o44fde=array(); foreach($result as $y65afd){ if ( ((int)$g41529) .'/'. ((int)$k6f8f5) == s5a2f('Y/n',$y65afd['Stamp'],r0923($y65afd)) ) { $o44fde[] = (int)s5a2f('j',$y65afd['Stamp'],r0923($y65afd)); } } $o44fde=@array_unique($o44fde); sort($o44fde); return $o44fde; } else { return false; } } function ob92c($g41529){ global$settings; list ($y5a603,$vc2b31)=f5273($g41529); if (!oe852())$ff79b1="`IsVisible`=1 AND "; if (t0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND ". @$ff79b1. "`Stamp` BETWEEN '". $y5a603. "' AND '". $vc2b31 ."'" )) { $result=b0d6b(); $zda36c=array(); foreach($result as $y65afd){ if ( ((int)$g41529) == s5a2f('Y',$y65afd['Stamp'],r0923($y65afd)) ) { $zda36c[] = (int)s5a2f('n',$y65afd['Stamp'],r0923($y65afd)); } } $zda36c=@array_unique($zda36c); sort($zda36c); return $zda36c; } else { return false; } } function kd864($s8d777){ global$settings,$i71860,$_strings; $b7694f=$s8d777['query']; if (isset ($s8d777['page']) and $s8d777['page'] < 1) return e2_error404_mode(); $xd7e5d=$settings['appearance']['notes_per_page']; $gb3b32=array(); $mfbb44=false; if (isset ($s8d777['page'])) { $i71860=$s8d777['page']; $b7694f.=' LIMIT '.($s8d777['page']-1)*$xd7e5d.', '.$xd7e5d; $x61e23=str_replace('SELECT *','SELECT count(*)',$s8d777['query']); if (t0738($x61e23)) { $result=b0d6b(); $mfbb44=$result[0]['count(*)']; $xae0fe=ceil($mfbb44/$xd7e5d); if ($i71860 > $xae0fe and $i71860!=1){ return e2_error404_mode(); } $gb3b32['count']=$xae0fe; $gb3b32['this']=$i71860; $gb3b32['timeline?']=true; $gb3b32['earlier-title']=$_strings['gs--earlier']; $gb3b32['later-title']=$_strings['gs--later']; $p920fa=$s8d777['parameters']; if ($i71860 < $xae0fe){ $p920fa['page']=$i71860+1; $gb3b32['earlier-href']=d83c8($s8d777['candy'],$p920fa); } if ($i71860 > 1){ $p920fa['page']=$i71860-1; $gb3b32['later-href']=d83c8($s8d777['candy'],$p920fa); } } else { return array (); } } $g4358b=array(); if (t0738($b7694f)) { $result=$he5b87=b0d6b(); if (@$s8d777['query-returns-only-ids']) { $result=array(); foreach ($he5b87 as $saad65){ $saad65=w4627($saad65['ID']); if ($saad65['IsPublished'] and ($saad65['IsVisible'] or oe852())) { $result[] = $saad65; } } } foreach($result as $a8ce4b => $saad65){ $saad65['_']['_id']=$saad65['ID']; $saad65['_']['_ord']=k; $saad65['_']['_ord_max']=count($result)-1; $g4358b[] = d6791($saad65,$s8d777['highlight']); } } else { return array (); } $m05a16=$g4358b; if (!isset ($s8d777['show-all-notes']) or @$s8d777['show-all-notes']!=true){ $m05a16=array_slice($g4358b,0,$xd7e5d); } if ($mfbb44===false)$mfbb44=count($m05a16); if (!count($g4358b) and array_key_exists('no-notes-text',$s8d777)) { $t2cb9d['no-notes-text']=$s8d777['no-notes-text']; } $fcd0fd=array ( 'class', 'superheading', 'heading', 'title', 'search-related-tag', 'related-rss-href', ); foreach ($fcd0fd as $qf97bf){ if(array_key_exists($qf97bf,$s8d777)) { $t2cb9d[$qf97bf]=$s8d777[$qf97bf]; } } if ($mfbb44){ $y5cde2=e2l_get_string( 'pt--n-posts', array ('number' => $mfbb44) ); } else { $y5cde2=$_strings['pt--no-posts']; } if(array_key_exists('maximum-notes',$s8d777) and $mfbb44 >= $s8d777['maximum-notes']) { $y5cde2=$_strings['gs--many-posts']; } foreach (array ('title','heading','superheading') as $s4b24c){ if(strstr($s8d777[$s4b24c],'%total%')) { $t2cb9d[$s4b24c]=str_replace('%total%', $y5cde2,$s8d777[$s4b24c]); } } $t2cb9d['notes']=$m05a16; $t2cb9d['pages']=$gb3b32; return $t2cb9d; } function kf9fb($g41529,$k6f8f5,$e8277e=false){ global$settings; list ($l7b314,$ja1f20)=f5273($g41529,$k6f8f5,$e8277e); if (t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished` AND (`Stamp` BETWEEN " .$l7b314. " AND " .$ja1f20. ")". "ORDER BY Stamp" )) { $result=b0d6b(); $rb1bc2=1; $t2cb9d=array(); foreach($result as $y65afd){ if(is_numeric($e8277e)) { $c3f917=((int)$g41529) .'/'. ((int)$k6f8f5) .'/'. ((int)$e8277e) == s5a2f('Y/n/j',$y65afd['Stamp'],r0923($y65afd)); } elseif(is_numeric($k6f8f5)) { $c3f917=((int)$g41529) .'/'. ((int)$k6f8f5) == s5a2f('Y/n',$y65afd['Stamp'],r0923($y65afd)); } else { $c3f917=((int)$g41529) == s5a2f('Y',$y65afd['Stamp'],r0923($y65afd)); } if ($c3f917){ if(is_numeric($e8277e)) { $y65afd['day_number']=$rb1bc2; } $t2cb9d[] = $y65afd; $rb1bc2 ++; } } return $t2cb9d; } else { return false; } } function e2_published_noterec_with_alias_($m72487){ global$settings; if ($kc45dd=e2_aliasrec_of_alias_($m72487)) { $saad65=w4627($kc45dd['EntityID']); if ($saad65['IsPublished']) return $saad65; } } function e2_published_noterec_with_parameters_($parameters=array ()) { global$settings; $q39a37=e2_noterec_with_parameters_($parameters); if ($q39a37['IsPublished']) return $q39a37; } function e2_noterec_with_parameters_($parameters=array ()) { global$settings; $saad65=false; $rb5445=false; if (@$parameters['oalias']) $rb5445=$parameters['oalias']; if ($rb5445){ if (t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `OriginalAlias` = '". $rb5445 ."' ". "AND `IsPublished` = 0" )) { $saad65=b0d6b(); if(count($saad65)==1) { $saad65=@$saad65[0]; if ($saad65) return $saad65; } } } $k67e85=false; if (@$parameters['draft']) $k67e85=$parameters['draft']; if (@$parameters['draft2'])$k67e85=$parameters['draft2']; if ($k67e85){ $saad65=w4627($k67e85); return $saad65; } if (@$parameters['alias']) { if ($kc45dd=e2_aliasrec_of_alias_(@$parameters['alias'])) { $saad65=w4627($kc45dd['EntityID']); if ($saad65['IsPublished']) return $saad65; } } $ic2d18=kf9fb($parameters['year'],$parameters['month'],$parameters['day']); if (@$ic2d18[$parameters['day-number']-1]) { return $ic2d18[$parameters['day-number']-1]; } } function qe56b($kd5d3d,$x1cb25,$qb2c6c=false){ global$_config; ie2f1(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); $q39a37=array ( 'Title' => e7928($kd5d3d), 'Text' => e7928($x1cb25), 'FormatterID' => $_config['default_formatter'], 'Stamp' => (int)time(), 'LastModified' => (int)time(), 'IP' => e7928($p957b5), 'OriginalAlias' => qd712('find','',$kd5d3d), ); if ($qb2c6c and is_array($qb2c6c)) { $q39a37['Offset'] = (int)$qb2c6c['offset']; $q39a37['IsDST'] = (int)$qb2c6c['is_dst']; } if (($q39a37=m9943('Notes',$q39a37)) !== false){ return $q39a37['ID']; } } function ka21e($f98ea6=''){ global$settings,$_fp_error,$_config,$_e2utf8__unformat_htmlentity_neasden; $_fp_error=false; $y21158=$kd5d3d=$ad57ac=$x1cb25=$pb4960=''; if(array_key_exists('note-id',$_POST)) $y21158=$_POST['note-id']; if(array_key_exists('title',$_POST)) $kd5d3d=trim($_POST['title']); if(array_key_exists('tags',$_POST)) $ad57ac=$_POST['tags']; if(array_key_exists('text',$_POST)) $x1cb25=trim($_POST['text'],"\r\n"); if(array_key_exists('old-tags-hash',$_POST)) $pb4960=$_POST['old-tags-hash']; if(is_array($ad57ac))$ad57ac=implode(', ',$ad57ac); $ad57ac=trim($ad57ac); if ($y21158=='new'){ $_e2utf8__unformat_htmlentity_neasden=($_config['default_formatter']=='neasden'); } else { $_e2utf8__unformat_htmlentity_neasden=($_POST['formatter-id']=='neasden'); } $uffa71=$x1cb25; $uffa71=str_replace("\n",'\n'."\n",$uffa71); $uffa71=str_replace("\r",'\r'."\r",$uffa71); if(__LOG)__log('e2fp_note: Text is ['. $uffa71 .'] ('. strlen($x1cb25) .'b)'); $na6168=r163d(',',$ad57ac,'sort'); $ad57ac=implode(', ',$na6168); $o65f31=md5($ad57ac); if(array_key_exists('browser-offset',$_POST)) { $qb2c6c=na618(@$_POST['browser-offset']); } else { $qb2c6c=false; } $zd17d3='/^ *(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4}) +(\d{1,2})\:(\d{1,2})\:(\d{1,2}) *$/'; $b02b37=@$_POST['old-stamp']; $naddfe=@$_POST['stamp']; $m72487=@$_POST['alias']; if ($y21158!='new'){ $q39a37=w4627($y21158); } else { $q39a37=array(); } if ($y21158){ if ($kd5d3d!='' and $x1cb25!=''){ if ($y21158=='new'){ if ($y21158=qe56b($kd5d3d,$x1cb25,$qb2c6c)) { $xc852f=d83c8('e2m_note_edit', array ( '*note' => w4627($y21158), )); $k1fa03='{'. '"status": "created", '. '"id": "'. $y21158 .'", '. '"new-full-url": "'. $xc852f . '"}'; $result=(int)$y21158; } else { $k1fa03='{"status": "error", "message": "Cannot create record ('. mysql_error(). ')"}'; $result=false; } } else { e2_drop_caches_for_note_($y21158); if (!$q39a37['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } $zea59a=array ( 'ID' => $y21158, 'Title' => $kd5d3d, 'Text' => $x1cb25, 'LastModified' => time(), ); if(0){ if ($qb2c6c and is_array($qb2c6c)) { $zea59a['Offset'] = (int)$qb2c6c['offset']; $zea59a['IsDST'] = (int)$qb2c6c['is_dst']; } } if ($b02b37!=$naddfe){ if(preg_match($zd17d3,$naddfe,$k6f8f5)) { $a96b8c=gmmktime($k6f8f5[4],$k6f8f5[5],$k6f8f5[6],$k6f8f5[2],$k6f8f5[1],$k6f8f5[3]); $a96b8c -= wb2bf($qb2c6c,$a96b8c); $zea59a['Stamp']=$a96b8c; } else { unset ($a96b8c); } } $b17901=$m72487; if ($m72487){ $xa7ff0=$m72487; } elseif (!$q39a37['IsPublished']) { $xa7ff0=$kd5d3d; } else { $xa7ff0=''; } if ($q39a37['IsPublished']) { $b17901=vb7c3($y21158,$xa7ff0); $xc852f=d83c8('e2m_note_edit', array ( '*note' => $zea59a, 'alias' => $b17901, )); } else { $m926c6=true; $b17901=qd712('find',$y21158,$xa7ff0); $zea59a['OriginalAlias']=$b17901; $xc852f=d83c8('e2m_note_edit', array ( 'draft' => $y21158, 'is-published' => 0, 'oalias' => $b17901, )); } if (baa79('Notes',$zea59a)) { $k1fa03='{'. '"status": "saved", '. '"new-alias": "'. $b17901 .'", '. '"new-full-url": "'. $xc852f .'"'. '}'; $result=(int)$y21158; } else { $k1fa03='{"status": "error", "message": "Cannot update record ('. mysql_error(). ')"}'; $result=false; }; } if ($o65f31!=$pb4960){ u93c2(array ('NoteID' => $y21158)); foreach ($na6168 as $ge4d23){ $v70b77=d0188($ge4d23); if (!$v70b77){ $kd7ca3=rec0d($ge4d23); $v70b77['ID']=k478d($ge4d23,$kd7ca3,0,'',0); } t0738( "INSERT INTO `". $settings['db']['table_prefix']."NotesKeywords` ". "(`NoteID`, `KeywordID`) ". "VALUES (". ((int)$y21158) .", ". ((int)$v70b77['ID']). ")" ); } } if ( $f98ea6!='ajaxresult' and $result and $_POST['instant-publish']=='yes' ){ $_POST['note-id']=$y21158; e2s_note_publish(); } } else { $k1fa03='{"status":"error", "message": "Title or text is empty"}'; $_fp_error=FP_TITLE_OR_TEXT_EMPTY; $result=false; } } else { $k1fa03='{"status":"error", "message": "No note id/new specified"}'; $_fp_error=FP_NO_ID_OR_NEW; $result=false; } xcc38(d83c8('e2s_dump', array ())); if ($f98ea6=='ajaxresult') return $k1fa03; else return$result; } function rcc02($k92c58){ global$settings; $r8b7af='p1'; if (!oe852()) { $r8b7af='p1v1'; $ff79b1="AND `IsVisible`=1"; } $qd29bb=CACHES_FOLDER.$k92c58 .'-stamp-'. $r8b7af .'.e2time.psa'; if(CACHE_EDGE_TIMEINFO and is_file($qd29bb)) { $result=@unserialize(tcdf0($qd29bb)); } if(is_array($result)) { return$result; } else { if ($k92c58=='start'){ t0738( "SELECT Stamp, Offset, IsDST FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 ". $ff79b1 ." ORDER BY Stamp LIMIT 1" ); } elseif ($k92c58=='end'){ t0738( "SELECT Stamp, Offset, IsDST FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 ". $ff79b1 ." ORDER BY Stamp DESC LIMIT 1" ); } $result=b0d6b(); if(count($result)) { $result=array ( 'stamp' => $result[0]['Stamp'], 'timezone' => r0923($result[0]), ); if(CACHE_EDGE_TIMEINFO)v6e52($qd29bb,serialize($result)); return$result; } else { return array (); } } } function d8ca0($a1653c,$l0604c){ global$settings; if (!($a1653c and $l0604c) and !oe852()) { die ('API MISUSE: e2_notes_count_general cannot be called for invisible notes or drafts unsecurely :-('); } if (!is_bool($a1653c) or !is_bool($l0604c)) { die ('API MISUSE: e2_notes_count_general must be called with bool params :-('); } if (!$a1653c and !$l0604c){ die ('API MISUSE: e2_notes_count_general called with nonsensical parameters'); } $qd29bb=CACHES_FOLDER . 'notes-count-p'. (int)$a1653c . ($a1653c ? ('v'. (int)$l0604c):'') . '.txt'; $result=false; if(CACHE_NOTES_COUNTS and is_file($qd29bb)) { $result=@tcdf0($qd29bb); } if(is_numeric($result) and $result > 0){ return$result; } else { t0738( "SELECT COUNT(*) As NotesCount FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=". (int)$a1653c. " ". ($a1653c ? ( "AND   `IsVisible`=". (int)$l0604c ):"") ); $result=b0d6b(); $result=$result[0]['NotesCount']; if($result){ if(CACHE_NOTES_COUNTS)v6e52($qd29bb,$result); return$result; } else { return null; } } } function l5421($x1cb25){ $ya80da=$x1cb25; $ya80da=str_replace(array ( '<p>','<blockquote>','<ul>','<ol>','<br />', ), "\n",$ya80da); $ya80da=trim(strip_tags($ya80da)); if(strpos($ya80da,"\n")!==false){ $ya80da=substr($ya80da,0,strpos($ya80da,"\n")); $ya80da=trim($ya80da,' :.()'."\n"); } if(preg_match('/^(.{100,}?)[:.!?()]|'."\n".'/s',$ya80da,$e9c28d)) { $ya80da=trim($e9c28d[0],' :.()'."\n"); } if(preg_match('/^(.{150,}?)[:.!?(),]/s',$ya80da,$e9c28d)) { $ya80da=trim($e9c28d[0],' :.()'."\n"); } if(preg_match('/^(.{200,}?)[:.!?(), ]/s',$ya80da,$e9c28d)) { $ya80da=trim($e9c28d[0],' :.()'."\n"); } if(in_array($ya80da[strlen($ya80da)-1], array (',',' '))) { $ya80da=trim($ya80da,', '). '...'; } if(mb_strlen($ya80da) > 250){ $ya80da=mb_substr($ya80da,0,250). '...'; } return $ya80da; } define('DRAFT_PREVIEW_LENGTH',100); function e2m_drafts(){ global$_strings,$settings; if(__LOG)__log('Drafts list: working...'); $vda3ad='LastModified'; $rda48a=null; if(CACHE_DRAFTS and is_file(CACHE_FILENAME_DRAFTS)) { $rda48a=@unserialize(tcdf0(CACHE_FILENAME_DRAFTS)); } if(CACHE_DRAFTS and is_array($rda48a)) { if(__LOG)__log('Drafts list: retrieve cached ctree'); } else { if(__LOG)__log('Drafts list: assemle cacheable ctree...'); $rda48a=array(); if(__LOG)__log('Drafts list: select by '. $vda3ad .'...'); if (t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=0 ". "ORDER BY `". $vda3ad ."` DESC" )) { $result=b0d6b(); $g4358b=array(); foreach($result as $a8ce4b => $q39a37){ $saad65['_']['_id']=$q39a37['ID']; $saad65['_']['_ord']=k; $saad65['_']['_ord_max']=count($result)-1; $saad65['href']=d83c8('e2m_draft', array ('*note' => $q39a37)); $saad65['title']=q6f10(htmlspecialchars(vea9c($q39a37),ENT_NOQUOTES,HSC_ENC)); if (isset ($saad65['image-href'])) unset ($saad65['image-href']); $q39a37['_']['_id']=$q39a37['ID']; $q39a37['_']['_ord']=0; $q39a37['_']['_ord_max']=0; $r8e4cd=d6791($q39a37, array (), true); $e9c28d=null; if ($q39a37['FormatterID']=='neasden'){ $e9c28d=$r8e4cd['format-info']['resources-detected']; } elseif ($q39a37['FormatterID']=='calliope'){ $e9c28d=y8447( $q39a37['FormatterID'],$q39a37['Text'],'full' ); } if ($e9c28d){ $qe3cc9=array_shift($e9c28d); if(is_file(PICTURES_FOLDER.$qe3cc9)) { if ($jf1210=m291d($qe3cc9)) { $saad65['image-href']=$jf1210; } } } $saad65['text-fragment']=strip_tags($r8e4cd['text']); $o2ab2d=false; if(mb_strlen($saad65['text-fragment']) > DRAFT_PREVIEW_LENGTH) { $o2ab2d=mb_strpos($saad65['text-fragment'],'.',DRAFT_PREVIEW_LENGTH); } if ($o2ab2d!==false){ $saad65['text-fragment']=mb_substr($saad65['text-fragment'],0,$o2ab2d+1); } $rda48a[] = $saad65; } if(CACHE_DRAFTS)v6e52(CACHE_FILENAME_DRAFTS,serialize($rda48a)); } } if(__LOG)__log('Drafts list: done'); return array ( 'title' => $_strings['pt--drafts'], 'heading' => $_strings['pt--drafts'], 'drafts' => $rda48a, ); } function e2m_draft($parameters=array ()) { global$_strings,$z57de2,$settings; $saad65=e2_noterec_with_parameters_($parameters); if (!$saad65){ $parameters['alias']=$parameters['oalias']; unset($parameters['oalias']); $saad65=e2_noterec_with_parameters_($parameters); if ($saad65){ $nd58c0=d83c8('e2m_note', array ('*note' => $saad65)); return e2_go_to($nd58c0); } } if (!$saad65) return e2_error404_mode(); $saad65['_']['_id']=$saad65['ID']; $saad65['_']['_ord']=0; $saad65['_']['_ord_max']=0; $r8e4cd=d6791($saad65); $q45513=array ( '.note-id' => $saad65['ID'], 'form-action' => d83c8('e2s_note_publish'), 'submit-text' => $_strings['fb--publish-draft'], ); return array ( 'title' => vea9c($saad65).' ('. $_strings['wd--draft'] .')', 'notes' => array ('only' => $r8e4cd), 'form' => 'form-note-publish', 'form-note-publish' => $q45513, ); } function e2_draft_alias_use_count($v176fe=''){ global$settings; if(__LOG)__log('Drafts: find duplicate OriginalAliases...'); if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_file(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)) { $jda552=@unserialize(tcdf0(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)); } if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_array($jda552)) { if(__LOG)__log('Drafts: retrieve cached'); } else { if(__LOG)__log('Drafts: assemle cacheable...'); $jda552=array(); if (t0738( "SELECT `OriginalAlias` FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=0 ". "ORDER BY `ID`" )) { $result=b0d6b(); $g4358b=array(); foreach($result as $a8ce4b => $q39a37){ @$jda552[$q39a37['OriginalAlias']] ++; } } if(CACHE_DRAFTS_ALIAS_USE_COUNTS){ v6e52(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS,serialize($jda552)); } } if ($v176fe){ return $jda552[$v176fe]; } else { return $jda552; } } $_url_map=array ( '@build' => 'e2://e2s_build', '@sync' => 'e2://e2s_sync', '@dump' => 'e2://e2s_dump', '@instantiate:version' => 'e2://e2s_instantiate', '@info' => 'e2://e2m_info', '@scale-image:picture' => 'e2://e2s_scale_image', '@ajax/::' => 'e2://e2j_::', '@actions/::' => 'e2://e2s_::', '' => 'e2://e2m_frontpage?page=1', ':page' => 'e2://e2m_frontpage', 'rss' => 'e2://e2m_frontpage_rss', ':year' => 'e2://e2m_year', ':year/:month' => 'e2://e2m_month', ':year/:month/:day' => 'e2://e2m_day', 'all' => 'e2://e2m_everything', ':note' => 'e2://e2m_note', ':note/comment' => 'e2://e2m_note_comment', ':note/edit' => 'e2://e2m_note_edit?is_published=1', ':note/favourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=1', ':note/unfavourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=0', ':note/show' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=1', ':note/hide' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=0', ':note/discuss' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=1', ':note/quiet' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=0', ':note/withdraw' => 'e2://e2m_note_withdraw?is_published=1', ':note/delete' => 'e2://e2m_note_delete?is_published=1', ':note/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=1', ':note/alias' => 'e2://e2m_note_use_alias?is_published=1&newalias=', ':note/alias/:alias' => 'e2://e2m_note_use_alias?is_published=1', ':note/:unsubscr' => 'e2://e2m_unsubscribe?is_published=1', ':note/hitinfo' => 'e2://e2m_note_hitinfo?is_published=1', ':note/comments-rss' => 'e2://e2m_note_comments_rss', ':note/:comnum' => 'e2://e2m_comment', ':note/:comnum/edit' => 'e2://e2m_comment_edit', ':note/:comnum/important' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=1', ':note/:comnum/usual' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=0', ':note/:comnum/replace' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=1', ':note/:comnum/remove' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=0', ':note/:comnum/spam' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=1', ':note/:comnum/good' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=0', ':note/:comnum/wipe' => 'e2://e2m_comment_delete', ':note/:comnum/reply/edit' => 'e2://e2m_comment_reply', ':note/:comnum/reply/important' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=1', ':note/:comnum/reply/usual' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=0', ':note/:comnum/reply/replace' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=1', ':note/:comnum/reply/remove' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=0', ':note/:comnum/reply/delete' => 'e2://e2m_comment_reply_delete', 'drafts' => 'e2://e2m_drafts', 'drafts/:draft' => 'e2://e2m_draft', 'drafts/:draft/edit' => 'e2://e2m_note_edit?is_published=0', 'drafts/:draft/show' => 'e2://e2m_note_flag?is_published=0&flag=IsVisible&value=1', 'drafts/:draft/hide' => 'e2://e2m_note_flag?is_published=0&flag=IsVisible&value=0', 'drafts/:draft/delete' => 'e2://e2m_note_delete?is_published=0', 'drafts/:draft/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=0', 'tags' => 'e2://e2m_tags', 'tags/:tag' => 'e2://e2m_tag?page=1', 'tags/:tag/:page' => 'e2://e2m_tag', 'tags/:tag/rss' => 'e2://e2m_tag_rss', 'tags/:tag/edit' => 'e2://e2m_tag_edit', 'tags/:tag/delete' => 'e2://e2m_tag_delete', 'tags/:tag/pin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=1', 'tags/:tag/unpin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=0', 'untagged' => 'e2://e2m_untagged', 'hot' => 'e2://e2m_most_commented', 'selected' => 'e2://e2m_favourites?page=1', 'selected/:page' => 'e2://e2m_favourites', 'found' => 'e2://e2m_found&query=', 'found/:query' => 'e2://e2m_found', 'found/:query/rss' => 'e2://e2m_found_rss', 'new' => 'e2://e2m_write', 'install' => 'e2://e2m_install', 'settings' => 'e2://e2m_settings', 'settings/name' => 'e2://e2m_name_and_author', 'settings/database' => 'e2://e2m_database', 'settings/password' => 'e2://e2m_password', 'settings/timezone' => 'e2://e2m_timezone', 'settings/sessions' => 'e2://e2m_sessions', 'sign-in' => 'e2://e2m_sign_in', 'sign-out' => 'e2://e2m_sign_out', ); $_url_chunks=array ( '\:page' => 'page\-(?P<page>\d+)', '\:year' => '(?P<year>\d{4})', '\:month' => '(?P<month>\d{1,2})', '\:day' => '(?P<day>\d{1,2})', '\:note' => array ( 'all\/(?P<alias>[-a-zA-Z0-9]+)', '(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)', ), '\:draft' => array ( '(?P<oalias2>[-a-zA-Z0-9]+)\/(?P<draft2>\d+)', '(?P<oalias>[-a-zA-Z0-9]+)', '-\/(?P<draft>\d+)', ), '\:comnum' => 'comment\-(?P<comment_number>[0-9]+)', '\:file' => '(?P<file>.*?)', '\:tag' => TRANS_TAGS_UTF8_URLS? '(?P<tag>.*?)':'(?P<tag_urlname>.*?)', '\:query' => '(?P<query>.*?)', '\:version' => '\:(?P<version>\d+)', '\:picture' => '\:(?P<picture>.*?)', '\:unsubscr' => 'unsubscribe\:(?P<unsubscribe_email>.+?)\:(?P<unsubscribe_key>[0-9a-f]{32})', '\:formatter' => '(?P<formatter>.*?)', '\:alias' => '(?P<newalias>.*?)', ); $_url_autoredirects=array ( '/^favo(?:u?)rites(\~.+)?$/i' => 'selected\\1', '/^favo(?:u?)rites\/(.+)/i' => 'selected/\\1', '/^keywords$/i' => 'tags', '/^keywords\/(.*)/i' => 'tags/\\1', '/^everything$/i' => 'all', '/^no\-tags(\~.+)?$/i' => '@untagged\\1', '/^no\-tags\/(.+)/i' => '@untagged/\\1', '/^untagged(\~.+)?$/i' => '@untagged\\1', '/^search\/(.+)/i' => 'found/\\1', '/^(\d{4}\/\d{1,2}\/\d{1,2}\/\d+)\/comments(\/?)$/i' => '\\1', '/^\~(\d+)/i' => 'page-\\1', '/\/?\~(\d+)/i' => '/page-\\1', ); function lb6b0($t572d4){ global$_url_autoredirects,$va57c1; $t572d4=preg_replace(array_keys($_url_autoredirects),array_values($_url_autoredirects),$t572d4); if(preg_match('/^([0-9]+)[.-]([0-9]+)[.-]([0-9]+)(.*)/',$t572d4,$e9c28d)) { if(2==strlen($e9c28d[3]))$e9c28d[3]='20'.$e9c28d[3]; return ($e9c28d[3].'/'.$e9c28d[2].'/'.$e9c28d[1].$e9c28d[4]); } if(preg_match('/^tags\-rss\/(.*?)\/?$/',$t572d4,$e9c28d)) { $ge4d23=substr($e9c28d[1],strrpos($e9c28d[1],'/')+1); return ('tags/'. $ge4d23.'/rss/'); } return $t572d4; } function h7059(){ global$__synthetic_urls,$_config; $__synthetic_urls=false; if($_config['url_composition']=='auto'){ if(function_exists('apache_get_modules')) { if(in_array('mod_rewrite',apache_get_modules())) { $__synthetic_urls=true; } } } if($_config['url_composition']=='synthetic'){ $__synthetic_urls=true; } } function d83c8($xc48ba,$parameters=array ()) { global$_url_map,$_url_chunks,$_config,$__synthetic_urls,$_protocol,$z57de2,$va57c1; $sc2bd7=array_flip($_url_map); if ( @$_config['preferred_domain_name'] and $_SERVER['HTTP_HOST']!=$_config['preferred_domain_name'] ) { $z57de2=$_config['preferred_domain_name']; } $t572d4=$_protocol .'://'. $z57de2.$va57c1 .'/'; $l9c464='e2://'. $xc48ba; if(array_key_exists('page',$parameters)) { $i71860=$parameters['page']; } else { $i71860=1; } if($parameters){ $l9c464.='?'; $p1c61f=array(); $d21711=array(); foreach($parameters as $u3c6e0 => $e2063c){ if ($u3c6e0=='*note'){ $d21711[] = $u3c6e0; $p1c61f[] = e2urls__expand_tricky_parameters_for_note_($e2063c); } } foreach ($d21711 as $u3c6e0) unset($parameters[$u3c6e0]); foreach ($p1c61f as $u58e2a){ $parameters=array_merge($parameters,$u58e2a); } foreach($parameters as $u3c6e0 => $e2063c) if (!@$u3c6e0[0]=='_'){ if(array_key_exists('\:'. $u3c6e0,$_url_chunks)) { $s93316=$_url_chunks['\:'. $u3c6e0]; if(preg_match_all('/\<(.*?)\>/',$s93316,$e9c28d)) { foreach ($e9c28d[1] as $qe3cc9){ if(array_key_exists($qe3cc9,$parameters)) { $l9c464.=$qe3cc9 .'='. urlencode($parameters[$qe3cc9]) .'&'; } } } } else { $l9c464.=$u3c6e0 .'='. urlencode($e2063c) .'&'; } } $l9c464=substr($l9c464,0, -1); } if(0 and array_key_exists($l9c464,$sc2bd7)) { if ($sc2bd7[$l9c464]!='')$t572d4.=$sc2bd7[$l9c464] .'/'; return $t572d4; } else { $o44907=false; foreach ($sc2bd7 as $h45ea8 => $h9ea44){ $ob7365=$h45ea8; $ob7365=preg_quote($ob7365,'/'); if(strstr($h45ea8,'::')) { $ob7365=str_replace('\:\:','(.*)',$ob7365); $ob7365='/^'. $ob7365 .'$/s'; if(preg_match($ob7365,$l9c464,$e9c28d)) { $j0dc02=str_replace('_','-',$e9c28d[1]); $u95a17=str_replace('::',$j0dc02,$h9ea44); if($__synthetic_urls){ $t572d4.=$u95a17 .'/'; } else { $t572d4.='?go='. $u95a17 .'/'; } return $t572d4; } } $lebe09=parse_url($h45ea8); $g2f532=$lebe09['host']; $h54435=false; if ($xc48ba==$g2f532){ $o44907=true; if ($lebe09['query']) { $h22c38=explode('&',$lebe09['query']); foreach ($h22c38 as $q8822b){ list ($u3c6e0,$e2063c)=explode('=',$q8822b); $e2063c=urldecode($e2063c); $u3c6e0=str_replace('_','-',$u3c6e0); if ( array_key_exists($u3c6e0,$parameters) and $parameters[$u3c6e0]!=$e2063c ){ $h54435=true; break; } } } if (!$h54435){ if(preg_match_all('/\:[\-a-z]+/i',$h9ea44,$e9c28d)) { foreach ($e9c28d[0] as $rfc413){ $ab0f75=$_url_chunks['\\'. $rfc413]; if (!is_array($ab0f75)) { $ab0f75=array ($ab0f75); } $q05f62=$ab0f75[0]; foreach ($ab0f75 as $q05f62){ $heab03='/\(\?P\<(.*?)\>.*?\)/e'; $a4274e=true; if (@preg_match($heab03,$q05f62,$e9c28d)) { $a4274e=true; for ($g865c0=1; $g865c0 < count($e9c28d); ++ $g865c0){ if (!$parameters[str_replace("_","-",$e9c28d[$g865c0])]) { $a4274e=false; break; } } } if (!$a4274e) continue; $cf9e1e=@preg_replace( $heab03,'$parameters[str_replace ("_", "-", "\\1")]',$q05f62 ); $cf9e1e=stripslashes($cf9e1e); $dc5d91=str_replace($rfc413,$cf9e1e,$h9ea44); break; } $h9ea44=$dc5d91; } } $s15214=array(); if ($h9ea44){ if($__synthetic_urls){ $t572d4.=$h9ea44 .'/'; } else { $s15214[] = 'go='. $h9ea44 .'/'; } } foreach($_GET as $a8ce4b => $z9e366) if(in_array($a8ce4b, array ('result','themeless'))) { $s15214[] = $a8ce4b . ($z9e366? ('='. urlencode($z9e366)) : ''); } if(count($s15214)) { $t572d4.='?'. implode('&',$s15214); } return $t572d4; } } } if ($o44907){ return $t572d4; } else { die ('Cannot compose url for candy '. $xc48ba); } } } function fb7e9($t572d4){ global$_url_map,$_url_chunks,$_config,$__synthetic_urls,$_protocol,$z57de2,$va57c1; $m196c2=$t572d4; $t572d4=trim($t572d4,'/'); $t572d4=lb6b0($t572d4); $parameters=array(); foreach($_url_map as $r12a24 => $h45ea8){ $id532d=$r12a24; $id532d=preg_quote($id532d,'/'); if(strstr($r12a24,'::')) { $id532d=str_replace('\:\:','(.*)',$id532d); $id532d='/^'. $id532d .'$/s'; if(preg_match($id532d,$t572d4,$e9c28d)) { $h53b9e=str_replace('-','_',$e9c28d[1]); $l9c464=str_replace('::',$h53b9e,$h45ea8); } } elseif(strstr($r12a24,':')) { $o1e380=array(); foreach($_url_chunks as $a8ce4b => $z9e366){ if(is_array($z9e366)) { $o1e380[$a8ce4b]='(?:(?:'. implode(')|(?:',$z9e366) .'))'; } else { $o1e380[$a8ce4b]=$z9e366; } } $id532d=str_replace( array_keys($o1e380), array_values($o1e380), $id532d ); $id532d='/^'. $id532d .'$/s'; if(preg_match($id532d,$t572d4,$e9c28d)) { $l9c464=$h45ea8; foreach ($e9c28d as $u3c6e0 => $e2063c) if (!is_numeric($u3c6e0)) { $u3c6e0=str_replace('_','-',$u3c6e0); $parameters[$u3c6e0]=$e2063c; } } } else { if ($r12a24==$t572d4){ $l9c464=$h45ea8; break; } } } $afafdd=(bool)$l9c464; if (!$l9c464)$l9c464='e2://e2m_404'; $lebe09=parse_url($l9c464); $xc48ba=$lebe09['host']; if ($lebe09['query']) { $h22c38=explode('&',$lebe09['query']); foreach ($h22c38 as $q8822b){ list ($u3c6e0,$e2063c)=explode('=',$q8822b); $e2063c=urldecode($e2063c); $u3c6e0=str_replace('_','-',$u3c6e0); $parameters[$u3c6e0]=$e2063c; } } $t2cb9d=false; $parameters=e2urls__consolidate_tricky_parameters_($parameters); if ($afafdd){ if($_config['force_canonical_urls']) { $t95d32=d83c8($xc48ba,$parameters); list ($da4c3a,$eab96c)=explode('?',$_SERVER['REQUEST_URI'],2); $na37bf=$_protocol .'://'.$_SERVER['HTTP_HOST'].$da4c3a; $x5d6ba=$_protocol .'://'.$_SERVER['HTTP_HOST'].urldecode($da4c3a); $eab96c=explode('&',$eab96c); foreach ($eab96c as $w6c0d0){ list ($c5c5e7, ) = explode('=',$w6c0d0); if ($c5c5e7=='go'){ $na37bf.='?'. $w6c0d0; $x5d6ba.='?'. urldecode($w6c0d0); } } if ($na37bf!=$t95d32 and $x5d6ba!=$t95d32){ e2_go_to($t95d32); } } if(is_callable($xc48ba)) { $t2cb9d=array ($xc48ba,$parameters); } else { $t2cb9d=array (null, array ()); } } else { $t2cb9d=array (null, array ()); } return $t2cb9d; } function e2urls__expand_tricky_parameters_for_note_($q39a37){ global$settings,$va57c1; if (!isset ($q39a37['IsPublished'])) { return array (); } if (!$q39a37['IsPublished']) { if ($q39a37['OriginalAlias']==''){ $parameters['draft']=$q39a37['ID']; } elseif(e2_draft_alias_use_count($q39a37['OriginalAlias']) == 1){ $parameters['oalias']=$q39a37['OriginalAlias']; } else { $parameters['draft2']=$q39a37['ID']; $parameters['oalias2']=$q39a37['OriginalAlias']; } $parameters['is-published']=0; return$parameters; } $parameters['is-published']=1; $lb80bb=$q39a37['ID']; $a96b8c=$q39a37['Stamp']; $qb2c6c=r0923($q39a37); if (!isset ($q39a37['__noalias!'])) { if (isset ($q39a37['alias'])) { $parameters['alias']=$q39a37['alias']; } else { $parameters['alias']=e2_active_alias_for_note_with_id_($q39a37['ID']); } } if($parameters['alias']) return$parameters; list ($g41529,$k6f8f5,$e8277e)=explode('/', s5a2f('Y/m/d',$a96b8c,$qb2c6c) ); $parameters['year']=$g41529; $parameters['month']=$k6f8f5; $parameters['day']=$e8277e; if (isset ($q39a37['day_number'])) { $parameters['day-number']=$q39a37['day_number']; } else { list ($fd9d0f, ) = f5273($g41529,$k6f8f5,$e8277e); if (t0738( "SELECT `ID`, `Stamp`, `Offset`, `IsDST` ". "FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND (`Stamp` BETWEEN " .$fd9d0f. " AND " .$a96b8c. ") ". "ORDER BY `Stamp`" )) { $result=b0d6b(); $rb1bc2=1; foreach($result as $y65afd){ if ( $g41529.'/'.$k6f8f5.'/'.$e8277e == s5a2f('Y/m/d',$y65afd['Stamp'],r0923($y65afd)) ) { if ($y65afd['ID']==$lb80bb){ $j444bc=1; break; } $rb1bc2 ++; } } if (@$j444bc!=1){ header('HTTP/1.1 503 Service Unavailable'); die ('<big style="background: #a00; color: #ccc; padding: .1em .33em">CANDIDATES_ENUMERATION_FAILED</big>'); } } $parameters['day-number']=$rb1bc2; } return$parameters; } function e2urls__consolidate_tricky_parameters_($parameters){ if ( @$parameters['alias'] or ( @$parameters['year'] and @$parameters['month'] and @$parameters['day'] and @$parameters['day-number'] ) ) { $parameters['*note']=e2_published_noterec_with_parameters_($parameters); } if ( @$parameters['oalias'] or @$parameters['draft'] or @$parameters['oalias2'] or @$parameters['draft2'] ) { $parameters['*note']=e2_noterec_with_parameters_($parameters); } return$parameters; } function e2m_tags(){ global$settings,$_strings; $result=u24e7(); $d59aeb=array(); foreach($result['keywords'] as $q0ac27){ $yc6827['tag']=htmlspecialchars($q0ac27['Keyword'],ENT_NOQUOTES,HSC_ENC); $yc6827['href']=d83c8( 'e2m_tag', TRANS_TAGS_UTF8_URLS ? array ('tag' => $yc6827['tag']) : array ('tag-urlname' => $q0ac27['URLName']) ); $yc6827['favourite?'] = (bool)$q0ac27['IsFavourite']; $yc6827['notes-count']=0; $yc6827['last-used']=0; $yc6827['freshness']=0; $yc6827['weight']=0; $d59aeb[$q0ac27['ID']] = $yc6827; } $o9fdd5=0; $y8f57c=0; $c06894=0; foreach($result['ordering_info'] as $v28a42){ $yc6827 =& $d59aeb[$v28a42['KeywordID']]; $yc6827['notes-count']=$v28a42['Count']; if (@$yc6827['last-used'] < $v28a42['LastUsed']) { $yc6827['last-used']=$v28a42['LastUsed']; $f452b4=(time()-$yc6827['last-used']) / SECONDS_IN_A_YEAR; $yc6827['freshness']=pow(1/2,$f452b4); } $o9fdd5=max($o9fdd5,$yc6827['notes-count']); $y8f57c=max($y8f57c,$yc6827['freshness']); $c06894=max($c06894,$yc6827['notes-count']*$yc6827['freshness']); } $j86d7e=array(); foreach ($d59aeb as $g865c0 => $z9e366){ if ($z9e366['notes-count']==0) continue; $m95e80=mb_strtolower($z9e366['tag']); $j86d7e[$m95e80]=$z9e366; if ($y8f57c!=0){ $j86d7e[$m95e80]['freshness']=$z9e366['freshness']/$y8f57c; } else { $j86d7e[$m95e80]['freshness']=0; } if ($c06894!=0){ $j86d7e[$m95e80]['weight'] = ( $z9e366['freshness']*$z9e366['notes-count']/$c06894 ); } else { $j86d7e[$m95e80]['weight']=0; } if ($j86d7e[$m95e80]['favourite?'])$j86d7e[$m95e80]['weight']=1; } $t2cb9d['title']=$_strings['pt--tags']; $t2cb9d['heading']=$_strings['pt--tags']; if(count($j86d7e) > 0){ $t2cb9d['tags'] = array ( 'many?' => count($j86d7e) > KEYWORDS_MANY_THRESH, 'each' => $j86d7e, ); } return $t2cb9d; } function e2m_tag($parameters=array ()) { global $settings, $_config, $_current_tag, $_strings, $i71860,$full_blog_url; if(array_key_exists('_tagrecs',$parameters)) { $d59aeb=$parameters['_tagrecs']; } elseif(array_key_exists('_tagrec',$parameters)) { $d59aeb=array ($parameters['_tagrecs']); } else { return e2_error404_mode(); } $nd7df5=$d59aeb[0]; $w7186e=$parameters['tag-urlname']; $_current_tag=$nd7df5['Keyword']; $i71860=$parameters['page']; $kc2b7b=$settings['db']['table_prefix']; $xd7e5d=$settings['appearance']['notes_per_page']; foreach ($d59aeb as $z9e366){ $y56790[] = "`". $kc2b7b."NotesKeywords`.KeywordID=". $z9e366['ID']; } $y56790=implode(' OR ',$y56790); $ff79b1='AND `IsVisible`=1'; if (oe852())$ff79b1=''; $c76595=( "COUNT(*) as KeywordsCount ". "FROM `". $kc2b7b."Notes` ". "INNER JOIN `". $kc2b7b."NotesKeywords` ". "ON `". $kc2b7b."NotesKeywords`.NoteID=`". $kc2b7b."Notes`.ID ". "WHERE `IsPublished`=1 AND (". $y56790 .") ". $ff79b1 ." ". "GROUP BY `". $kc2b7b."Notes`.`ID` ". "HAVING KeywordsCount=". count($d59aeb) ); $dd3890=( "SELECT DISTINCT `". $kc2b7b."Notes`.*, ". $c76595 ." ". "ORDER BY `". $kc2b7b."Notes`.`Stamp` DESC ". "LIMIT ". ($i71860-1)*$xd7e5d .", ". $xd7e5d ); $l1b037=( "SELECT DISTINCT `". $kc2b7b."Notes`.ID, ". $c76595 ); $gb3b32=array(); if (t0738($l1b037)) { $result=b0d6b(); $mfbb44=count($result); $xae0fe=ceil($mfbb44/$xd7e5d); $gb3b32['timeline?']=true; $gb3b32['count']=$xae0fe; $gb3b32['this']=$i71860; $gb3b32['earlier-title']=$_strings['gs--earlier']; $gb3b32['later-title']=$_strings['gs--later']; $p920fa=$parameters; if ($i71860 < $xae0fe){ $p920fa['page']=$i71860+1; $gb3b32['earlier-href']=d83c8('e2m_tag',$p920fa); } if ($i71860 > 1){ $p920fa['page']=$i71860-1; $gb3b32['later-href']=d83c8('e2m_tag',$p920fa); } } if ($mfbb44==0 and !oe852()) { return e2_error404_mode(); } if (t0738($dd3890)) { $result=b0d6b(); foreach($result as $a8ce4b => $saad65){ $saad65['_']['_id']=$saad65['ID']; $saad65['_']['_ord']=k; $saad65['_']['_ord_max']=count($result)-1; $g4358b[] = d6791($saad65); } if(count($result)==0){ if ($i71860!=1) return e2_error404_mode(); } } if(count($d59aeb)==1){ if (oe852()) { $e97a59['edit-href']=d83c8( 'e2m_tag_edit', TRANS_TAGS_UTF8_URLS ? array ('tag' => htmlspecialchars($nd7df5['Keyword'],ENT_NOQUOTES,HSC_ENC)) : array ('tag-urlname' => $w7186e) ); } if (''!=$nd7df5['Description']) { $t2bfe4=nb7f1($nd7df5['Description'],'simple','nocache'); $t67daf=$t2bfe4['text-final']; $e97a59['description']=$t67daf; $e97a59['description-format-info']=$t2bfe4['meta']; } if(TRANS_TAGS_UTF8_URLS){ $g3ad42=d83c8('e2m_tag_rss', array ('tag' => htmlspecialchars($nd7df5['Keyword'],ENT_NOQUOTES,HSC_ENC))); } else { $g3ad42=d83c8('e2m_tag_rss', array ('tag-urlname' => $w7186e)); } v3010( $_strings['pt--posts-tagged'] .': '. htmlspecialchars($nd7df5['Keyword'],ENT_NOQUOTES,HSC_ENC), $g3ad42 ); } $d96963=( e2l_get_string('pt--n-posts', array ('number' => $mfbb44)). ' '. $_strings['gs--tagged'] ); $uf74f5=array(); foreach ($d59aeb as $z9e366){ $uf74f5[] = $z9e366['Keyword']; } $uf74f5=implode(', ',$uf74f5); $t2cb9d=array ( 'title' => $d96963 .': '. $uf74f5, 'superheading' => $d96963, 'heading' => $uf74f5, 'pages' => $gb3b32, 'notes' => $g4358b, ); if(count($d59aeb)==1){ $t2cb9d['tag']=$e97a59; $t2cb9d['related-rss-href']=$g3ad42; if (oe852()) { $t2cb9d['related-edit-href']=$e97a59['edit-href']; $t2cb9d['related-edit-title']=$_strings['tt--edit-tag']; } } return $t2cb9d; } function e2m_tag_edit($parameters=array()) { global$settings,$_strings; if(array_key_exists('_tagrec',$parameters)) { $nd7df5=$parameters['_tagrec']; } else { return e2_error404_mode(); } $qcd831=array ( '.tag-id' => $nd7df5['ID'], 'form-action' => d83c8('e2s_tag_edit'), 'submit-text' => $_strings['fb--save-changes'], 'tag' => htmlspecialchars($nd7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'urlname' => htmlspecialchars($nd7df5['URLName'],ENT_COMPAT,HSC_ENC), 'description' => htmlspecialchars($nd7df5['Description'],ENT_COMPAT,HSC_ENC), 'favourite?' => (bool)$nd7df5['IsFavourite'], 'delete-href' => d83c8( 'e2m_tag_delete', TRANS_TAGS_UTF8_URLS ? array ('tag' => htmlspecialchars($nd7df5['Keyword'],ENT_NOQUOTES,HSC_ENC)) : array ('tag-urlname' => $nd7df5['URLName']) ), ); $t2cb9d=array ( 'title' => $_strings['pt--tag-edit'] .': '. $nd7df5['Keyword'], 'heading' => $_strings['pt--tag-edit'], 'form' => 'form-tag', 'form-tag' => $qcd831, ); return $t2cb9d; } function e2m_tag_flag_ajax($parameters){ if (w2e88($parameters)) { $b67142=$parameters; $b67142['value'] = !$parameters['value']; if($parameters['value']==1){ $l99859=d83c8('e2m_tag_flag_ajax',$b67142); $k1fa03='on-rehref|'. $l99859; } else { $l99859=d83c8('e2m_tag_flag_ajax',$b67142); $k1fa03='off-rehref|'. $l99859; } } else { $k1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($k1fa03); } else { e2_go_to(d83c8('e2m_tag',$parameters)); die; } } function w2e88($parameters){ if(array_key_exists('_tagrec',$parameters)) { $nd7df5=$parameters['_tagrec']; } else { return false; } @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); $result=baa79('Keywords', array ( 'ID' => $nd7df5['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); return$result; } function e2m_tag_delete($parameters=array()) { global$settings,$_strings; if(array_key_exists('_tagrec',$parameters)) { $nd7df5=$parameters['_tagrec']; } else { return e2_error404_mode(); } $yecc14=array ( '.tag-id' => $nd7df5['ID'], 'caution-text' => e2l_get_string('gs--tag-will-be-deleted-notes-remain', array ( 'tag' => htmlspecialchars($nd7df5['Keyword'],ENT_COMPAT,HSC_ENC) )), 'tag' => htmlspecialchars($nd7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'form-action' => d83c8('e2s_tag_delete'), 'submit-text' => $_strings['fb--delete'], ); $t2cb9d=array ( 'title' => $_strings['pt--tag-delete'] .': '. $nd7df5['Keyword'], 'heading' => $_strings['pt--tag-delete'], 'form' => 'form-tag-delete', 'form-tag-delete' => $yecc14, ); return $t2cb9d; } function e2m_untagged(){ global$settings,$_strings; $ff79b1='AND `IsVisible`=1'; if (oe852())$ff79b1=''; return kd864(array ( 'query' => "SELECT n.* FROM `". $settings['db']['table_prefix']."Notes` n ". "LEFT OUTER JOIN `". $settings['db']['table_prefix']."NotesKeywords` nk ". "ON nk.NoteID = n.ID ". "WHERE `IsPublished`=1 AND nk.KeywordID IS NULL ".$ff79b1." ". "ORDER BY n.Stamp DESC", 'title' => $_strings['pt--posts-without-tags'], 'heading' => $_strings['pt--posts-without-tags'], 'no-notes-text' => $_strings['gs--no-posts-without-tags'], 'show-all-notes' => true, )); } function e2s_tag_edit(){ global$settings,$_strings; $l89e37=1; if (!a01d3($_POST['urlname'])) { f8a40($_strings['er--bad-tag-urlname'],E2E_USER_ERROR); $l89e37=0; } if (t0738( "SELECT Keyword, URLName FROM `". $settings['db']['table_prefix']."Keywords` ". "WHERE (Keyword = '".e7928($_POST['tag'])."' ". "OR URLName = '".e7928($_POST['urlname'])."') ". "AND (ID != ".((int)$_POST['tag-id']).")") ) { if(count(b0d6b()) == 0){ t7996(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); if (t0738( "UPDATE `". $settings['db']['table_prefix']."Keywords` "."SET ". "`Keyword`='".e7928($_POST['tag'])."', ". ($l89e37? "`URLName`='".e7928($_POST['urlname'])."', ":''). "`Description`='".e7928($_POST['description'])."'". ' WHERE `ID`='.((int)$_POST['tag-id']))) { if ($l89e37 and TRANS_TAGS_UTF8_URLS){ e2_go_to(d83c8('e2m_tag', array ('tag' => $_POST['tag']))); } elseif ($l89e37 and !TRANS_TAGS_UTF8_URLS){ e2_go_to(d83c8('e2m_tag', array ('tag-urlname' => $_POST['urlname']))); } else { p4930(); } } else { p4930(); } } else { f8a40($_strings['er--cannot-rename-tag'],E2E_USER_ERROR); p4930(); } } else { p4930(); } die; } function e2s_tag_delete(){ global$settings,$_strings; $lb80bb=((int)$_POST['tag-id']); t7996(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); $j444bc=( t0738( "DELETE FROM `". $settings['db']['table_prefix']."Keywords` WHERE `ID`=". $lb80bb ) and t0738( "DELETE FROM `". $settings['db']['table_prefix']."NotesKeywords` WHERE `KeywordID`=". $lb80bb ) ); if ($j444bc){ e2_go_to(d83c8('e2m_tags')); die; } else { p4930(); die; } } function l3b25($parameters=array ()) { global$settings; if(TRANS_TAGS_UTF8_URLS){ if(array_key_exists('tag',$parameters)) { $a8ce4b=d0188($parameters['tag']); if ($a8ce4b)$parameters['_tagrec']=$a8ce4b; $parameters['tag-urlname']=$parameters['_tagrec']['URLName']; } } else { if(array_key_exists('tag-urlname',$parameters)) { $ybdcf3=explode(',',$parameters['tag-urlname']); foreach ($ybdcf3 as $kd7ca3){ $a8ce4b=u812d($kd7ca3); if ($a8ce4b){ if(TRANS_TAGS_INTERSECT){ $parameters['_tagrecs'][] = $a8ce4b; $parameters['tags'][] = $a8ce4b['Keyword']; } $parameters['_tagrec']=$a8ce4b; $parameters['tag']=$a8ce4b['Keyword']; } } } } return$parameters; } function u24e7(){ global$settings; t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Keywords` ". "ORDER BY `Keyword`" ); $d59aeb=b0d6b(); t0738( "SELECT nk.KeywordID, COUNT(DISTINCT n.ID) as Count, max(n.Stamp) as LastUsed ". "FROM `". $settings['db']['table_prefix']."NotesKeywords` nk, ". "`". $settings['db']['table_prefix']."Notes` n ". "WHERE nk.NoteID = n.ID AND n.IsPublished ". (oe852()? "":"AND n.IsVisible=1 " ). "GROUP BY nk.KeywordID" ); $m0c6dc=b0d6b(); return array ('keywords' => $d59aeb,'ordering_info' => $m0c6dc); } function maf16($m07f25){ global$settings,$u097cc,$_current_tag; $s9df9d=null; if(CACHE_FAVTAGS and is_file(CACHE_FILENAME_FAVTAGS)) { $s9df9d=@unserialize(tcdf0(CACHE_FILENAME_FAVTAGS)); } if (!is_array($s9df9d)) { t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Keywords` ". "WHERE IsFavourite = 1 ORDER BY `Keyword`" ); $p9cdff=b0d6b(); $s9df9d=array(); foreach ($p9cdff as $q04ff0){ $yc6827['tag']=htmlspecialchars($q04ff0['Keyword'],ENT_NOQUOTES,HSC_ENC); $yc6827['href']=d83c8( 'e2m_tag', TRANS_TAGS_UTF8_URLS ? array ('tag' => $yc6827['tag']) : array ('tag-urlname' => $q04ff0['URLName']) ); $s9df9d[] = $yc6827; } if(CACHE_FAVTAGS)v6e52(CACHE_FILENAME_FAVTAGS,serialize($s9df9d)); } $g8a4f1=false; foreach ($s9df9d as $a8ce4b => $z9e366){ $s9df9d[$a8ce4b]['current?'] = ( $s9df9d[$a8ce4b]['tag']==$_current_tag ); if ($s9df9d[$a8ce4b]['current?']) { $g8a4f1=true; $n08187=$m07f25; $n08187['flag']='IsFavourite'; $n08187['value']=0; if (oe852()) { $s9df9d[$a8ce4b]['pinnable?']=true; $s9df9d[$a8ce4b]['pinned?']=true; $s9df9d[$a8ce4b]['pinned-toggle-href'] = ( d83c8('e2m_tag_flag_ajax',$n08187) ); } } } if (oe852()) { if (!$g8a4f1 and array_key_exists('_tagrec',$m07f25)) { $na55a9=$m07f25; $na55a9['flag']='IsFavourite'; $na55a9['value']=1; $id5a7a=array ( 'tag' => htmlspecialchars($m07f25['_tagrec']['Keyword'],ENT_NOQUOTES,HSC_ENC), 'href' => d83c8('e2m_tag',$m07f25), 'current?' => true, 'pinnable?' => true, 'pinned?' => false, 'pinned-toggle-href' => d83c8('e2m_tag_flag_ajax',$na55a9), ); $s9df9d[] = $id5a7a; } } return $s9df9d; } function hce23($y21158,$parameters=''){ global$settings; $g0dff3=array(); if (t0738( "SELECT `". $settings['db']['table_prefix']."Keywords`.* ". "FROM `". $settings['db']['table_prefix']."Keywords`, ". "`". $settings['db']['table_prefix']."NotesKeywords` ". "WHERE `". $settings['db']['table_prefix']."NotesKeywords`.NoteID=". ((int)$y21158) ." ". "AND `". $settings['db']['table_prefix']."Keywords`.ID=`". $settings['db']['table_prefix']."NotesKeywords`.KeywordID ". "ORDER BY `Keyword`" )) { $g0dff3=b0d6b(); } return $g0dff3; } function u93c2($seaa60){ global$settings; $r316e8=array(); foreach (array ( 'ID', 'NoteID', 'KeywordID', ) as $d06e3d) if(array_key_exists($d06e3d,$seaa60)) { $k6a7f2[] = '`'. $d06e3d .'`'."='". e7928($seaa60[$d06e3d]) ."'"; if ($d06e3d=='ID')$y729d6='tagbinging-id'; if ($d06e3d=='NoteID')$y729d6='tagbinging-note-id'; if ($d06e3d=='KeywordID')$y729d6='tagbinging-tag-id'; $r316e8[$y729d6]=$seaa60[$d06e3d]; } $x1b1cc=( "DELETE FROM `". $settings['db']['table_prefix']."NotesKeywords` ". "WHERE ". implode(' AND ',$k6a7f2) ); if (t0738($x1b1cc)) { return true; } } function icbd4($seaa60){ global$settings; if (!array_key_exists('ID',$seaa60) or !is_numeric($seaa60['ID'])) { die ('API MISUSE: e2q_update_tagbinding must be called with an ID field in $tagbinding_record'); } $k6a7f2=array(); foreach (array ( 'NoteID', 'KeywordID', ) as $d06e3d) if(array_key_exists($d06e3d,$seaa60)) { $k6a7f2[] = '`'. $d06e3d .'`'."='". e7928($seaa60[$d06e3d]) ."'"; } if(count($k6a7f2) > 0){ $x1b1cc = "UPDATE `". $settings['db']['table_prefix']."NotesKeywords` ". "SET ". implode(', ',$k6a7f2) ." ". "WHERE `ID`=". $seaa60['ID']; if (t0738($x1b1cc)) { return true; } } } function k478d( $nd7df5,$kd7ca3,$g71883,$t67daf,$p8b087 ){ global$settings; $j444bc=t0738( "INSERT INTO `". $settings['db']['table_prefix']."Keywords` (". "`Keyword`, `URLName`, `ParentKeywordID`, `Description`, `IsFavourite`". ") VALUES (". "'". e7928($nd7df5) ."', ". "'". e7928($kd7ca3) ."', ". "'". e7928($g71883) ."', ". "'". e7928($t67daf) ."', ". "'".((int)$p8b087)."' ". ")" ); @unlink(CACHE_FILENAME_TAGS); if ($p8b087){ @unlink(CACHE_FILENAME_FAVTAGS); } if ($j444bc){ return mysql_insert_id(); } else { return false; } } function rec0d($nb45cf){ $nb45cf=e2l_transliterate($nb45cf); $nb45cf=strtr($nb45cf, array ( ' ' => '-', '/' => '-', '<' => '-', '>' => '-', '.' => '-', ',' => '-', ':' => '-', '&' => '-and-', )); $nb45cf=preg_replace('/\-+/','-',$nb45cf); $nb45cf=preg_replace('/[^a-z0-9-\']*/i','',$nb45cf); $nb45cf=strtolower($nb45cf); if(__LOG)__log('Gen urlname'); $result=$nb45cf; $rb1bc2='2'; while (u812d($result)!==false){ $result=$nb45cf .'-'. $rb1bc2; ++ $rb1bc2; } return$result; } function y3873($vda3ad='Keyword'){ global$settings; $na6168=null; if(CACHE_TAGS and is_file(CACHE_FILENAME_TAGS)) { $na6168=@unserialize(tcdf0(CACHE_FILENAME_TAGS)); } if (!is_array($na6168)) { if (t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Keywords` ORDER BY `".$vda3ad."`") ) { $ifa816=b0d6b(); } else { $ifa816=array(); } $na6168=array(); foreach ($ifa816 as $he358e)$na6168[] = $he358e; if(CACHE_TAGS)v6e52(CACHE_FILENAME_TAGS,serialize($na6168)); } return $na6168; } function fa463($y21158,$vda3ad='Keyword'){ global$settings; if (t0738( "SELECT `". $settings['db']['table_prefix']."Keywords`.* ". "FROM `". $settings['db']['table_prefix']."Keywords`, ". "`". $settings['db']['table_prefix']."NotesKeywords` ". "WHERE `". $settings['db']['table_prefix']."NotesKeywords`.NoteID=".((int)$y21158)." AND ". "`". $settings['db']['table_prefix']."Keywords`.ID=". "`". $settings['db']['table_prefix']."NotesKeywords`.KeywordID ". "ORDER BY `".$vda3ad."`" ))$ifa816=b0d6b(); else $ifa816=array(); $d59aeb=array(); foreach ($ifa816 as $he358e)$d59aeb[] = $he358e; return $d59aeb; } function d7d5e($nd7df5){ global$settings; if (t0738( "SELECT `URLName` FROM `". $settings['db']['table_prefix']."Keywords` ". "WHERE `Keyword`='".e7928($nd7df5)."'" )) $ifa816=b0d6b(); else $ifa816=array(); if (isset ($ifa816[0]['URLName'])) return $ifa816[0]['URLName']; else return false; } function d0188($nd7df5){ global$settings; if (t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Keywords` ". "WHERE `Keyword`='".e7928($nd7df5)."'" )) { $a8ce4b=b0d6b(); if (isset ($a8ce4b[0])) return $a8ce4b[0]; } return null; } function u812d($kd7ca3){ global$settings; if (t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Keywords` ". "WHERE `URLName`='".e7928($kd7ca3)."'" )) $ifa816=b0d6b(); else $ifa816=array(); if (isset ($ifa816[0])) return $ifa816[0]; else return FALSE; } function n4e28($lb80bb){ global$settings; if (t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Keywords` ". "WHERE `ID`='".((int)$lb80bb)."'" )) { $a8ce4b=b0d6b(); if (isset ($a8ce4b[0])) { $a8ce4b=$a8ce4b[0]; return $a8ce4b; } else { return NULL; } } return NULL; } function e2m_comment($parameters=array ()) { e2_go_to(d83c8('e2m_note',$parameters)); die; } function e2m_comment_edit($parameters=array ()) { return o4fb7('edit',$parameters); } function e2m_note_comment($parameters=array ()) { return o4fb7('write',$parameters); } function o4fb7($j60cd8,$parameters=array ()) { global$_strings,$full_blog_url,$settings; $kd5d3d=$uf74f5=$_strings['pt--new-comment']; $b69b97='new'; if ($j60cd8=='edit'){ $h4032b=e2_commentrec_with_parameters_($parameters); $sc50d0=$_strings['fb--save-changes']; $q39a37=$h4032b['noterec']; $kd5d3d=$uf74f5=$_strings['pt--edit-comment']; $b69b97=$caca8d['ID']; if (!$h4032b){ return e2_error404_mode(); } $y80f02=array ( '.note-id' => $h4032b['NoteID'], '.comment-id' => $h4032b['ID'], '.already-subscribed?' => false, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($full_blog_url)+1), 'create:edit?' => false, 'form-action' => d83c8('e2s_comment_process'), 'submit-text' => $sc50d0, 'show-subscribe?' => true, 'subscribe?' => (bool)$h4032b['IsSubscriber'], 'name' => htmlspecialchars($h4032b['AuthorName'],ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($h4032b['AuthorEmail'],ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($h4032b['Text'],ENT_COMPAT,HSC_ENC), 'email-field-name' => 'elton-john', ); } else { $q39a37=$parameters['*note']; $y80f02=d66aa($q39a37); } return array ( 'title' => $kd5d3d, 'heading' => $uf74f5, 'form' => 'form-comment', 'form-comment' => $y80f02, ); } function e2m_comment_reply($parameters=array ()) { global$_strings,$settings; $h4032b=e2_commentrec_with_parameters_($parameters); if (!$h4032b){ return e2_error404_mode(); } $q39a37=$h4032b['noterec']; $u1aec6=o86f8($q39a37,$h4032b,$parameters['comment-number']); $u1aec6['_']['_id']=$h4032b['ID']; $u1aec6['_']['_ord']=0; $u1aec6['_']['_ord_max']=0; $u1aec6['replying?'] = (bool)true; $l817c7=($h4032b['Reply']=='' or !$h4032b['IsReplyVisible']); $kd5d3d=$l817c7? $_strings['pt--reply-to-comment']:$_strings['pt--edit-reply-to-comment']; $o4dc70=array ( '.note-id' => $q39a37['ID'], '.comment-id' => $h4032b['ID'], '.reply-action' => $l817c7? 'new':'edit', 'form-action' => d83c8('e2s_comment_edit_reply'), 'submit-text' => $l817c7? $_strings['fb--publish']:$_strings['fb--save-changes'], 'create:edit?' => (bool) ($l817c7), 'reply-text' => htmlspecialchars($h4032b['Reply'],ENT_COMPAT,HSC_ENC), 'mail-back?' => (bool) ($l817c7), ); return array ( 'title' => $kd5d3d, 'heading' => $kd5d3d, 'comments' => array ('only' => $u1aec6), 'form' => 'form-comment-reply', 'form-comment-reply' => $o4dc70, ); } function e2m_comment_delete($parameters=array ()) { global$_strings,$settings,$rcbcce; if (!@$settings['comments']['on']) return e2_error404_mode(); $h4032b=e2_commentrec_with_parameters_($parameters); $y21158=$h4032b['NoteID']; if (!$h4032b){ return e2_error404_mode(); } e2_drop_caches_for_note_($y21158); @unlink(USER_FOLDER. '/last-comment.psa'); t0738( "DELETE FROM `". $settings['db']['table_prefix']."Comments` ". "WHERE `ID` = '".((int)$h4032b['ID'])."'" ); p4930(); die; } function e2m_comment_reply_delete($parameters=array ()) { global$_strings,$settings; if (!@$settings['comments']['on']) return e2_error404_mode(); $h4032b=e2_commentrec_with_parameters_($parameters); if (!$h4032b){ return e2_error404_mode(); } t0738( "UPDATE `". $settings['db']['table_prefix']."Comments` SET ". "`Reply`='', ". "`IsReplyFavourite`='0' ". "WHERE `ID`=".((int)$h4032b['ID']) ); p4930(); die; } function e2m_unsubscribe($parameters){ global$_strings,$settings; $v70a17="ORDER BY `ID` DESC"; $q39a37=$parameters['*note']; $y21158=$q39a37['ID']; $c0c83f=$parameters['unsubscribe-email']; $r1bc29=$parameters['unsubscribe-key']; $c0c83f=str_replace(' ','+',$c0c83f); if ($y21158){ if (t0738( "SELECT `ID`, `Stamp` FROM `". $settings['db']['table_prefix']."Comments` ". "WHERE `NoteID`=". $y21158 ." AND `IsSubscriber`=1 AND `AuthorEmail`='". $c0c83f ."' ". $v70a17 )) { $result=b0d6b(); if(count($result) < 1) { $t2cb9d['unsubscribe']['success?']=false; $t2cb9d['unsubscribe']['error-message']=$_strings['gs--you-are-not-subscribed']; } else { $p06d4c=@$result[0]; $v97f69=md5($p06d4c['ID'].$p06d4c['Stamp'] .'x'); $g260ca=false; if ($r1bc29==$v97f69){ if (t0738( "UPDATE `". $settings['db']['table_prefix']."Comments` SET `IsSubscriber`=0 ". "WHERE `NoteID`=". $y21158 ." AND `AuthorEmail` = '".e7928($c0c83f)."'" )) { $g260ca=true; $t2cb9d['unsubscribe']['success?']=true; $t2cb9d['unsubscribe']['note-title']=q6f10( htmlspecialchars(vea9c($q39a37),ENT_COMPAT,HSC_ENC) ); $t2cb9d['unsubscribe']['note-href']=d83c8( 'e2m_note', array ('*note' => $q39a37) ); } } if (!$g260ca){ $t2cb9d['unsubscribe']['success?']=false; $t2cb9d['unsubscribe']['error-message']=$_strings['gs--unsubscription-didnt-work']; } } } else { $t2cb9d['unsubscribe']['success?']=false; $t2cb9d['unsubscribe']['error-message']=$_strings['gs--comment-not-found']; } } else { $t2cb9d['unsubscribe']['success?']=false; $t2cb9d['unsubscribe']['error-message']=$_strings['gs--post-not-found']; } return $t2cb9d; } function e2m_comment_flag($parameters){ n6e30($parameters); e2_go_to(d83c8('e2m_note',$parameters)); die; } function e2m_comment_flag_ajax($parameters){ if (n6e30($parameters)) { $b67142=$parameters; $b67142['value'] = !$parameters['value']; if($parameters['value']==1){ $l99859=d83c8('e2m_comment_flag_ajax',$b67142); $k1fa03='on-rehref|'. $l99859; } else { $l99859=d83c8('e2m_comment_flag_ajax',$b67142); $k1fa03='off-rehref|'. $l99859; } } else { $k1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($k1fa03); } else { e2_go_to(d83c8('e2m_note',$parameters)); die; } } function n6e30($parameters){ $h4032b=e2_commentrec_with_parameters_($parameters); $y21158=$h4032b['NoteID']; $result=false; if ($h4032b){ $result=baa79('Comments', array ( 'ID' => $h4032b['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); e2_drop_caches_for_note_($y21158); } return$result; } function e2s_comment_process(){ global$_strings,$settings,$_fp_error; list ($y21158,$b69b97,$w9d090)=x1a90(); if(__LOG)__log('Comments: processed, noteid <'. $y21158 .'>, commentid <'. $b69b97 .'>'); if (!$b69b97){ $c05c36=''; if($_fp_error==FP_NOT_COMMENTABLE){ f8a40($_strings['er--post-not-commentable'],E2E_USER_ERROR); } elseif($_fp_error==FP_EMPTY_FIELD){ f8a40($_strings['er--name-email-text-required'],E2E_USER_ERROR); } elseif($_fp_error==FP_COMMENT_TOO_LONG){ $kaa731=$_strings['gs--comment-too-long']; $c05c36=$_strings['gs--comment-too-long-description']; } elseif($_fp_error==FP_COMMENT_DOUBLE_POST){ $kaa731=$_strings['gs--comment-double-post']; $c05c36=$_strings['gs--comment-double-post-description']; } elseif($_fp_error==FP_COMMENT_SPAM_SUSPECT){ $kaa731=$_strings['gs--comment-spam-suspect']; $c05c36=$_strings['gs--comment-spam-suspect-description']; } else { f8a40($_strings['er--error-occurred'].' ('. $_fp_error .')'); } if ($c05c36){ $t2cb9d['title']=$kaa731; $t2cb9d['heading']=$kaa731; $t2cb9d['form']='form-unaccepted-comment'; $t2cb9d['form-unaccepted-comment'] = array ( 'reason' => $c05c36, 'text' => @htmlspecialchars($w9d090['text'],ENT_COMPAT,HSC_ENC), ); return $t2cb9d; } } if ($y21158){ e2_go_to(d83c8('e2m_note', array ('*note' => w4627($y21158)))); } else { e2_go_to(); } die; } function e2s_comment_edit_reply(){ global$_strings,$settings,$z57de2; $me84af=@$_POST['text']; if(trim($me84af)=='')$me84af=''; $y21158=@$_POST['note-id']; $saad65=w4627($y21158); $b69b97=@$_POST['comment-id']; $p06d4c=mb559($b69b97); $a54eb6=isset ($_POST['mail-back']); $d54fa9=time(); if (@$_POST['reply-action']=='new'){ $ce0e30=time(); } @unlink(e2_note_cache_filename_with_id_($y21158 .'-comments')); if ($p06d4c and t0738( "UPDATE `". $settings['db']['table_prefix']."Comments` SET ". "`Reply`='". e7928($me84af) ."', ". ( isset ($ce0e30)? ( "`ReplyStamp`='". $ce0e30 ."', " ) : ( "" ) ). "`ReplyLastModified`='". $d54fa9 ."', ". "`IsReplyVisible`='1' ". "WHERE `ID`=".((int)$b69b97) )) { $nd58c0=d83c8('e2m_note', array ('*note' => $saad65)); if ($a54eb6 and $me84af!=''){ $yc6827['comment-time'] = array ($p06d4c['Stamp'],g5c05()); $yc6827['commenter']=$p06d4c['AuthorName']; $yc6827['commenter-email']=$p06d4c['AuthorEmail']; $yc6827['comment-text']=$p06d4c['Text']; $yc6827['note-title']=q6f10(vea9c($saad65)); $yc6827['reply-time'] = array (time(),g5c05()); $yc6827['blog-author']=q2640(); $yc6827['note-href']=$nd58c0; $yc6827['comment-href']=$nd58c0; $yc6827['reply-text']=$me84af; if(1){ $ade7a3=d3e5c( 'comment-reply',$yc6827 ); $kb904c=e2l_get_string( 'em--comment-reply', $yc6827 ); $p77613=$p06d4c['AuthorEmail']; $n1a49b='From: '. waed2(); ra41b($p77613,$kb904c,$ade7a3,$n1a49b); } if(1){ unset ($yc6827['commenter-email']); $n1a49b='From: '. waed2(); foreach (o4975($saad65,$p06d4c['AuthorEmail']) as $s39c63){ $hba570=$s39c63['AuthorEmail']; $e6fd85=md5($s39c63['ID'].$s39c63['Stamp'].'x'); $yc6827['unsubscribe-href']=d83c8('e2m_unsubscribe', array ( '*note' => $saad65, 'unsubscribe-email' => $hba570, 'unsubscribe-key' => $e6fd85, ) ); $p77613=$hba570; $ade7a3=d3e5c('comment-reply-to-public',$yc6827); $kb904c=e2l_get_string( 'em--comment-reply-to-public-subject', $yc6827 ); ra41b($p77613,$kb904c,$ade7a3,$n1a49b); } } } e2_go_to($nd58c0); } else { p4930(); } die; } function o86f8($saad65,$p06d4c,$rb1bc2=false){ global$settings,$_config; if(__LOG)__log('Comments: package comment <'. $p06d4c['ID'] .'>...'); if ($saad65===null){ $saad65=w4627($p06d4c['NoteID']); } if ($rb1bc2!==false)$yc6827['number']=$rb1bc2; $yc6827['name']=htmlspecialchars($p06d4c['AuthorName'],ENT_NOQUOTES,HSC_ENC); if (oe852()) { $yc6827['email']=htmlspecialchars($p06d4c['AuthorEmail'],ENT_NOQUOTES,HSC_ENC); if (''!=trim($p06d4c['IP'])) { $yc6827['ip']=$p06d4c['IP']; $yc6827['ip-href']=$_config['whois_service'].$yc6827['ip']; } } $yc6827['author-name']=q2640(); $yc6827['visible?'] = (bool)$p06d4c['IsVisible']; $yc6827['important?'] = (bool)$p06d4c['IsFavourite']; $yc6827['reply-visible?'] = (bool) ($p06d4c['IsVisible'] && $p06d4c['IsReplyVisible']); $yc6827['reply-important?'] = (bool)$p06d4c['IsReplyFavourite']; $yc6827['spam-suspect?'] = (bool)$p06d4c['IsSpamSuspect']; $r10a7e=array ((int)$p06d4c['Stamp'],r0923($saad65)); $yc6827['time']=$r10a7e; $yc6827['last-modified']=$r10a7e; if ($p06d4c['LastModified']) $yc6827['last-modified'] = array ((int)$p06d4c['LastModified'],r0923($saad65)); if ($p06d4c['ReplyStamp']) $yc6827['reply-time'] = array ((int)$p06d4c['ReplyStamp'],r0923($saad65)); if ($p06d4c['ReplyLastModified']) $yc6827['reply-last-modified'] = array ((int)$p06d4c['ReplyLastModified'],r0923($saad65)); if (oe852()) { $yc6827['subscriber?'] = (bool)$p06d4c['IsSubscriber']; $yc6827['new?'] = (bool)$p06d4c['IsNew']; $yc6827['first-new?']=false; if ($p06d4c['IsFavourite']) { $yc6827['important-toggle-href']=d83c8( 'e2m_comment_flag_ajax', array ('*note' => $saad65,'comment-number' => $rb1bc2,'flag' => 'IsFavourite','value' => 0) ); } else { $yc6827['important-toggle-href']=d83c8( 'e2m_comment_flag_ajax', array ('*note' => $saad65,'comment-number' => $rb1bc2,'flag' => 'IsFavourite','value' => 1) ); } if ($p06d4c['IsReplyFavourite']) { $yc6827['reply-important-toggle-href']=d83c8( 'e2m_comment_flag_ajax', array ( '*note' => $saad65,'comment-number' => $rb1bc2,'flag' => 'IsReplyFavourite','value' => 0 ) ); } else { $yc6827['reply-important-toggle-href']=d83c8( 'e2m_comment_flag_ajax', array ( '*note' => $saad65,'comment-number' => $rb1bc2,'flag' => 'IsReplyFavourite','value' => 1 ) ); } $yc6827['edit-href']=d83c8( 'e2m_comment_edit', array ('*note' => $saad65,'comment-number' => $rb1bc2) ); $yc6827['removed-toggle-href']=d83c8( 'e2m_comment_flag_ajax', array ( '*note' => $saad65,'comment-number' => $rb1bc2, 'flag' => 'IsVisible','value' => !$p06d4c['IsVisible'] ) ); $yc6827['removed-reply-toggle-href']=d83c8( 'e2m_comment_flag_ajax', array ( '*note' => $saad65,'comment-number' => $rb1bc2, 'flag' => 'IsReplyVisible','value' => !$p06d4c['IsReplyVisible'] ) ); $oe36ef=d83c8( 'e2m_comment_reply', array ('*note' => $saad65,'comment-number' => $rb1bc2) ); if ($p06d4c['Reply']=='' or !$p06d4c['IsReplyVisible']) { $yc6827['reply-href']=$oe36ef; } else { $yc6827['edit-reply-href']=$oe36ef; } } if(mb_strlen($p06d4c['Text']) > $_config['max_comment_length']) { $p06d4c['Text']=mb_substr($p06d4c['Text'],0,$_config['max_comment_length']); } $t2bfe4=x154e($saad65['FormatterID'],$p06d4c['Text'],'simple'); $yc6827['text']=$t2bfe4['text-final']; $yc6827['replying?'] = (bool)false; $yc6827['replied?'] = (bool) ( (trim($p06d4c['Reply']) != '') && ($p06d4c['IsReplyVisible']) ); $t2bfe4=x154e($saad65['FormatterID'],$p06d4c['Reply'],'full'); $yc6827['reply']=$t2bfe4['text-final']; if(array_key_exists('_',$p06d4c))$yc6827['_']=$p06d4c['_']; if(__LOG)__log('Comments: done'); return $yc6827; } function mb559($lb80bb){ global$settings; if (t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Comments` ". "WHERE `ID` = '".$lb80bb."'" )) { $ifa816=b0d6b(); if(count($ifa816) > 0) return $ifa816[0]; } return false; } function de5b6($l0604c){ e2_comment_set_flag('IsVisible',$l0604c); } function z3183($u0dd2c){ e2_comment_set_flag('IsReplyVisible',$u0dd2c); } function d66aa($zea59a){ global$_strings; $te3cb9=@$_COOKIE[m8c3b('commenter_name')]; $qf92ee=@$_COOKIE[m8c3b('commenter_email')]; $p3d682=@$_COOKIE[m8c3b('commenter_ph')]; $e92399=false; if ($qf92ee and cookie_unsubscribe_key){ foreach (o4975($zea59a) as $s39c63){ $v97f69=md5($s39c63['ID'].$s39c63['Stamp'] .'x'); if ( $s39c63['AuthorEmail']==$qf92ee and $p3d682==$v97f69 ){ $e92399=true; break; } } } $sc50d0=$_strings['fb--submit']; $y80f02=array ( '.note-id' => $zea59a['ID'], '.comment-id' => 'new', '.already-subscribed?' => (bool)$e92399, 'create:edit?' => true, 'form-action' => d83c8('e2s_comment_process'), 'submit-text' => $sc50d0, 'show-subscribe?' => (bool) !$e92399, 'subscribe?' => (bool)$e92399, 'subscription-status' => $e92399? $_strings['gs--you-are-already-subscribed']:'', 'visible?' => true, 'email-field-name' => 'elton-john', 'name' => htmlspecialchars($te3cb9,ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($qf92ee,ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($p06d4c['Text'],ENT_COMPAT,HSC_ENC), ); return $y80f02; } function h254f($y21158,$fdaf19=0){ global$settings; if (!$fdaf19)$ff79b1=' AND `IsVisible`=1'; if ('all'===$fdaf19){ $ff79b1=''; } if ('new'===$fdaf19){ $ff79b1=' AND `IsNew`=1'; } $gbc751=0; if (t0738( "SELECT count(*) FROM `". $settings['db']['table_prefix']."Comments` ". "WHERE `NoteID`=". @$y21158 . @$ff79b1 )) { $result=b0d6b(); $result=(int)$result[0]['count(*)']; $gbc751=$result; } return (int)$gbc751; } function k2a6b(){ global$settings; $ze2942=0; $w7ec7e=''; $qe8fab=''; if (t0738( "SELECT `NoteID`, `Text` FROM `". $settings['db']['table_prefix']."Comments` ". "WHERE `IsNew`=1 ORDER BY `Stamp`" )) { $result=b0d6b(); $ze2942=count($result); $w7ec7e=array(); foreach($result as $of1965){ $b95986=$of1965['Text']; if(mb_strlen($b95986) > 512){ $b95986=mb_substr($b95986,0,509). '...'; } $t2bfe4=nb7f1(str_replace("\n",' ',$b95986),'simple'); $w7ec7e[] = strip_tags($t2bfe4['text-final']); } $w7ec7e=implode(' &bull; ',$w7ec7e); if(mb_strlen($w7ec7e) > 512){ $w7ec7e=mb_substr($w7ec7e,0,509). '...'; } if ($ze2942){ $y21158=$result[0]['NoteID']; $qe8fab=d83c8( 'e2m_note', array ('*note' => w4627($y21158)) ); } else { $qe8fab=''; } } return array ((int)$ze2942,$w7ec7e,$qe8fab); } function o1baf($y21158,$g641f6){ global$settings; if(__LOG)__log('Comments: getting comments for note '. $y21158); if (t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Comments` ". "WHERE `NoteID`=". @$y21158." ". @$ff79b1 ." ". $g641f6 )) { $result=b0d6b(); return$result; } return array (); } function o4975($saad65,$sd1cc6=''){ global$settings; $v70a17="ORDER BY `ID` DESC"; $t2cb9d=$daf67c=array(); if (t0738( "SELECT DISTINCT `ID`, `Text`, `IsSubscriber`, `AuthorName`, `AuthorEmail`, `Stamp` ". "FROM `". $settings['db']['table_prefix']."Comments` ". "WHERE `NoteID`=". @$saad65['ID'] ." ". "AND `IsSubscriber`=1 ". "AND `AuthorEmail`!='". e7928($sd1cc6) ."' ". $v70a17 )) { $result=b0d6b(); foreach($result as $s39c63){ if (!in_array($s39c63['AuthorEmail'],$daf67c)) { $t2cb9d[] = $s39c63; } $daf67c[] = $s39c63['AuthorEmail']; } } return $t2cb9d; } function ob387($saad65,$c3f917=NOTE_COMMENTABLE_NOW){ global$settings,$_config; $r61f40=$settings['comments']['on']; $h8f888=$saad65['IsPublished']; $fbdb20=true; if (@$settings['comments']['fresh_only']) if (isset ($_config['comment_freshness_days'])) if ($saad65['Stamp'] < time()-$_config['comment_freshness_days']*SECONDS_IN_A_DAY) $fbdb20=false; $ec770a=$saad65['IsCommentable']; if ($c3f917==NOTE_COMMENTABLE_NOW_CONDITIONALLY){ $ec770a=true; } $n825ff=$saad65['IsVisible']; return $r61f40 and $h8f888 and $fbdb20 and $ec770a and $n825ff; } function e2_commentrec_with_parameters_($parameters=array ()) { $q39a37=$parameters['*note']; $ma5d49=o1baf($q39a37['ID'],"ORDER BY `Stamp`"); $h4032b=@$ma5d49[$parameters['comment-number']-1]; if ($h4032b){ $h4032b['noterec']=$q39a37; return $h4032b; } } function x1a90($f98ea6=''){ global$settings,$rcbcce,$_config,$_fp_error; $_fp_error=false; $rbe16c='elton-john'; $y21158=$b69b97=$zb0689=$c0c83f=$x1cb25=''; if(array_key_exists('note-id',$_POST)) $y21158=trim(@$_POST['note-id']); if(array_key_exists('comment-id',$_POST)) $b69b97=trim(@$_POST['comment-id']); if(array_key_exists('name',$_POST)) $zb0689=trim(@$_POST['name']); if(array_key_exists($rbe16c,$_POST)) $c0c83f=trim(@$_POST[$rbe16c]); if(array_key_exists('text',$_POST)) $x1cb25=trim(@$_POST['text']); $q07d3d=( (array_key_exists('already-subscribed',$_POST) and $_POST['already-subscribed']) or (array_key_exists('subscribe',$_POST) and $_POST['subscribe']) ); $w20612=time(); $w9d090['text']=$x1cb25; if ($b69b97=='new'){ jc64a('commenter_name',$zb0689); jc64a('commenter_email',$c0c83f); } $v848b5=( $b69b97=='new' and (array_key_exists('email',$_POST) and $_POST['email']!='') ); $sc2b1a=1; $result=false; if (!is_numeric($y21158)) { $_fp_error=FP_NO_ID_OR_NEW; } elseif (!is_numeric($b69b97) and !($b69b97=='new')) { $_fp_error=FP_NO_ID_OR_NEW; } else { if ($b69b97 and $zb0689=='' or $c0c83f=='' or $x1cb25==''){ $_fp_error=FP_EMPTY_FIELD; } if ($b69b97=='new'){ $w795f1=@unserialize(tcdf0(USER_FOLDER. '/last-comment.psa')); if(md5($zb0689.$c0c83f.$x1cb25)==$w795f1['md5']) { $_fp_error=FP_COMMENT_DOUBLE_POST; } if ( isset ($_config['max_comment_length']) and strlen(@$_POST['text']) > ($_config['max_comment_length']) ){ $_fp_error=FP_COMMENT_TOO_LONG; } $q39a37=w4627($y21158); if ($b69b97=='new' and !ob387($q39a37)) { $_fp_error=FP_NOT_COMMENTABLE; } if ($v848b5){ $_fp_error=FP_COMMENT_SPAM_SUSPECT; } } } if (!$_fp_error){ e2_drop_caches_for_note_($y21158); if ($b69b97=='new'){ $h4032b=array ( 'NoteID' => (int)$y21158, 'AuthorName' => e7928($zb0689), 'AuthorEmail' => e7928($c0c83f), 'Text' => e7928($x1cb25), 'IsVisible' => 1, 'IsAnswerAware' => 1, 'IsSubscriber' => (int)$q07d3d, 'IsSpamSuspect' => (int)$v848b5, 'IsNew' => (int)$sc2b1a, 'Stamp' => (int)time(), 'LastModified' => (int)time(), 'IP' => e7928($_SERVER['REMOTE_ADDR']), ); if (($h4032b=m9943('Comments',$h4032b)) !== false){ $b69b97=$h4032b['ID']; $w795f1=array ( 'id' => $b69b97, 'md5' => md5($zb0689.$c0c83f.$x1cb25), ); v6e52(USER_FOLDER. 'last-comment.psa',serialize($w795f1)); $result=(int)$b69b97; $f303ee=md5($h4032b['ID'].$h4032b['Stamp'].'x'); jc64a('commenter_ph',$f303ee); $i60422=h254f($y21158,'all')-1+1; $saad65=w4627($y21158); $nd58c0=d83c8('e2m_note', array ('*note' => $saad65)); $yc6827['comment-time'] = array ($w20612,g5c05()); $yc6827['commenter']=$zb0689; $yc6827['commenter-email']=$c0c83f; $yc6827['comment-text']=$x1cb25; $yc6827['note-title']=vea9c($saad65); $yc6827['note-href']=$nd58c0; $yc6827['comment-href']=$nd58c0; $yc6827['comments-disable-href']=d83c8('e2m_note_flag', array ( '*note' => $saad65, 'flag' => 'IsCommentable', 'value' => 0 )); $yc6827['reply-href']=d83c8( 'e2m_comment_reply', array ('*note' => $saad65,'comment-number' => $i60422) ); if (isset ($settings['user']['email']) and @$settings['notifications']['new_comments']) { $ade7a3=d3e5c( 'comment-new-to-author',$yc6827 ); $kb904c=e2l_get_string( 'em--comment-new-to-author-subject', $yc6827 ); $p77613=$settings['user']['email']; $n1a49b = 'From: '. waed2() ."\r\n". 'Reply-to: '. $zb0689 .' <'. $c0c83f .">"; ra41b($p77613,$kb904c,$ade7a3,$n1a49b); } if (!$v848b5){ unset ($yc6827['commenter-email']); $n1a49b='From: '. waed2(); foreach (o4975($saad65,$c0c83f) as $s39c63){ $hba570=$s39c63['AuthorEmail']; $e6fd85=md5($s39c63['ID'].$s39c63['Stamp'].'x'); $yc6827['unsubscribe-href']=d83c8('e2m_unsubscribe', array ( '*note' => $saad65, 'unsubscribe-email' => $hba570, 'unsubscribe-key' => $e6fd85 ) ); $p77613=$hba570; $ade7a3=d3e5c('comment-new-to-public',$yc6827); $kb904c=e2l_get_string( 'em--comment-new-to-public-subject', $yc6827 ); ra41b($p77613,$kb904c,$ade7a3,$n1a49b); } } } else { $_fp_error=FP_INSERT_ERROR; } } else { $kfd6f3=array ( 'ID' => $b69b97, 'AuthorName' => $zb0689, 'AuthorEmail' => $c0c83f, 'Text' => $x1cb25, 'IsSubscriber' => ((int)$q07d3d), 'LastModified' => time(), ); if (baa79('Comments',$kfd6f3)) { $result=(int)$b69b97; } else { $_fp_error=FP_UPDATE_ERROR; }; } } if ($f98ea6=='ajaxresult') return $k1fa03; else return array ((int)$y21158,$result,$w9d090); } function e2m_most_commented(){ global$settings,$_strings,$_config; $na0acf=@$_GET['period']; if ($na0acf=='')$na0acf=$_config['hot_period']; $d632a2=time()-w35c3($na0acf); $ff79b1="AND `IsVisible`=1 "; if (oe852())$ff79b1=''; return kd864(array ( 'query' => "SELECT `IsVisible`, `Stamp`, `NoteID` ID, count(*) c ". "FROM `". $settings['db']['table_prefix']."Comments` ". "WHERE (`Stamp` > ". $d632a2.") ". $ff79b1. "GROUP BY `NoteID` ". "ORDER BY c ". "DESC ". "LIMIT ".$settings['appearance']['notes_per_page'], 'query-returns-only-ids' => 1, 'limit' => $settings['appearance']['notes_per_page'], 'class' => 'most-commented', 'title' => e2l_get_string('pt--most-commented', array ('period' => $na0acf)), 'heading' => e2l_get_string('pt--most-commented', array ('period' => $na0acf)), 'no-notes-text' => $_strings['gs--no-such-notes'], )); } function e2m_favourites($parameters=array ()) { global$settings,$_strings; $ff79b1="AND `IsVisible`=1 "; if (oe852())$ff79b1=''; return kd864(array ( 'query' => "SELECT * FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND `IsFavourite`=1 ". $ff79b1 . "ORDER BY `Stamp` DESC", 'page' => $parameters['page'], 'candy' => 'e2m_favourites', 'parameters' => $parameters, 'class' => 'favourites', 'title' => $_strings['pt--favourites'], 'heading' => $_strings['pt--favourites'], 'no-notes-text' => $_strings['gs--no-favourites'], )); } function w35c3($na0acf){ if ('year'==$na0acf) return SECONDS_IN_A_YEAR; elseif ('month'==$na0acf) return SECONDS_IN_A_MONTH; elseif ('week'==$na0acf) return SECONDS_IN_A_DAY*7; elseif ('day'==$na0acf) return SECONDS_IN_A_DAY; else return PHP_INT_MAX; } function f8696($s8d777){ global$settings,$u097cc; if(__LOG)__log('Arbitrary list ('. $s8d777['_log'] .') {'); $he919a=r7f78(); $yf4ac8=null; if ($s8d777['cache'] and is_file($s8d777['cache-filename'])) { $yf4ac8=@unserialize(tcdf0($s8d777['cache-filename'])); } $pf957e=true; if ($s8d777['cache-filename-expires']) { if ($s8d777['cache'] and is_file($s8d777['cache-filename-expires'])) { $t07cc6=time(); $p09bcb=(int) @tcdf0($s8d777['cache-filename-expires']); if(__LOG)__log('List expires '. date('r',$p09bcb) .', now '. date('r',$t07cc6)); $pf957e=($t07cc6 < $p09bcb); } } $pdbb0c=array(); if ($s8d777['cache'] and is_array($yf4ac8) and $pf957e){ if(__LOG)__log('Retrieve cached ctree'); $pdbb0c=$yf4ac8; } else { if(__LOG)__log('Assemle cacheable ctree...'); $g4358b=array(); if (t0738($s8d777['query'])) { $result=b0d6b(); foreach($result as $a8ce4b => $q39a37){ $q39a37=w4627($q39a37['ID']); if ($q39a37['IsVisible'] and $q39a37['IsPublished']) { $saad65['_']['_id']=$q39a37['ID']; $saad65['_']['_ord']=$a8ce4b; $saad65['_']['_ord_max']=count($result)-1; $saad65['href']=d83c8('e2m_note', array ('*note' => $q39a37)); $saad65['time'] = array ($q39a37['Stamp'],r0923($q39a37)); $saad65['title']=q6f10(htmlspecialchars(vea9c($q39a37),ENT_NOQUOTES,HSC_ENC)); $pdbb0c[] = $saad65; } } $yf4ac8=$pdbb0c; if ($s8d777['cache']) { @v6e52($s8d777['cache-filename'],serialize($yf4ac8)); if ($s8d777['cache-filename-expires']) { @v6e52($s8d777['cache-filename-expires'],time()+$s8d777['expires-after']); } } } } foreach ($pdbb0c as $a8ce4b => $z9e366){ $pdbb0c[$a8ce4b]['current?'] = ($pdbb0c[$a8ce4b]['href']==$u097cc); } if(__LOG)__log('} // Arbitrary list @ '. round(r7f78()-$he919a,3)); return $pdbb0c; } function t09d1(){ global$settings,$u097cc,$_config; $d632a2=time()-w35c3($_config['hot_period']); return f8696(array ( '_log' => 'most_commented', 'cache' => CACHE_HOT, 'cache-filename' => CACHE_FILENAME_HOT, 'cache-filename-expires' => CACHE_FILENAME_HOT_EXPIRES, 'expires-after' => SECONDS_IN_A_DAY, 'query' => ( "SELECT `Stamp`, `NoteID` ID, count(*) c ". "FROM `". $settings['db']['table_prefix']."Comments` ". "WHERE `Stamp` > ". $d632a2 ." AND IsVisible='1'". "GROUP BY `NoteID` ". "ORDER BY c DESC LIMIT 10" ), )); } function i0256(){ global$settings,$u097cc,$_config; $d632a2=time()-w35c3($_config['popular_period']); return f8696(array ( '_log' => 'most_read', 'cache' => CACHE_POPULAR, 'cache-filename' => CACHE_FILENAME_POPULAR, 'cache-filename-expires' => CACHE_FILENAME_POPULAR_EXPIRES, 'expires-after' => SECONDS_IN_A_DAY, 'query' => ( "SELECT n.`ID`, n.`Title`, n.`IsFavourite`, a.`EntityID`, SUM(a.`HitCount`) HitCount ". "FROM `". $settings['db']['table_prefix']."Actions` a, ". "`". $settings['db']['table_prefix']."Notes` n  ". "WHERE a.`Stamp` > ". $d632a2 ." ". "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, HitCount DESC ". "LIMIT 10" ), )); } function gaca6(){ global$settings; $ea2e48='a:0:{}'; if(CACHE_FAVS and is_file(CACHE_FILENAME_FAVS)) { return filesize(CACHE_FILENAME_FAVS) > strlen($ea2e48); } if (t0738( "SELECT * ". "FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND `IsFavourite`=1 AND `IsVisible`=1 ". "LIMIT 1" )) { $result=b0d6b(); if(count($result) > 0){ if(CACHE_FAVS)v6e52(CACHE_FILENAME_FAVS,serialize('favourites-exist')); return true; } else { if(CACHE_FAVS)v6e52(CACHE_FILENAME_FAVS,$ea2e48); return false; } } } function e2m_password(){ global$settings,$_strings; $t2cb9d['title']=$_strings['pt--password']; $t2cb9d['heading']=$_strings['pt--password-for-blog']; $t2cb9d['form']='form-password'; $t2cb9d['form-password'] = array ( 'form-action' => d83c8('e2s_password_save'), 'submit-text' => $_strings['fb--change'], ); return $t2cb9d; } function e2m_sessions(){ global$settings,$_strings; $x2d6d8=l7785(); $t2cb9d['title']=$_strings['pt--sessions']; $t2cb9d['heading']=$_strings['pt--sessions']; $j161bc=array(); $u3c6e0=$_COOKIE[m8c3b('key')]; foreach ($x2d6d8['sessions'] as $a8ce4b => $z9e366){ $j161bc[] = array ( 'current?' => z4c49($u3c6e0)===$z9e366['key_hash'], 'opened' => array ((int)$z9e366['stamp'],r3211()), 'ip-address' => $z9e366['remote_ip'], 'source' => ($z9e366['remote_ip']=='127.0.0.1')? $_strings['gs--locally']:$z9e366['remote_ip'], 'title' => rcc31($z9e366['ua']), 'user-agent' => $z9e366['ua']? $z9e366['ua']:$_strings['gs--unknown'], ); } $j161bc=array_reverse($j161bc); $t2cb9d['sessions']['each']=$j161bc; if(count($j161bc) > 1){ $t2cb9d['form']='form-sessions'; $t2cb9d['form-sessions'] = array ( 'form-action' => d83c8('e2s_drop_other_sessions'), 'submit-text' => $_strings['fb--end-all-sessions-but-this'], ); } return $t2cb9d; } function e2m_sign_in(){ if (oe852()) { e2_go_to(d83c8('e2m_frontpage')); } else { return array (); } } function e2m_sign_out(){ global$_strings; $x2d6d8=l7785(); $i48bb9=-1; if(array_key_exists('sessions',$x2d6d8) and is_array($x2d6d8['sessions'])) { foreach ($x2d6d8['sessions'] as $a8ce4b => $z9e366){ $u3c6e0=$_COOKIE[m8c3b('key')]; if (z4c49($u3c6e0)===$z9e366['key_hash']) { $i48bb9=$a8ce4b; break; } } } if ($i48bb9 > -1) unset ($x2d6d8['sessions'][$i48bb9]); if (!n1d21($x2d6d8)) { f8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } jc64a('key',''); e2_go_to(); die; } function e2s_password_save(){ global$settings,$_strings; $v0512f=trim($_POST['old-password']); if (pa8cf($v0512f)) { $y88162=trim($_POST['new-password']); if ($y88162!=''){ if (@v6e52(USER_FOLDER. '/password-hash.psa',serialize(z4c49($y88162)))) { f8a40($_strings['gs--password-changed'],E2E_MESSAGE); e2_go_to(); } else { f8a40($_strings['er--could-not-change-password'],E2E_PERMISSIONS_ERROR); e2_go_to(d83c8('e2m_password')); } } else { f8a40($_strings['er--no-password-entered'],E2E_USER_ERROR); e2_go_to(d83c8('e2m_password')); } } else { f8a40($_strings['er--wrong-password'],E2E_USER_ERROR); e2_go_to(d83c8('e2m_password')); } die; } function e2s_sign_in_necessary(){ e2_go_to(d83c8('e2m_sign_in')); die; } function e2s_sign_in(){ global$_strings; $x2d6d8=l7785(); if($_SERVER['REQUEST_METHOD']=='POST'){ $g5f4dc=@$_POST['password']; $z6bc8e=@$_POST['is_public_pc']; } else { $g5f4dc=@$_GET['password']; $z6bc8e=false; } if (pa8cf($g5f4dc)) { $m21d6f=array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => te8ed($z6bc8e), 'ua' => $_SERVER['HTTP_USER_AGENT'], ); $x2d6d8['sessions'][] = $m21d6f; } elseif(strlen(trim($g5f4dc)) > 0){ ca711(); f8a40($_strings['er--wrong-password'],E2E_USER_ERROR); } if (!n1d21($x2d6d8)) { f8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); e2_go_to(); die; } p4930(); die; } function e2s_drop_other_sessions(){ global$_strings; $x2d6d8=l7785(); foreach ($x2d6d8['sessions'] as $a8ce4b => $z9e366){ $u3c6e0=$_COOKIE[m8c3b('key')]; if (z4c49($u3c6e0)===$z9e366['key_hash']) { $m21d6f=$z9e366; break; } } $x2d6d8['sessions'] = array ($m21d6f); if (!n1d21($x2d6d8)) { f8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } p4930(); die; } function pa8cf($g5f4dc){ $a8e9a8=@unserialize(tcdf0(USER_FOLDER. '/password-hash.psa')); return (z4c49($g5f4dc)===$a8e9a8 and trim($g5f4dc)!=''); } function te8ed($f2a2a4=false){ global$settings; $u3c6e0=z2a24(); $m3f363=z4c49($u3c6e0); jc64a('key',$u3c6e0, !$f2a2a4); return $m3f363; } function oe852(){ global $s1c0b7,$settings,$_auth_sessions; if (isset ($s1c0b7)) return $s1c0b7; $s1c0b7=false; if (isset ($_COOKIE[m8c3b('key')])) { $u3c6e0=$_COOKIE[m8c3b('key')]; $x2d6d8=l7785(); $x0f83b=array(); if(array_key_exists('sessions',$x2d6d8) and is_array($x2d6d8['sessions'])) { foreach ($x2d6d8['sessions'] as $m21d6f){ $x0f83b[] = $m21d6f['key_hash']; } $_auth_sessions['count']=count($x2d6d8['sessions']); } if(1){ $s1c0b7=(bool)in_array(z4c49($u3c6e0),$x0f83b,true); } if (!$s1c0b7){ jc64a('key',''); } } return $s1c0b7; } function z4c49($h25d90){ if(function_exists('sha1')) { return sha1($h25d90); } else { return substr(md5($h25d90).md5(' '.$h25d90),0,40); } } function l7785(){ if(is_file(USER_FOLDER.'auth.psa')) { $x2d6d8=unserialize(@file_get_contents(USER_FOLDER.'auth.psa')); if ($x2d6d8) return $x2d6d8; } return array (); } function n1d21($x2d6d8){ return acd2d(USER_FOLDER.'auth.psa',serialize($x2d6d8)); } function fff2e(){ if ($u3c6e0=$_COOKIE[m8c3b('key')]) { return 'Cookie: '. m8c3b('key') .'='. $u3c6e0 ."\r\n"; } return ''; } function oe68c($xc48ba){ global$_strings; $t74546=array ( 'e2m_write' => 'write', 'e2m_note_edit' => 'note-edit', 'e2m_note_withdraw' => 'note-withdraw', 'e2m_comment_edit' => 'comment-edit', 'e2m_comment_reply' => 'comment-reply', 'e2m_drafts' => 'drafts', 'e2m_draft' => 'draft', 'e2m_tag_edit' => 'tag-edit', 'e2m_name_and_author' => 'name-and-author', 'e2m_settings' => 'settings', 'e2m_password' => 'password', 'e2m_database' => 'database', 'e2m_sessions' => 'sessions', ); if(array_key_exists($xc48ba,$t74546)) { return e2l_get_string( 'gs--need-password-for-action', array ('action' => $_strings['gs--np-action-'. $t74546[$xc48ba]]) ); } else { return$_strings['gs--need-password']; } } function rcc31($h5269f){ global$_strings; if(strstr($h5269f,'iPhone')) return$_strings['gs--ua-iphone']; if(strstr($h5269f,'iPad')) return$_strings['gs--ua-ipad']; if(strstr($h5269f,'Opera'))$t2cb9d=$_strings['gs--ua-opera']; if(strstr($h5269f,'Firefox'))$t2cb9d=$_strings['gs--ua-firefox']; if(strstr($h5269f,'Chrome'))$t2cb9d=$_strings['gs--ua-chrome']; if(strstr($h5269f,'Safari') and !strstr($h5269f,'Chrome'))$t2cb9d=$_strings['gs--ua-safari']; if (!$t2cb9d)$t2cb9d=$_strings['gs--ua-unknown']; if(strstr($h5269f,'Macintosh')) { if ($t2cb9d)$t2cb9d.=' '. $_strings['gs--ua-for-mac']; } return $t2cb9d; } function e2j_check_password(){ $a8e9a8=@unserialize(tcdf0(USER_FOLDER. '/password-hash.psa')); $g5f4dc=''; if(array_key_exists('password',$_POST))$g5f4dc=$_POST['password']; ca711(); if (z4c49($g5f4dc)===$a8e9a8 and trim($g5f4dc)!=''){ die ('password-correct'); } die ('password-wrong'); } function z2a24(){ $qb04ec=''; $lb8d1b='0123456789abcdef'; for ($g865c0=0; $g865c0 < 40; $g865c0++)$qb04ec.=$lb8d1b[mt_rand(0,15)]; $qb04ec.=time(); $qb04ec=z4c49($qb04ec); return $qb04ec; } function ca711(){ if(is_file(USER_FOLDER. 'password-wait.psa')) { $kaf788=unserialize(tcdf0(USER_FOLDER. '/password-wait.psa')); if ($kaf788['delay'] < 5){ $kaf788['delay'] ++; } if(time()-$kaf788['time'] > SECONDS_IN_A_MINUTE){ $kaf788['delay']=0; } $kaf788['time']=time(); } else { $kaf788=array ( 'time' => time(), 'delay' => 5, ); } acd2d(USER_FOLDER.'password-wait.psa',serialize($kaf788)); sleep($kaf788['delay']); } function f7874(){ return md5('seсret'); } function m1305($nb45cf){ $u3c6e0=f7874(); $w16ec1=strlen($u3c6e0); $j2db95=strlen($nb45cf); $t2cb9d=''; for ($g865c0=0; $g865c0 < $j2db95+rand(16,64); ++ $g865c0){ if ($g865c0 > $j2db95){ $p462e1=rand(0,127); } elseif ($g865c0==$j2db95){ $p462e1=0; } else { $p462e1=ord($nb45cf[$g865c0]); } $y18e1b=chr(($p462e1+ord($u3c6e0[$g865c0%$w16ec1])) % 256); $t2cb9d.=$y18e1b; } $t2cb9d=base64_encode($t2cb9d); return $t2cb9d; } function ree85($nb45cf){ $u3c6e0=f7874(); $w16ec1=strlen($u3c6e0); $nb45cf=base64_decode($nb45cf); $j2db95=strlen($nb45cf); $t2cb9d=''; for ($g865c0=0; $g865c0 < $j2db95; ++ $g865c0){ $nd9468=(ord($nb45cf[$g865c0]) + 256-ord($u3c6e0[$g865c0%$w16ec1])) % 256; if ($nd9468===0) break; $t2cb9d.=chr($nd9468); } return $t2cb9d; } $_candies_installer=array ( 'e2s_build', 'e2m_info', 'e2m_install', 'e2j_check_db_config', 'e2j_list_databases', 'e2s_instantiate', 'e2s_install', 'e2s_update_perform', ); $_candies_public=array ( 'e2m_info', 'e2m_frontpage', 'e2m_frontpage_rss', 'e2m_note', 'e2m_note_comment', 'e2m_note_comments_rss', 'e2m_tags', 'e2m_tag', 'e2m_tag_rss', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_found_rss', 'e2m_comments', 'e2m_everything', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_unsubscribe', 'e2m_sign_out', 'e2s_sign_in', 'e2s_comment_process', 'e2s_search', 'e2s_scale_image', 'e2j_check_password', ); $_candies_with_notes=array ( 'e2m_frontpage', 'e2m_note', 'e2m_tag', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_comments', 'e2m_year', 'e2m_month', 'e2m_day', ); $_candies_spawning=array ( 'e2m_frontpage', 'e2m_note', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_write', 'e2m_drafts', 'e2m_draft', 'e2m_name_and_author', 'e2m_settings', 'e2m_password', 'e2m_database', 'e2m_timezone', 'e2m_sessions', ); $_candies_public=array_merge($_candies_public,$_candies_installer); $_candies_unabortable=array ( ); $_candies_parents=array ( 'e2m_note' => 'e2m_tag', 'e2m_tag' => 'e2m_tags', ); $_candies_indexable=array ( 'e2m_note', ); $_candies_indexable_conditionally=array ( 'e2m_frontpage', 'e2m_tag', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_tags', 'e2m_everything', ); $_candies_ajax=array ( 'e2j_check_db_config', 'e2j_list_databases', 'e2j_check_password', 'e2j_userpic_upload', 'e2j_file_upload', 'e2j_file_remove', 'e2j_note_livesave', 'e2m_note_flag_favourite', 'e2m_comment_flag_ajax', 'e2m_tag_flag_ajax', ); function e2_modes($parameters){ global $y11755,$content,$settings,$g1e2ad,$full_blog_url,$n589b3,$_config,$_strings,$s_addurl,$stopwatch,$_candy,$_db_error,$_candies_with_notes; if (!is_array($parameters))$parameters=array(); if(array_key_exists('~',$parameters)) { $i71860=$parameters['~']; } if(e2_is_installed()) { if(__LOG)__log('Blocks {'); if (gaca6()) { $content['favourites'] = array ( 'title' => $_strings['nm--favourites'], 'href' => d83c8('e2m_favourites'), ); } $content['popular'] = array ( 'title' => $_strings['nm--most-read'], ); $content['popular']['each']=i0256(); if(count($content['popular']['each']) < 10) unset($content['popular']['each']); if($settings['comments']['on']) { $u2888a=t09d1(); if(count($u2888a) > 0){ $content['most-commented'] = array ( 'title' => $_strings['nm--most-commented'], 'href' => d83c8('e2m_most_commented'), ); if ((@$settings['appearance']['hot_frontpage'])) { $content['most-commented']['each']=$u2888a; } } } if(count(y3873()) > 0){ $content['tags-menu']['each']=maf16($parameters); $content['tags-menu']['not-empty?']=count($content['tags-menu']['each']); } else { unset($content['hrefs']['tags']); } if(__LOG)__log('} // Blocks'); } } function r6f51(){ global$settings,$_strings; if ( array_key_exists('site_title',$settings) and trim($settings['site_title']) != '' ){ return trim($settings['site_title']); } else { return$_strings['e2--default-blog-title']; } } function q2640(){ global$settings,$_strings; if ( array_key_exists('author',$settings) and trim($settings['author']) != '' ){ return trim($settings['author']); } else { return$_strings['e2--default-blog-author']; } } function e2m_info(){ global$settings,$_config,$z57de2,$va57c1,$_template; $of1f71=array ( 'E2_VERSION' => E2_VERSION, 'E2_RELEASE' => E2_RELEASE, 'E2_UA_STRING' => E2_UA_STRING, '---', 'installed' => (bool)e2_is_installed(), 'server_name' => $z57de2, 'folder_on_server' => $va57c1, '---', 'request_logging' => $_config['request_logging'], 'default formatter' => $_config['default_formatter'], '---', 'theme' => $settings['template'], '---', 'Olba name' => $_template['name'], 'Olba max_image_width' => $_template['max_image_width'], 'Olba stack' => $_template['stack'], '---', 'Neasden' => substr(md5(file_get_contents('system/neasden/neasden.php')), 0,4), '---', ); echo '<pre>'; foreach ($of1f71 as $a8ce4b => $z9e366){ if ($z9e366=='---'){ echo "\n"; continue; } echo str_pad($a8ce4b,24); echo '\''; print_r($z9e366); echo '\''; echo "\n"; } echo '</pre>'; die; } function e2m_frontpage($parameters=array ()) { global$settings,$_config,$_strings; $i71860=$parameters['page']; $xd7e5d=$settings['appearance']['notes_per_page']; $j06d2e=d8ca0(true,true); if (oe852())$j06d2e+=d8ca0(true,false); $xae0fe=ceil($j06d2e/$xd7e5d); $qd29bb=CACHE_FILENAME_FRONTPAGE; if (oe852())$qd29bb=CACHE_FILENAME_FRONTPAGE_AUTHOR; if ($i71860 < 1) return e2_error404_mode(); if(CACHE_FRONTPAGE and $i71860==1 and is_file($qd29bb)) { $g4358b=@unserialize(tcdf0($qd29bb)); } if(CACHE_FRONTPAGE and $i71860==1 and is_array($g4358b)) { } else { if (($result=m50d7('web',$i71860)) === false){ f8a40($_strings['er--cannot-show-latest-notes'],E2E_DATABASE_ERROR); return array ( 'title' => htmlspecialchars(r6f51(),ENT_NOQUOTES,HSC_ENC), ); } $g4358b=array(); if(count($result) > 0){ foreach($result as $a8ce4b => $saad65){ $saad65['_']['_id']=$saad65['ID']; $saad65['_']['_title']=vea9c($saad65); $saad65['_']['_ord']=$a8ce4b; $saad65['_']['_ord_max']=count($result)-1; $se244c=d6791($saad65); $g4358b[] = $se244c; } } else { if ($i71860!=1) return e2_error404_mode(); } if(CACHE_FRONTPAGE and $i71860==1)v6e52($qd29bb,serialize($g4358b)); } $gb3b32['timeline?']=true; $gb3b32['count']=$xae0fe; $gb3b32['this'] = (int)$i71860; if ($xae0fe > 1){ if ($i71860 < $xae0fe)$gb3b32['earlier-href']=d83c8('e2m_frontpage', array ('page' => $i71860+1)); if ($i71860 > 1)$gb3b32['later-href']=d83c8('e2m_frontpage', array ('page' => $i71860-1)); $gb3b32['earlier-title']=$_strings['gs--earlier']; $gb3b32['later-title']=$_strings['gs--later']; } $kd5d3d=r6f51(); return array ( 'frontpage?' => (bool) ($i71860==1), 'title' => $kd5d3d, 'notes' => $g4358b, 'pages' => $gb3b32, ); } function e2m_frontpage_rss($parameters=array ()) { global$settings; $qd29bb=CACHE_FILENAME_FRONTPAGE_RSS; if(CACHE_FRONTPAGE_RSS and is_file($qd29bb)) { if(__LOG)__log('RSS: cached'); $zed0d3=@unserialize(tcdf0($qd29bb)); $rf0e70=filemtime($qd29bb); } else { if(__LOG)__log('RSS: not cached, will need to build'); $zed0d3=''; $rf0e70=0; if (($result=m50d7('rss')) !== false){ foreach($result as $saad65){ if ($saad65['IsVisible'] and $saad65['IsPublished']) { $zed0d3.=x307d($saad65); $rf0e70=max($rf0e70,$saad65['Stamp']); } } } if(CACHE_FRONTPAGE_RSS)v6e52($qd29bb,serialize($zed0d3)); } j7be5( $zed0d3, $rf0e70, $settings['site_title'], d83c8('e2m_frontpage') ); die; } function e2m_note_comments_rss($parameters=array ()) { global$settings,$_config,$_strings; $saad65=e2_published_noterec_with_parameters_($parameters); $rf0e70=0; $o93759=''; if ( ($result=o1baf($saad65['ID'],"AND `Stamp` > ". (time()-SECONDS_IN_A_MONTH) ." ORDER BY `Stamp` DESC LIMIT ". $_config['rss_items'])) !== false ){ foreach($result as $p06d4c){ if ($p06d4c['IsVisible'] and !$p06d4c['IsSpamSuspect']) { $o93759.=ac6e2($saad65,$p06d4c); $rf0e70=max($rf0e70,$p06d4c['Stamp']); } } } j7be5( $o93759, $rf0e70, $settings['site_title'] .', '. $_strings['gs--comments-on-post'] .': '. $saad65['Title'], d83c8('e2m_note', array ('*note' => $saad65)) ); die; } function e2m_tag_rss($parameters=array ()) { global$settings,$_config,$_strings; if(array_key_exists('_tagrec',$parameters)) { $ge4d23=$parameters['_tagrec']; } else { return e2_error404_mode(); } $y56790[] = ( "`". $settings['db']['table_prefix'] . "NotesKeywords`.KeywordID=". $ge4d23['ID'] ); $y56790=implode(' OR ',$y56790); $kc2b7b=$settings['db']['table_prefix']; return qcbfb( "INNER JOIN `". $kc2b7b."NotesKeywords` ". "ON `". $kc2b7b."NotesKeywords`.NoteID=`". $kc2b7b."Notes`.ID ". "WHERE (". $y56790 .") ". "ORDER BY `". $kc2b7b ."Notes`.`Stamp` DESC LIMIT ". $_config['rss_items'], $settings['site_title'] .', '. $_strings['gs--posts-tagged'] .': '. $ge4d23['Keyword'], d83c8('e2m_tag',$parameters) ); } function e2m_found_rss($parameters=array ()) { global$_config,$settings,$_strings; $parameters['query']=trim($parameters['query']); $x1b1cc=$parameters['query']; return qcbfb( "WHERE MATCH (`Title`, `Text`) AGAINST ('". e7928(preg_quote($x1b1cc)). "') ORDER BY `Stamp` DESC LIMIT ". $_config['rss_items'], $settings['site_title'] .', '. $_strings['gs--search-results'] .': '. $x1b1cc, d83c8('e2m_found',$parameters) ); } function qcbfb($h15c46,$kd5d3d,$y2a304){ global$settings; $c8bb85=''; $rf0e70=0; if ((t0738( "SELECT `". $settings['db']['table_prefix']."Notes`.* ". "FROM `". $settings['db']['table_prefix']."Notes` ". $h15c46 )) !== false){ $result=b0d6b(); foreach($result as $saad65){ if ($saad65['IsVisible'] and $saad65['IsPublished']) { $c8bb85.=x307d($saad65); $rf0e70=max($rf0e70,$saad65['Stamp']); } } } j7be5( '',$c8bb85,$rf0e70, $kd5d3d, $y2a304 ); die; } function v3010($kd5d3d,$qe8fab){ global$_newsfeeds; $m336a4=array ('title' => $kd5d3d,'href' => $qe8fab); $_newsfeeds[] = $m336a4; } function x307d($saad65){ global$settings,$z57de2; $w90141=d83c8('e2m_note', array ('*note' => $saad65)); $d59aeb=hce23($saad65['ID']); foreach ($d59aeb as $g865c0 => $nd7df5){ $d59aeb[$g865c0] = ( '<a href="'. d83c8('e2m_tag', array ('tag-urlname' => $nd7df5['URLName'])). '">'. htmlspecialchars($nd7df5['Keyword'],ENT_NOQUOTES,HSC_ENC). '</a>' ); } $c8bb85=''; $c8bb85.='<item>'; $c8bb85.='<title>'. (q6f10(htmlspecialchars(vea9c($saad65),ENT_NOQUOTES,HSC_ENC))) .'</title>'; $c8bb85.='<guid isPermaLink="true">'. $w90141 .'</guid>'; $c8bb85.='<link>'. $w90141 .'</link>'; if (@$settings['comments']['on']) { $c8bb85.='<comments>'. $w90141 .'</comments>'; } $t67daf=x154e($saad65['FormatterID'], @$saad65['Text'],'full'); $t67daf=$t67daf['text-final']; for ($g865c0=0; $g865c0 < strlen($t67daf); ++$g865c0){ if(ord($t67daf[$g865c0]) < 32 and !in_array(ord($t67daf[$g865c0]), array (10,13))) { $t67daf[$g865c0]=''; } } $c8bb85.='<description>'; $c8bb85.=htmlspecialchars($t67daf,ENT_NOQUOTES,HSC_ENC); $c8bb85.='</description>'; $r588e0 = pa846('D, d M Y H:i:s ',$saad65['Stamp']) . qd536($saad65['Stamp']); $c8bb85.='<pubDate>'. $r588e0 .'</pubDate>'; $c8bb85.='</item>'; return $c8bb85; } function ac6e2($saad65,$p06d4c){ global$settings,$z57de2,$_strings; $w90141=d83c8('e2m_note', array ('*note' => $saad65)); $c0ad4f = '<b>'. htmlspecialchars($p06d4c['AuthorName'],ENT_NOQUOTES,HSC_ENC) .'</b>, '. $_strings['gs--comment-on-post'] .' <a href="'. $w90141 .'">"'. q6f10(htmlspecialchars(vea9c($saad65),ENT_NOQUOTES,HSC_ENC)) .'"</a>'; $c8bb85=''; $c8bb85.='<item>'; $c8bb85.='<title>'. strip_tags($c0ad4f) .'</title>'; $c8bb85.='<link>'. $w90141 .'</link>'; $t67daf=$c0ad4f.':'; $t67daf.='<br /><br />'; $b64be6=x154e($saad65['FormatterID'],$p06d4c['Text'],'simple'); $b64be6=$b64be6['text-final']; $t67daf.=$b64be6; for ($g865c0=0; $g865c0 < strlen($t67daf); ++$g865c0){ if(ord($t67daf[$g865c0]) < 32 and !in_array(ord($t67daf[$g865c0]), array (10,13))) { $t67daf[$g865c0]=''; } } $c8bb85.='<description>'; $c8bb85.=htmlspecialchars($t67daf,ENT_NOQUOTES,HSC_ENC); $c8bb85.='</description>'; $r588e0 = pa846('D, d M Y H:i:s ',$p06d4c['Stamp']) . qd536($p06d4c['Stamp']); $c8bb85.='<pubDate>'. $r588e0 .'</pubDate>'; $c8bb85.='</item>'; return $c8bb85; } function j7be5($b691d5,$rf0e70,$kd5d3d,$y2a304){ global$settings; $content=array ( 'title' => htmlspecialchars($kd5d3d,ENT_NOQUOTES,HSC_ENC), 'link' => $y2a304, 'generator' => E2_UA_STRING, 'items' => $b691d5, ); if(array_key_exists('description',$settings)) { $content['description']=htmlspecialchars($settings['description'],ENT_NOQUOTES,HSC_ENC); } $k54870=gmdate('r',$rf0e70); $w1872a=md5($rf0e70); header('Content-type: application/xml; charset=utf-8'); header('Last-modified: '.$k54870); header('Etag: '.$w1872a); header('Cache-Control: public'); header('Expires: '. date('r',$rf0e70+SECONDS_IN_A_DAY)); $a0c3cd=isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])? stripslashes($_SERVER['HTTP_IF_MODIFIED_SINCE']): false; $xc3522=isset($_SERVER['HTTP_IF_NONE_MATCH'])? stripslashes($_SERVER['HTTP_IF_NONE_MATCH']): false; if ( !$a0c3cd && !$xc3522 or $xc3522 && $xc3522!=$w1872a or $a0c3cd && $a0c3cd!=$k54870 ){ $x92eac=DEFAULTS_FOLDER.'rss/rss.tmpl.php'; if(is_file($x92eac)) { ob_start(); include $x92eac; $c8bb85=ob_get_contents(); ob_end_clean(); } echo $c8bb85; } else { header('HTTP/1.1 304 Not Modified'); } } function e2m_year($parameters=array ()) { global$_strings,$settings; $g84cdc=$parameters['year']; $k09d6c=e2l_get_string('pt--nth-year', array ('year' => $g84cdc)); if (!p1665($g84cdc)) { return e2_error404_mode(); } $ve6e7d=gmmktime(0,0,0,1,1,$g84cdc-1); $n029bd=gmmktime(0,0,0,1,1,$g84cdc+1); list ($d8aebd,$m5a7f3)=e2__fruitful_neighbours_with_ymd_($g84cdc); $za6d40='e2m_year'; if ($d8aebd){ $gb3b32['prev-href']=d83c8( $za6d40,e2__parameters_with_timestamp_($d8aebd) ); $gb3b32['prev-jump?'] = (bool) (gmdate('Y',$ve6e7d)!=gmdate('Y',$d8aebd)); $gb3b32['prev-title']=gmdate('Y',$d8aebd); } if ($m5a7f3){ $gb3b32['next-href']=d83c8( $za6d40,e2__parameters_with_timestamp_($m5a7f3) ); $gb3b32['next-jump?'] = (bool) (gmdate('Y',$n029bd)!=gmdate('Y',$m5a7f3)); $gb3b32['next-title']=gmdate('Y',$m5a7f3); } $gb3b32['timeline?']=false; $gb3b32['this']=$g84cdc; $gb3b32['this-title']=$g84cdc; $ob2442=rcc02('start'); $i8dbc7=rcc02('end'); if ( $g84cdc==s5a2f('Y',$ob2442['stamp'],$ob2442['timezone']) ) { $pfa098=s5a2f('m',$ob2442['stamp'],$ob2442['timezone']); } else { $pfa098=1; } if ( $g84cdc==pa846('Y',time()) ) { $mfd384=pa846('m',time()); } else { $mfd384=12; } $w6eac3=ob92c($g84cdc); for ($v7436f=1; $v7436f <= 12; ++ $v7436f){ $f7f769=gmmktime(0,0,0,$v7436f,1,$g84cdc); $ud039b[$v7436f] = array ( 'number' => $v7436f, 'start-time' => array ($f7f769,r3211()), 'href' => gmdate('Y/m/',$f7f769), 'real?' => $v7436f >= $pfa098 and $v7436f <= $mfd384, 'fruitful?' => @in_array(gmdate('n',$f7f769),$w6eac3), ); } list ($l7b314,$ja1f20)=f5273($g84cdc); t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "AND `Stamp` BETWEEN ". $l7b314 ." ". "AND ". $ja1f20 ." ". "ORDER BY `Stamp`" ); $result=b0d6b(); $g4358b=l28df($result,$g84cdc); return array ( 'title' => $k09d6c, 'heading' => $k09d6c, 'pages' => $gb3b32, 'year' => (int)$g84cdc, 'year-months' => $ud039b, 'notes-list' => $g4358b, ); } function e2m_month($parameters=array ()) { global$_strings,$settings; $g84cdc= $parameters['year']; $v7436f=$parameters['month']; $k09d6c=e2l_get_string( 'pt--nth-month-of-nth-year', array ('year' => $g84cdc,'month' => $v7436f) ); if (!p1665($g84cdc,$v7436f)) { return e2_error404_mode(); } $ve6e7d=gmmktime(0,0,0,$v7436f-1,1,$g84cdc); $n029bd=gmmktime(0,0,0,$v7436f+1,1,$g84cdc); list ($d8aebd,$m5a7f3)=e2__fruitful_neighbours_with_ymd_($g84cdc,$v7436f); $za6d40='e2m_month'; if ($d8aebd){ $gb3b32['prev-href']=d83c8( $za6d40,e2__parameters_with_timestamp_($d8aebd) ); $gb3b32['prev-jump?'] = (bool) (gmdate('Y/m',$ve6e7d)!=gmdate('Y/m',$d8aebd)); $gb3b32['prev-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$d8aebd),'month' => gmdate('n',$d8aebd) ) ); } if ($m5a7f3){ $gb3b32['next-href']=d83c8( $za6d40,e2__parameters_with_timestamp_($m5a7f3) ); $gb3b32['next-jump?'] = (bool) (gmdate('Y/m',$n029bd)!=gmdate('Y/m',$m5a7f3)); $gb3b32['next-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$m5a7f3),'month' => gmdate('n',$m5a7f3) ) ); } $gb3b32['timeline?']=false; $gb3b32['this-title']=$k09d6c; list ($l7b314,$ja1f20)=f5273($g84cdc,$v7436f); t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "AND `Stamp` BETWEEN ". $l7b314 ." ". "AND ". $ja1f20 ." ". "ORDER BY `Stamp`" ); $result=b0d6b(); $g4358b=l28df($result,$g84cdc,$v7436f); $te70c4['title']=$k09d6c; $te70c4['heading']=$k09d6c; $te70c4['pages']=$gb3b32; $te70c4['year'] = (int)$g84cdc; $te70c4['month'] = (int)$v7436f; $te70c4['month-days']=e2_pack_month_days_with_ymd_($g84cdc,$v7436f,false); $te70c4['notes-list']=$g4358b; return $te70c4; } function e2m_day($parameters=array ()) { global$_strings; $g84cdc= (int)$parameters['year']; $v7436f=(int)$parameters['month']; $u628b7= (int)$parameters['day']; if (!(p1665($g84cdc,$v7436f,$u628b7))) { return e2_error404_mode(); } $k09d6c=e2l_get_string( 'pt--nth-day-of-nth-month-of-nth-year', array ('year' => $g84cdc,'month' => $v7436f,'day' => $u628b7) ); $ve6e7d=gmmktime(0,0,0,$v7436f,$u628b7-1,$g84cdc); $n029bd=gmmktime(0,0,0,$v7436f,$u628b7+1,$g84cdc); list ($d8aebd,$m5a7f3)=e2__fruitful_neighbours_with_ymd_($g84cdc,$v7436f,$u628b7); $za6d40='e2m_day'; if ($d8aebd){ $gb3b32['prev-href']=d83c8( $za6d40,e2__parameters_with_timestamp_($d8aebd) ); $gb3b32['prev-jump?'] = (bool) (gmdate('Y/m/d',$ve6e7d)!=gmdate('Y/m/d',$d8aebd)); $gb3b32['prev-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$d8aebd),'month' => gmdate('n',$d8aebd),'day' => gmdate('j',$d8aebd), ) ); } if ($m5a7f3){ $gb3b32['next-href']=d83c8( $za6d40,e2__parameters_with_timestamp_($m5a7f3) ); $gb3b32['next-jump?'] = (bool) (gmdate('Y/m/d',$n029bd)!=gmdate('Y/m/d',$m5a7f3)); $gb3b32['next-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$m5a7f3),'month' => gmdate('n',$m5a7f3),'day' => gmdate('j',$m5a7f3), ) ); } $gb3b32['timeline?']=false; $gb3b32['this-title']=$k09d6c; if (($result=kf9fb($g84cdc,$v7436f,$u628b7)) !== false){ $result=array_reverse($result); foreach($result as $a8ce4b => $saad65){ if ($saad65['IsVisible'] or oe852()) { $saad65['_']['_id']=$saad65['ID']; $saad65['_']['_ord']=k; $saad65['_']['_ord_max']=count($result)-1; $g4358b[] = d6791($saad65); } } } $te70c4['title']=$k09d6c; $te70c4['heading']=$k09d6c; $te70c4['pages']=$gb3b32; $te70c4['notes']=$g4358b; $te70c4['month-days']=e2_pack_month_days_with_ymd_($g84cdc,$v7436f,$u628b7); return $te70c4; } function e2m_everything($parameters=array ()) { global$_strings,$settings; $g4358b=null; if(CACHE_FULLLIST and is_file(CACHE_FILENAME_FULLLIST)) { $g4358b=@unserialize(tcdf0(CACHE_FILENAME_FULLLIST)); if(__LOG)__log('Everything: retrieving from cache...'); } if (!is_array($g4358b)) { if(__LOG)__log('Everything: retrieving from database...'); t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "ORDER BY `Stamp`" ); $result=b0d6b(); if(__LOG)__log('Everything: preparing notes list...'); $g4358b=l28df($result); if(__LOG)__log('Everything: saving cache...'); if(CACHE_FULLLIST)v6e52(CACHE_FILENAME_FULLLIST,serialize($g4358b)); } $b1f525=count($g4358b); $k09d6c=e2l_get_string('pt--n-posts', array ('number' => $b1f525)); if(array_key_exists('part',$_GET) and array_key_exists('of',$_GET)) { if(__LOG)__log('Everything: splitting into parts...'); $bf4c93=$_GET['part']; $g8bf88=$_GET['of']; $k09d6c.=' ('. e2l_get_string('gs--part-x-of-y', array ('part' => $bf4c93,'of' => $g8bf88)) .')'; $y895e3=$b1f525/$g8bf88; $rd98a0=($bf4c93-1)*$y895e3; $s01b6e=$bf4c93*$y895e3; $g4358b=array_slice($g4358b,round($rd98a0),round($s01b6e-round($rd98a0))); } if(__LOG)__log('Everything: done, returning'); return array ( 'class' => 'everything', 'title' => $k09d6c, 'heading' => $k09d6c, 'notes-list' => $g4358b, ); } function e2_pack_month_days_with_ymd_($g84cdc,$v7436f,$u628b7){ $ia6933=s5a2f('t',gmmktime(0,0,0,$v7436f,1,$g84cdc),r3211()); $ob2442=rcc02('start'); $i8dbc7=rcc02('end'); if ( $g84cdc .'/'. $v7436f == s5a2f('Y/n',$ob2442['stamp'],$ob2442['timezone']) ) { $a42eb4=s5a2f('d',$ob2442['stamp'],$ob2442['timezone']); } else { $a42eb4=1; } if ( $g84cdc .'/'. $v7436f == pa846('Y/n',time()) ) { $td5f50=pa846('d',time()); } else { $td5f50=$ia6933; } $he4602=f82dc($g84cdc,$v7436f); for ($g865c0=1; $g865c0 <= $ia6933; ++ $g865c0){ $f7f769=gmmktime(0,0,0,$v7436f,$g865c0,$g84cdc); $t271c1[$g865c0] = array ( 'number' => $g865c0, 'start-time' => array ($f7f769,r3211()), 'href' => gmdate('Y/m/d/',$f7f769), 'this?' => (bool) ($g865c0==$u628b7), 'real?' => $g865c0 >= $a42eb4 and $g865c0 <= $td5f50, 'fruitful?' => @in_array(gmdate('d',$f7f769),$he4602), ); } return $t271c1; } function p1665($g84cdc,$v7436f=false,$u628b7=false){ $ob2442=rcc02('start'); if ($ob2442===false){ return false; } $wc1f1e=s5a2f('Y',$ob2442['stamp'],$ob2442['timezone']); $tebeb3=pa846('Y',time()); if ($v7436f===false){ return (bool) ( $g84cdc >= $wc1f1e and $g84cdc <= $tebeb3 ); } else { $r782fc=s5a2f('n',$ob2442['stamp'],$ob2442['timezone']); $u13dd1=pa846('n',time()); if ($u628b7===false){ return (bool) ( $v7436f >= 1 and $v7436f <= 12 and ( ($g84cdc > $wc1f1e and $g84cdc < $tebeb3) or ($g84cdc==$wc1f1e and $v7436f >= $r782fc) or ($g84cdc==$tebeb3 and $v7436f <= $u13dd1) ) ); } else { $a7a9c0=s5a2f('j',$ob2442['stamp'],$ob2442['timezone']); $b23209=pa846('j',time()); if(1){ return (bool) ( checkdate($v7436f,$u628b7,$g84cdc) and ( ($g84cdc > $wc1f1e and $g84cdc < $tebeb3) or ($g84cdc==$wc1f1e and $v7436f > $r782fc) or ($g84cdc==$wc1f1e and $v7436f==$r782fc and $u628b7 >= $a7a9c0) or ($g84cdc==$tebeb3 and $v7436f < $u13dd1) or ($g84cdc==$tebeb3 and $v7436f==$u13dd1 and $u628b7 <= $b23209) ) ); } } } } function e2__fruitful_neighbours_with_ymd_($g41529,$k6f8f5=false,$e8277e=false){ global$settings,$_db; list ($p3d2fa,$o9468c)=f5273($g41529,$k6f8f5,$e8277e); $fada4b=SECONDS_IN_A_DAY; if ($e8277e===false)$fada4b=SECONDS_IN_A_MONTH; if ($k6f8f5===false)$fada4b=SECONDS_IN_A_YEAR; if (!oe852())$ff79b1="`IsVisible`=1 AND "; if (r0f7c()) { $_db['result']=mysql_query( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $settings['db']['table_prefix']. "Notes` ". "WHERE `IsPublished`=1 AND " .@$ff79b1. "Stamp < '". ($o9468c-$fada4b) ."' ". "ORDER BY Stamp DESC", $_db['link'] ); while ($z6438c=@mysql_fetch_array($_db['result'],MYSQL_ASSOC)) { list ($g84cdc,$v7436f,$u628b7)=explode('/', s5a2f('Y/n/j',$z6438c['Stamp'],r0923($z6438c)) ); $c7474d=$g41529*10000 + ($k6f8f5? ($k6f8f5*100):0) + ($e8277e? $e8277e:0); $nbd8da=$g84cdc*10000 + ($k6f8f5? ($v7436f*100):0) + ($e8277e? $u628b7:0); if ($nbd8da < $c7474d){ $tbf025=gmmktime(0,0,0,$v7436f,$u628b7,$g84cdc); break; } } $_db['result']=mysql_query( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $settings['db']['table_prefix']. "Notes` ". "WHERE `IsPublished`=1 AND " .@$ff79b1. "Stamp > '". ($p3d2fa+$fada4b) ."' ". "ORDER BY Stamp", $_db['link'] ); while ($z6438c=@mysql_fetch_array($_db['result'],MYSQL_ASSOC)) { list ($g84cdc,$v7436f,$u628b7)=explode('/', s5a2f('Y/n/j',$z6438c['Stamp'],r0923($z6438c)) ); $c7474d=$g41529*10000 + ($k6f8f5? ($k6f8f5*100):0) + ($e8277e? $e8277e:0); $nbd8da=$g84cdc*10000 + ($k6f8f5? ($v7436f*100):0) + ($e8277e? $u628b7:0); if ($nbd8da > $c7474d){ $k8dc98=gmmktime(0,0,0,$v7436f,$u628b7,$g84cdc); break; } } return array ($tbf025,$k8dc98); } } function e2__parameters_with_timestamp_($a96b8c){ list ( $parameters['year'], $parameters['month'], $parameters['day'] ) = explode('/',gmdate('Y/m/d',$a96b8c)); return$parameters; } function l28df($ic2d18,$g84cdc=false,$v7436f=false){ $v229c3=0; $g4358b=array(); $cf09d8=''; $g4358b=array(); $gcc73f=array(); foreach ($ic2d18 as $a8ce4b => $q39a37){ $saad65['href'] = d83c8('e2m_note', array ('*note' => $q39a37)); $saad65['time'] = array ((int)$q39a37['Stamp'],r0923($q39a37)); $saad65['last-modified'] = array ((int)$q39a37['LastModified'],r0923($q39a37)); $saad65['favourite?'] = (bool) ($q39a37['IsFavourite'] && $q39a37['IsPublished']); if ( ($g84cdc and $v7436f and ( ((int)$g84cdc) .'/'. ((int)$v7436f) == s5a2f('Y/n',$q39a37['Stamp'],r0923($q39a37)) )) or ($g84cdc and !$v7436f and ( (int)$g84cdc == s5a2f('Y',$q39a37['Stamp'],r0923($q39a37)) )) or (!$g84cdc and !$v7436f) ) { array_unshift($g4358b,$saad65); array_unshift($gcc73f,str_replace("\n",' ',vea9c($q39a37))); } } $y789f1=implode("\n",$gcc73f); if(strlen($y789f1) < 20000){ $y789f1=q6f10(htmlspecialchars($y789f1,ENT_NOQUOTES,HSC_ENC)); $gcc73f=explode("\n",$y789f1); } foreach ($g4358b as $a8ce4b => $z9e366){ $g4358b[$a8ce4b]['title']=$gcc73f[$a8ce4b]; } return $g4358b; } function e2s_sync(){ e2_drop_all_kinds_of_cache(); die ('All caches clean.'); } function e2_note_cache_filename_with_id_($lb80bb){ return str_replace('*',$lb80bb,CACHE_FILENAMES_NOTES); } function e2_drop_caches_for_note_($y21158){ if(__LOG)__log('Caches: Drop caches for note id '. $y21158); ie2f1(); j22e7(); @unlink(e2_note_cache_filename_with_id_($y21158)); @unlink(e2_note_cache_filename_with_id_($y21158 .'-comments')); @unlink(CACHE_FILENAME_HOT); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_RSS); @unlink(CACHE_FILENAME_FULLLIST); } function t7996(){ if(__LOG)__log('Caches: Drop notes caches'); xc5a6(CACHE_FILENAMES_NOTES); xc5a6(CACHE_FILENAMES_NOTES_COMMENTS); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_RSS); } function ie2f1(){ if(__LOG)__log('Caches: Drop notes counts cache'); xc5a6(CACHE_FILENAMES_NOTES_COUNTS); } function j22e7(){ if(__LOG)__log('Caches: Drop egde time info cache'); xc5a6(CACHE_FILENAMES_EDGE_TIMEINFO); } function e2_drop_all_kinds_of_cache(){ if(__LOG)__log('Caches: Drop all kinds of caches'); xc5a6(CACHES_FOLDER.'*'); return true; } function j4e27($n139c8){ global$_template,$_config; if(__LOG)__log('Olba: Prepare template <'. $n139c8 .'>'); $naf10b=array(); $t8598c=$n139c8; $m620f7=TEMPLATES_FOLDER.$t8598c .'/'; $h1b14d=false; if ( $n139c8!='' and !array_key_exists('themeless',$_GET) ){ if ( is_dir($m620f7) and is_file($m620f7 .'/theme-info.php') ) { while (1){ $m620f7=TEMPLATES_FOLDER.$t8598c .'/'; array_push($naf10b,$m620f7); $u38226=include $m620f7 .'/theme-info.php'; $o4e502[$m620f7]=$u38226; if(array_key_exists('max_image_width',$u38226)) { if ($h1b14d===false){ $h1b14d=$u38226['max_image_width']; } } if(array_key_exists('based_on',$u38226)) { $t8598c=$u38226['based_on']; } else { break; } } } else { } } $m620f7=DEFAULT_TEMPLATE_FOLDER; array_push($naf10b,$m620f7); $u38226=include $m620f7 .'/theme-info.php'; $o4e502[$m620f7]=$u38226; if(array_key_exists('max_image_width',$u38226)) { if ($h1b14d===false){ $h1b14d=$u38226['max_image_width']; } } if ($h1b14d===false){ $h1b14d=$_config['max_image_width']; } $_template['name']=$n139c8; $_template['max_image_width']=$h1b14d; $_template['stack']=$naf10b; $_template['infos']=$o4e502; }; function c53ee($nd436e){ global$content; ++ $_olba_includes; include $nd436e; } function y6a97($t52678){ if(0){ echo '<div style="background: #ff0">'.$t52678.'</div>'; } if(is_dir(EXTRAS_FOLDER)) { $g71cae=EXTRAS_FOLDER.$t52678 .'.tmpl.php'; if(is_file($g71cae)) { c53ee($g71cae); } } return ''; } function i166b($t52678){ global$_template,$_olba_includes; $g71cae='templates/'. $t52678 .'.tmpl.php'; if ($nd436e=e2o__usable_file_with_basename_($g71cae)) { if(__LOG)__log('Olba: Apple template <'. $nd436e .'>'); c53ee($nd436e); } else { m1928($g71cae); } } function obc21(){ global$_config; if ( @$_config['raw_template_data'] or @$_config['raw_template_data_with_param'] and array_key_exists('raw',$_GET) ) { $w3f7d9='raw'; } else { $w3f7d9='main'; } return i166b($w3f7d9); } function m1928($r8b7af){ qf1da($r8b7af,'_olba_missing_templates'); } function nd4c1($t45ac4){ qf1da($t45ac4 .'.css','_olba_used_stylesheets'); } function cd00a($a3205c){ qf1da($a3205c .'.js','_olba_used_scripts'); } function d16f0($qe8acc){ foreach (array (SYSTEM_LIBRARY_FOLDER,USER_LIBRARY_FOLDER) as $q71379){ foreach(glob($q71379.$qe8acc .'/*') as $w8c7dd){ $aabf77=pathinfo($w8c7dd,PATHINFO_EXTENSION); if ($aabf77=='js'){ qf1da($w8c7dd,'_olba_used_scripts'); } if ($aabf77=='css'){ qf1da($w8c7dd,'_olba_used_stylesheets'); } } } } function ne655(){ global$_olba_missing_templates; if (isset ($_olba_missing_templates)) { return array_unique($_olba_missing_templates); } } function f94dd(){ global$_template,$_config,$settings; if($_config['list_system_theme']) { $tccf6b['']=DEFAULT_TEMPLATE_FOLDER; } if ($he1260=@opendir(TEMPLATES_FOLDER)) { while (false !== ($l1f769=readdir($he1260))) { if(is_dir(TEMPLATES_FOLDER. $l1f769) and $l1f769!='.' and $l1f769!='..'){ if(is_file(TEMPLATES_FOLDER.$l1f769 .'/theme-info.php')) { $tccf6b[$l1f769]=TEMPLATES_FOLDER.$l1f769 .'/'; } } } closedir($he1260); } $j10ae9=array(); foreach ($tccf6b as $zb0689 => $k85114){ $u38226=include $k85114 .'theme-info.php'; $tc2657=$u38226['display_name']; if (!is_file($ube5fb=$k85114.$w8c7dd .'preview.png')) { $ube5fb=DEFAULTS_FOLDER.'preview.png'; } if(is_array($tc2657)) { if(array_key_exists($settings['language'],$tc2657)) { $tc2657=$tc2657[$settings['language']]; } else { $tc2657=array_shift($tc2657); } } $j10ae9[] = array ( 'name' => $zb0689, 'display-name' => $tc2657, 'current?' => (bool) ($zb0689==$_template['name']), 'preview' => $ube5fb, ); } return $j10ae9; } function j1492($i435ed){ return e2o__usable_file_with_basename_('images/'. $i435ed); } function z576f($t45ac4){ global$_template; $f954eb='styles/'. $t45ac4 .'.css'; $j95aa1=array(); foreach($_template['stack'] as $m620f7){ if(is_file($i435ed=$m620f7.$f954eb)) { $j95aa1[] = $i435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$m620f7]) and in_array($t45ac4,$_template['infos'][$m620f7]['reset_styles']) ) { break; } } $j95aa1=array_reverse($j95aa1); } function w37ca(){ global$_olba_used_stylesheets,$_template; if (!isset ($_olba_used_stylesheets)) return; $_olba_used_stylesheets=array_unique($_olba_used_stylesheets); $bc7f50=array(); foreach($_olba_used_stylesheets as $t45ac4){ if(is_file($t45ac4)) { $bc7f50[] = $t45ac4; continue; } if(is_file($i435ed=USER_FOLDER .'js/'. $t45ac4)) { $bc7f50[] = $i435ed; } $f954eb='styles/'. $t45ac4; $j95aa1=array(); foreach($_template['stack'] as $m620f7){ if(is_file($i435ed=$m620f7.$f954eb)) { $j95aa1[] = $i435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$m620f7]) and in_array($t45ac4,$_template['infos'][$m620f7]['reset_styles']) ) { break; } } $j95aa1=array_reverse($j95aa1); $bc7f50=array_merge($bc7f50,$j95aa1); } return $bc7f50; } function b4753(){ global$_olba_used_scripts; if (!isset ($_olba_used_scripts)) return; $_olba_used_scripts=array_unique($_olba_used_scripts); $id6c58=array(); foreach($_olba_used_scripts as $a3205c){ if(is_file($a3205c)) { $id6c58[] = $a3205c; continue; } if(is_file($p9d679=USER_FOLDER .'js/'. $a3205c)) { $id6c58[] = $p9d679; } $f954eb='js/'. $a3205c; if ($p9d679=e2o__usable_file_with_basename_($f954eb)) { $id6c58[] = $p9d679; } } return $id6c58; } function qf1da($e2063c,$of1f71){ if (!isset ($GLOBALS[$of1f71])) { $GLOBALS[$of1f71] = array ($e2063c); } else { $GLOBALS[$of1f71][] = $e2063c; } } function e2o__usable_file_with_basename_($f954eb){ global$_template; foreach($_template['stack'] as $m620f7){ if(is_file($i435ed=$m620f7.$f954eb)) { return $i435ed; } } return ''; } function e2s_search(){ global$settings; $x1b1cc=@$_POST['query']; $x1b1cc=str_replace(' ','+',$x1b1cc); e2_go_to(d83c8('e2m_found', array ('query' => $x1b1cc))); die; } function e2m_found($parameters=array ()) { global$settings,$_strings; $parameters['query']=trim($parameters['query']); $x1b1cc=$parameters['query']; if (!$x1b1cc){ return array ( 'title' => $_strings['pt--search-query-empty'], 'heading' => $_strings['pt--search'], 'no-notes-text' => $_strings['gs--search-query-empty'], ); } if(mb_strlen($x1b1cc) < 4){ return array ( 'title' => $_strings['pt--search-query-too-short'], 'heading' => $_strings['pt--search'], 'no-notes-text' => $_strings['gs--search-query-too-short'], ); } $ff79b1="AND `IsVisible`=1 "; if (oe852())$ff79b1=''; $d11128=false; if (t0738( "SELECT * FROM `". $settings['db']['table_prefix']."Keywords` ". "WHERE `Keyword`='".e7928($x1b1cc)."'" )) { $ifa816=b0d6b(); if (isset ($ifa816[0]['ID'])) { $d11128=array ( 'href' => d83c8( 'e2m_tag', TRANS_TAGS_UTF8_URLS ? array ('tag' => htmlspecialchars($ifa816[0]['Keyword'],ENT_NOQUOTES,HSC_ENC)) : array ('tag-urlname' => $ifa816[0]['URLName']) ), 'name' => htmlspecialchars($x1b1cc,ENT_NOQUOTES,HSC_ENC), ); } } $v75006=$_strings['gs--nothing-found']; $g3ad42=d83c8('e2m_found_rss', array ('query' => htmlspecialchars($x1b1cc,ENT_NOQUOTES,HSC_ENC))); v3010( $_strings['pt--search-results'] .': '. htmlspecialchars($x1b1cc,ENT_NOQUOTES,HSC_ENC),$g3ad42 ); $j36a38=e7928(preg_quote($x1b1cc)); $oeb31b=( "SELECT * FROM `". $settings['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND MATCH (`Title`, `Text`) AGAINST ('". $j36a38 ."')". $ff79b1 ." ". "LIMIT ". MAX_SEARCH_RESULTS ); $s8d777=array ( 'query' => $oeb31b, 'maximum-notes' => MAX_SEARCH_RESULTS, 'show-all-notes' => true, 'candy' => 'e2m_found', 'parameters' => $parameters, 'title' => '%total% '. $_strings['gs--found-for-query'] .': '. htmlspecialchars($x1b1cc,ENT_NOQUOTES,HSC_ENC), 'superheading' => '%total% '. $_strings['gs--found-for-query'], 'heading' => $x1b1cc, 'related-rss-href' => $g3ad42, 'highlight' => r163d(' ',$x1b1cc), 'no-notes-text' => $v75006, ); if ($d11128){ $s8d777['search-related-tag']=$d11128; } return kd864($s8d777); } function e2_check_timeout(){ static $y90272; if(is_null($y90272)) { $pf48ef=ini_get('max_execution_time'); if ($pf48ef){ $y90272=time()+$pf48ef-5; } else { $y90272=0; } } return ($y90272==0)?true:$y90272 >= time(); } function e2_write_dump_header($w8c7dd){ $v099fb=( 'SET SQL_MODE="NO_AUTO_VALUE_ON_ZERO";' .PHP_EOL. 'SET AUTOCOMMIT=0;' .PHP_EOL. 'START TRANSACTION;' .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;" .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;" .PHP_EOL. "/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;" .PHP_EOL. "/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;" .PHP_EOL. "/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;" .PHP_EOL. "/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=NO_AUTO_VALUE_ON_ZERO */;" .PHP_EOL. "/*!40101 SET NAMES utf8 */;" .PHP_EOL. '' ); fwrite($w8c7dd,$v099fb); return true; } function e2_write_dump_footer($w8c7dd){ $x251d1='COMMIT;' .PHP_EOL; $x251d1 .= "/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;" .PHP_EOL ."/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;" .PHP_EOL ."/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;".PHP_EOL ."/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;" .PHP_EOL; fwrite($w8c7dd,$x251d1); return true; } function e2_get_table_definition($d0c1d0,$oaab9e){ $i5c286=null; $result=mysql_query("SHOW CREATE TABLE `{$oaab9e}`",$d0c1d0); if($result){ $q47c80=mysql_fetch_array($result); $i5c286=$q47c80['Create Table']; } return $i5c286; } function e2_write_table_definition($w8c7dd,$d0c1d0,$oaab9e){ $q30618=e2_get_table_definition($d0c1d0,$oaab9e); if(e2_check_timeout() && $q30618){ fwrite($w8c7dd,$q30618); fwrite($w8c7dd,';'); fwrite($w8c7dd,PHP_EOL.PHP_EOL); return true; } return false; } function e2_get_table_data($d0c1d0,$oaab9e,$t7a86c,$maa9f7){ $x1b1cc="SELECT * FROM `{$oaab9e}` LIMIT {$t7a86c}, {$maa9f7}"; $result=mysql_query($x1b1cc); if (!$result){ return false; } $q66e9c=''; $l3c41a="INSERT INTO `{$oaab9e}` VALUES"; while ($of1965=mysql_fetch_assoc($result)) { $b691d5=array(); foreach($of1965 as $e2063c){ $b691d5[] = is_null($e2063c)?"NULL":"'".mysql_real_escape_string($e2063c,$d0c1d0)."'"; } $q66e9c.=$l3c41a.'('.join(', ',$b691d5).');'.PHP_EOL; } return $q66e9c; } function e2_table_disable_keys($oaab9e){ return "ALTER TABLE `{$oaab9e}` DISABLE KEYS;".PHP_EOL; } function e2_table_enable_keys($oaab9e){ return "ALTER TABLE `{$oaab9e}` ENABLE KEYS;".PHP_EOL; } function e2_get_total_records($d0c1d0,$oaab9e){ return mysql_result(mysql_query("SELECT COUNT(*) FROM `{$oaab9e}`",$d0c1d0),0); } function e2_write_table_data($w8c7dd,$d0c1d0,$oaab9e){ $mfbb44=e2_get_total_records($d0c1d0,$oaab9e); $t7a86c=0; $maa9f7=1000; $result=true; $e47495=20000; $d80fc1=30; if ($mfbb44){ $efbda5=e2_table_disable_keys($oaab9e); fwrite($w8c7dd,$efbda5); } $q66e9c="INSERT INTO `{$oaab9e}` VALUES"; $kde57a=$mfbb44; while ($kde57a > 0){ $x1b1cc="SELECT * FROM `{$oaab9e}` LIMIT {$t7a86c}, {$maa9f7}"; $result=mysql_query($x1b1cc); $ab428d=mysql_num_rows($result); if (!$result || !e2_check_timeout()) { $result=false; break; } $ydf347=array(); $k4b3a6=0; $qb6539=0; while ($of1965=mysql_fetch_assoc($result)) { if (!e2_check_timeout()) { $result=false; break; } $ab428d--; $x54ca8=array(); foreach($of1965 as $e2063c){ $x54ca8[] = is_null($e2063c)?"NULL":"'".mysql_real_escape_string($e2063c,$d0c1d0)."'"; } $s8d777='('.join(', ',$x54ca8).')'; $k4b3a6+=strlen($s8d777); $ydf347[] = $s8d777; $qb6539++; if ( ($k4b3a6 >= $e47495) || ($qb6539 >= $d80fc1) || ($ab428d==0)) { $x1b1cc=$q66e9c.join(', ',$ydf347).';'; fwrite($w8c7dd,$x1b1cc); fwrite($w8c7dd,PHP_EOL); $k4b3a6=0; $qb6539=0; $ydf347=array(); } } $t7a86c+=$maa9f7; $kde57a -= $maa9f7; } if ($mfbb44){ $p6bfc4=e2_table_enable_keys($oaab9e); fwrite($w8c7dd,$p6bfc4); } return$result; } function e2_backup($d0c1d0,$x9ab2e,$ea9745,$h93da6=array()) { mysql_query("SET NAMES utf8",$d0c1d0); $x2beda=tmpfile(); e2_write_dump_header($x2beda); $b75101=true; foreach($x9ab2e as $oaab9e){ $y91e7e=e2_write_table_definition($x2beda,$d0c1d0,$oaab9e); $h35285=e2_write_table_data($x2beda,$d0c1d0,$oaab9e); $b75101=$y91e7e && $h35285; if ($b75101===false){ break; } } if ($b75101){ e2_write_dump_footer($x2beda); fseek($x2beda,0); $w8c7dd=fopen($ea9745,'w+'); while ($b75101 && ($s8d777=fread($x2beda,1024))) { if(e2_check_timeout()) { fwrite($w8c7dd,$s8d777); } else { $b75101=false; } } fclose($w8c7dd); } fclose($x2beda); return $b75101; } function d3e5c($c0c426,$content){ $g52766=MTMPL_FOLDER.$c0c426 .'.mtmpl.php'; if(is_file($g52766)) { ob_start(); include $g52766; $ade7a3=ob_get_contents(); ob_end_clean(); return trim($ade7a3); } } function waed2(){ global$_config; $w9e35a=$_config['mail_from']; if ($w9e35a[strlen($w9e35a)-1]=='@'){ $w9e35a.=$_SERVER['HTTP_HOST']; } return $w9e35a; } function ra41b($s01b6e,$subject,$g78e73,$c145a2=''){ global $z57de2; if ($z57de2==DEV_HOST){ $t8fa14=tempnam('mail-debug',''); $x1cb25=( 'To:       '.$s01b6e."\n". 'Subject:  '.$subject."\n". "--------------------------------------------------\n". $g78e73 ); v6e52($t8fa14,$x1cb25); chmod($t8fa14,NEW_FILES_RIGHTS); rename($t8fa14,$t8fa14.'.txt'); } else { $subject='=?UTF-8?B?'. base64_encode($subject) .'?='; $c145a2.="\r\nContent-Type: text/plain; charset=utf-8"; mail($s01b6e,$subject,$g78e73,trim($c145a2)); } } function _A($x1cb25){ global$_candy,$z57de2,$va57c1,$u097cc; if ( preg_match('/\<a href\=\"(.*?)\"[^>]*\>(.*?)\<\/a\>/si',$x1cb25,$e9c28d) and ( $e9c28d[1]=='' or $e9c28d[1]==$u097cc or 'http://'. $z57de2.$e9c28d[1]==$u097cc or 'http://'. $z57de2.$va57c1 .'/'. $e9c28d[1]==$u097cc or $_candy=='e2m_install' ) ) { return $e9c28d[2]; } else { return $x1cb25; } } function _AT($qe8fab){ global$_candy,$z57de2,$va57c1,$u097cc; return ( $qe8fab=='' or $qe8fab==$u097cc or 'http://'. $z57de2.$qe8fab==$u097cc or 'http://'. $z57de2.$va57c1 .'/'. $qe8fab==$u097cc ); } function _IMGSRC($i435ed){ return j1492($i435ed); } function _COLOR($ff97c5,$ub8a9f,$bcc321,$u4efa2=1){ if(strlen($ff97c5)!=3 and strlen($ff97c5)!=6) return 'f0f'; if(strlen($ub8a9f)!=3 and strlen($ub8a9f)!=6) return 'f0f'; if(strlen($ff97c5)==3)$ff97c5=$ff97c5{0}.$ff97c5{0}.$ff97c5{1}.$ff97c5{1}.$ff97c5{2}.$ff97c5{2}; if(strlen($ub8a9f)==3)$ub8a9f=$ub8a9f{0}.$ub8a9f{0}.$ub8a9f{1}.$ub8a9f{1}.$ub8a9f{2}.$ub8a9f{2}; $tf09cc=array ( $ff97c5{0}.$ff97c5{1}, $ff97c5{2}.$ff97c5{3}, $ff97c5{4}.$ff97c5{5}, $ub8a9f{0}.$ub8a9f{1}, $ub8a9f{2}.$ub8a9f{3}, $ub8a9f{4}.$ub8a9f{5}, ); foreach ($tf09cc as $a8ce4b => $z9e366){ $tf09cc[$a8ce4b]=hexdec($z9e366); } $q22af6=array ( $tf09cc[0]+pow($bcc321,$u4efa2) * ($tf09cc[3]-$tf09cc[0]), $tf09cc[1]+pow($bcc321,$u4efa2) * ($tf09cc[4]-$tf09cc[1]), $tf09cc[2]+pow($bcc321,$u4efa2) * ($tf09cc[5]-$tf09cc[2]), ); $y70dda=''; foreach ($q22af6 as $a8ce4b => $z9e366){ $y70dda.=str_pad(dechex($z9e366),2,'0',STR_PAD_LEFT); } return $y70dda; } function _DT($l1ddcb,$yb35c6){ if (!$yb35c6) return ''; list ($a96b8c,$qb2c6c)=$yb35c6; $t2cb9d=$l1ddcb; $v7436f=s5a2f('m',$a96b8c,$qb2c6c); $t2cb9d=str_replace('{zone}',e2__escape_all(d9515($qb2c6c['offset'])), $t2cb9d); $t2cb9d=str_replace('{month}',e2__escape_all(e2l_get_string('um--month', array ('month' => $v7436f))), $t2cb9d); $t2cb9d=str_replace('{month-short}',e2__escape_all(e2l_get_string('um--month-short', array ('month' => $v7436f))), $t2cb9d); $t2cb9d=str_replace('{month-g}',e2__escape_all(e2l_get_string('um--month-g', array ('month' => $v7436f))), $t2cb9d); $t2cb9d=s5a2f($t2cb9d,$a96b8c,$qb2c6c); return $t2cb9d; } function _AGO($yb35c6){ return j7a0b($yb35c6[0], array ('offset' => $yb35c6[1]['offset'],'is_dst' => $yb35c6[1]['is_dst']) ); } function _NUM($x1cb25){ return e2_decline_for_number($x1cb25); } function _SIZE($size,$z3e34b=_SIZE_AUTO){ return e2_format_size($size,$z3e34b); } function _FIRST($o437b9){ return ($o437b9['_']['_ord']==0); } function _LAST($o437b9){ return ($o437b9['_']['_ord']==$o437b9['_']['_ord_max']); } function _CSS($oc7a62){ return nd4c1($oc7a62); } function _CSS_HREF($oc7a62){ return z576f($oc7a62); } function _JS($p32981){ return cd00a($p32981); } function _LIB($qe8acc){ return d16f0($qe8acc); } function _T($t52678){ return i166b($t52678); } function _X($t52678){ return y6a97($t52678); } function _T_FOR($t52678,$ed5566=null){ global$content; if ($ed5566===null)$ed5566=$t52678; if(array_key_exists($ed5566,$content)) { i166b($t52678); } else { return ''; } } function _GUIDES($zeca07=false){ global$_olba_guides; if(is_array($zeca07))$_olba_guides=$zeca07; if (!is_array($_olba_guides)) return; $t88408='<div style="position: fixed; width: 100%; height: 100%; z-index: -100">'; $t1d623=0; $e07d43=$_olba_guides; $e07d43[] = 100; foreach ($e07d43 as $g865c0 => $td89e2){ if ($td89e2==100) break; $t1d623+=$td89e2; $t88408.='<div style="position: fixed; left: '. $td89e2 .'%; width: 0; height: 100%; border-left: 1px #000 dotted; opacity: .2; -webkit-opacity: .2; -moz-opacity: .2"></div>'; $ea1b01='position: absolute; padding: 2px 3px; top: 0; font-size: 9px; background: #ccc; color: #000; font-family: "Verdana", sans-serif; opacity: .8; -webkit-opacity: .8; -moz-opacity: .8'; if ($e07d43[$g865c0+1]-$e07d43[$g865c0] < 4){ $t88408.='<div style="'. $ea1b01.'; right: '. (100-$td89e2) .'%; border-bottom-left-radius: .5em; -webkit-border-bottom-left-radius: .5em; -moz-border-bottom-left-radius: .5em;">'. $td89e2 .'%</div>'; } else { $t88408.='<div style="'. $ea1b01.'; left: '. $td89e2 .'%; border-bottom-right-radius: .5em; -webkit-border-bottom-right-radius: .5em; -moz-border-bottom-right-radius: .5em;">'. $td89e2 .'%</div>'; } } $t88408.='</div>'; $_olba_current_col=0; return $t88408; } function _S($nb45cf){ global$_strings; return$_strings[$nb45cf]; } function _SHORTCUT($zb0689){ return gbb8d($zb0689); } function e2__escape_all($nb45cf){ $t2cb9d=''; for ($g865c0=0; $g865c0 <= mb_strlen($nb45cf); ++ $g865c0){ $t2cb9d.='\\'. mb_substr($nb45cf,$g865c0,1); } return $t2cb9d; } function e2l_get_string($tfa206,$s8d777){ global$_strings; $zb0689=$_strings[$tfa206]; if(preg_match_all('/\$\[(.+?)\]/u',$zb0689,$e9c28d,PREG_SET_ORDER)) { foreach ($e9c28d as $qe3cc9){ $qb2145=$qe3cc9[1]; $qf2ffc=''; if(strstr($qb2145,'.')) list ($qb2145,$qf2ffc)=explode('.',$qb2145,2); if(array_key_exists($qb2145,$s8d777)) { if ($qf2ffc){ $zb0689=str_replace($qe3cc9[0],e2l__format_value($qf2ffc,$s8d777[$qb2145],$tfa206),$zb0689); } else { $zb0689=str_replace($qe3cc9[0],$s8d777[$qb2145],$zb0689); } } } } return $zb0689; } function e2l_transliterate($nb45cf){ $he358e=array(); if(is_file(DEFAULTS_FOLDER.'translit.txt')) { $he358e=file(DEFAULTS_FOLDER.'translit.txt'); } $rd98a0=$s01b6e=''; foreach ($he358e as $g865c0 => $z6438c){ if (!($g865c0%2))$rd98a0.=rtrim($z6438c) .' '; else $s01b6e.=rtrim($z6438c) .' '; if ($g865c0%2){ while (mb_strlen($s01b6e) < mb_strlen($rd98a0))$s01b6e.='_'; while (mb_strlen($s01b6e) > mb_strlen($rd98a0))$rd98a0.='_'; } } $d60ae1=''; $pde2e7=-1; for ($g865c0=0; $g865c0 < mb_strlen($rd98a0); ++ $g865c0){ $q4a8a0=mb_substr($rd98a0,$g865c0,1); if ($q4a8a0!=' '){ $d60ae1.=$q4a8a0; if ($pde2e7 == -1)$pde2e7=$g865c0; } elseif ($d60ae1){ $j52ac1=trim(mb_substr($s01b6e,$pde2e7,mb_strpos($s01b6e,' ',$pde2e7+1)-$pde2e7)); $t33c9b=array ($d60ae1,$j52ac1); $uce83f[mb_strlen($d60ae1)][] = $t33c9b; $d60ae1=''; $pde2e7=-1; } } $h1d78d=array(); for ($g865c0=count($uce83f); $g865c0 > 0; -- $g865c0){ foreach ($uce83f[$g865c0] as $t33c9b)$h1d78d[$t33c9b[0]] = $t33c9b[1]; } return strtr($nb45cf,$h1d78d); } function e2l__format_value($qf2ffc,$e2063c,$tfa206){ list ($qf2ffc,$u3ad73)=explode('.',$qf2ffc,2); $te6875='e2lstr_'. $qf2ffc; if(function_exists($te6875)) { return call_user_func($te6875,$e2063c,$u3ad73,$tfa206); } else { return $e2063c; } return $e2063c; } if($_config['write_log_reset'])__log(null); if(__LOG)__log('System: loaded'); if(is_file($o2d354=LANGUAGES_FOLDER.$settings['language'] .'.php')) { $_lang=$settings['language']; include $o2d354; } elseif(is_file($o2d354=LANGUAGES_FOLDER.DEFAULT_LANGUAGE .'.php')) { $_lang=DEFAULT_LANGUAGE; include $o2d354; } else { die ('Language file missing: '. $o2d354); } $_strings=e2l_load_strings(); if(!$n589b3) @include 'builder.php'; function e2(){ global $z57de2,$settings,$errors,$content, $va57c1,$full_blog_url,$stopwatch,$y11755,$u097cc, $_newsfeeds, $_instance, $_candy, $_config, $_route, $_strings, $_lang, $_candies_installer, $_candies_public, $_candies_spawning, $_candies_unabortable, $_candies_indexable, $_candies_indexable_conditionally, $_candies_ajax, $_user_folder_name, $_olba_includes, $_diagnose; v269a(); if(__LOG)__log('System: go'); $errors=array(); header('Content-type: text/html; charset='. OUTPUT_CHARSET); $_instance=false; if (@is_file(USER_FOLDER.'instance.psa')) { $x0d149=@tcdf0(USER_FOLDER.'instance.psa') or $x0d149=false; if ($x0d149){ $x0d149=@unserialize($x0d149) or $x0d149=false; if ($x0d149){ $_instance=$x0d149; } } } j4e27(@$settings['template']); if5a9(); if(__LOG)__log('System: Resolve <'. $_GET['go'] .'> {'); h7059(); list ($xc48ba,$parameters)=fb7e9($_GET['go']); if(__LOG)__log('} // Resolve'); if(__LOG)__log( 'System: Candy <'. $xc48ba .'> {' ); $_candy=$xc48ba; if ( @$_config['debug_slow_ajax'] and ( in_array($xc48ba,$_candies_ajax) ) ) { sleep(1+2 * (rand()/getrandmax())); } if (!in_array($xc48ba,$_candies_installer)) { e2_make_sure_that_installed(); } if(in_array($xc48ba,$_candies_unabortable)) { ignore_user_abort(1); } $a58387=(bool)oe852(); $k0b448=!in_array($xc48ba,$_candies_public); $e49ecc=$k0b448 && !$a58387; if(__LOG)__log('System: signed in? '. (int)$a58387); $cc1f6f=array ( 'done?' => $a58387, 'required?' => $k0b448, 'necessary?' => $e49ecc, ); $_newsfeeds=false; v3010( htmlspecialchars(r6f51(),ENT_NOQUOTES,HSC_ENC), d83c8('e2m_frontpage_rss') ); $parameters=l3b25($parameters); $content['notes'] = array (); $content['drafts'] = array (); $content['comments'] = array (); $content['notes-list'] = array (); $content['tags'] = array (); if(is_callable($xc48ba)) { if ($e49ecc){ if(substr($xc48ba,0,4)=='e2s_'){ $content=call_user_func('e2s_sign_in_necessary'); } else { $content['title']=$_strings['pt--sign-in']; } } else { if(__LOG)__log('System: candy call'); $content=call_user_func($xc48ba,$parameters); if(__LOG)__log('System: candy return'); } } else { $cc1f6f['required?']=false; $cc1f6f['necessary?']=false; $content=e2_error404_mode(); } if(__LOG)__log('} // Candy'); $content['class']=str_replace('_','-',str_replace('e2m_','',$xc48ba)); $content['sign-in']=$cc1f6f; $content['sign-in-prompt']=oe68c($xc48ba); if(e2_is_installed()) { if(__LOG)__log('System: nav and pages'); $content['navigation-links'] = array (array ( 'rel' => 'index', 'href' => d83c8('e2m_frontpage'), 'id' => 'link-index', )); if(array_key_exists('pages',$content)) { foreach (array ('prev','next','earlier','later') as $qc47d1){ if(array_key_exists($qc47d1 .'-href',$content['pages'])) { $n7ffc4=$qc47d1; if ($qc47d1=='earlier')$n7ffc4='prev'; if ($qc47d1=='later')$n7ffc4='next'; $content['navigation-links'][] = array ( 'rel' => $n7ffc4, 'href' => $content['pages'][$qc47d1 .'-href'], 'id' => 'link-'. $qc47d1, ); } } } if(__LOG)__log('System: search form'); if(array_key_exists('query',$parameters)) { $x1b1cc=trim($parameters['query']); } else { $x1b1cc=''; } $content['search'] = array ( 'form-action' => d83c8('e2s_search'), 'query' => htmlspecialchars(@$x1b1cc,ENT_COMPAT,HSC_ENC), ); if(__LOG)__log('System: blog information'); $content['blog']['author']=htmlspecialchars(q2640(),ENT_NOQUOTES,HSC_ENC); if(array_key_exists('description',$settings)) { $content['blog']['description']=htmlspecialchars(q6f10($settings['description']), ENT_NOQUOTES,HSC_ENC); } $content['blog']['title']=htmlspecialchars(r6f51(),ENT_NOQUOTES,HSC_ENC); $content['blog']['userpic-href']=DEFAULTS_FOLDER.'userpic.png'; if(is_file(USER_FOLDER .'userpic.png')) { $content['blog']['userpic-href']=USER_FOLDER .'userpic.png'; } elseif(is_file(USER_FOLDER .'userpic.jpg')) { $content['blog']['userpic-href']=USER_FOLDER .'userpic.jpg'; } $content['blog']['userpic-upload-action']=d83c8('e2j_userpic_upload'); $content['blog']['href']=d83c8('e2m_frontpage'); $content['blog']['rss-href']=d83c8('e2m_frontpage_rss'); $content['blog']['language']=$_lang; if(__LOG)__log('System: edge timeinfo'); $y97bc5=array (time(),g5c05()); $z5f36b=pa846('Y',$y97bc5[0]); $content['blog']['now']=$y97bc5; $daa103=$z5f36b; $l33b09=rcc02('start'); if(array_key_exists('stamp',$l33b09)) { $daa103=pa846('Y',$l33b09['stamp']); $content['blog']['start-time'] = array ((int)$l33b09['stamp'],$l33b09['timezone']); } $p40d73=(int)d8ca0(true,true); if (oe852()) { if(__LOG)__log('System: stuff for logged in user'); $content['blog']['drafts-count'] = (int)d8ca0(false,true); $content['admin-hrefs'] = array ( 'new-note' => d83c8('e2m_write'), 'drafts' => d83c8('e2m_drafts'), 'name-and-author' => d83c8('e2m_name_and_author'), 'settings' => d83c8('e2m_settings'), 'password' => d83c8('e2m_password'), 'database' => d83c8('e2m_database'), 'timezone' => d83c8('e2m_timezone'), 'logout' => d83c8('e2m_sign_out'), ); if($settings['comments']['on']) { list ($afe9e2,$c85ee4,$j20699)=k2a6b(); if ($afe9e2)$content['new-comments'] = array ( 'count' => $afe9e2, 'texts' => $c85ee4, 'href' => $j20699, ); } } else { if(__LOG)__log('System: login form'); $content['form-login']['form-action']=d83c8('e2s_sign_in'); $content['form-login']['form-check-password-action']=d83c8('e2j_check_password'); $content['form-login']['login-name'] = @$settings['author']; $content['form-login']['public-pc?']=false; if(array_key_exists('_login_request_message',$content)) { $content['form-login']['request']=$content['_login_request_message']; } } if (oe852()) { $pd0a87=(($p40d73 + (int)d8ca0(true,false)) == 0); } else { $pd0a87=($p40d73==0); } if($_db_error){ $pd0a87=false; } $q9fbfe=$_config['years_range_separator']? $_config['years_range_separator']:'&mdash;'; $content['blog']['years-range']=$daa103 . (($daa103==$z5f36b)? '':($q9fbfe.$z5f36b)); $content['blog']['notes-count']=$p40d73; $content['blog']['virgin?']=$pd0a87; if ($va57c1){ $content['blog']['parent-site-href']=substr($va57c1, (int)strpos('/',$va57c1)); } $content['hrefs'] = array ( 'sign-in' => d83c8('e2m_sign_in'), 'tags' => d83c8('e2m_tags'), 'everything' => d83c8('e2m_everything'), ); } $g1e2ad='noindex, follow'; if (@$_config['index_follow_everything']) { $g1e2ad='index, follow'; } if(in_array($xc48ba,$_candies_indexable)) { $content['robots']='index, follow'; } if(in_array($xc48ba,$_candies_indexable_conditionally)) { $content['robots']=$g1e2ad; } $content['output-charset']=OUTPUT_CHARSET; $content['base-href']=$full_blog_url. '/'; $content['current-href']=$u097cc; if (!array_key_exists('summary',$content)) { $content['summary']=$content['blog']['description']; } $content['title']=strip_tags(q6f10(htmlspecialchars($content['title'],ENT_NOQUOTES,HSC_ENC))); if (@$content['heading']) { $content['heading']=strip_tags(q6f10(htmlspecialchars($content['heading'],ENT_NOQUOTES,HSC_ENC))); } if(__LOG)__log('System: e2_modes {'); e2_modes($parameters); if(__LOG)__log('} // e2_modes'); if (@$_config['request_logging']) { $t8fa14=fopen(USER_FOLDER. 'log-'. date('Y-m-d') .'.txt','a'); fwrite($t8fa14,date('d.m.Y H:i:s') ."\tT = ". $content['pgt'] ."\tQ = ". $content['total_queries'] ."\tIP = ". $_SERVER['REMOTE_ADDR'] ."\tRequest = ". $_SERVER['REQUEST_URI'] ."\r\n"); fclose($t8fa14); } $content['misc']['sape-link']='http://www.sape.ru/r.206a4276c2.php'; $yc8542=round(r7f78()-$stopwatch,3); $content['engine']['pgt']=str_replace('.',',',$yc8542); if(function_exists('memory_get_peak_usage')) { $content['engine']['mp']=str_replace('.',',',round((memory_get_peak_usage()/1024/1024)*100)/100); } $content['engine']['qc'] = (int) @$y11755; $content['engine']['built?']=$n589b3; $content['engine']['installed?']=e2_is_installed(); $content['engine']['version']='v'. E2_VERSION; $f68966='('. $_strings['e2--release'] .' '. E2_RELEASE .', v'. E2_VERSION .')'; $content['engine']['version-description']=$_strings['e2--vname-aegea'] .' '. $f68966; $content['engine']['user-folder-name']=$_user_folder_name; $content['engine']['href']=E2_WEBSITE; $content['engine']['about']='<span title="E2 '.$f68966 .'">'. $_strings['e2--powered-by'] .' <a href="'. E2_WEBSITE .'">'. $_strings['e2--vname-aegea'] .'</a></span>'; $content['stylesheets']=w37ca(); $content['scripts']=b4753(); if (!@isset ($_diagnose['ok?'])) { if($_COOKIE['diagnose'] or @$_diagnose['need?']) { p8739(); } } if ($je1671=bec07()) { $content['message']=$je1671; } ob_start(); obc21(); $q78e62=ob_get_contents(); ob_end_clean(); if(is_array($content['notes'])) { foreach($content['notes'] as $saad65){ if(is_array($saad65['format-info']['links-required'])) { foreach ($saad65['format-info']['links-required'] as $y2a304){ if(substr($y2a304, -3)=='.js'){ cd00a(substr($y2a304,0, -3)); } if(substr($y2a304, -4)=='.css'){ nd4c1(substr($y2a304,0, -4)); } } } } } $content['stylesheets']=w37ca(); $content['scripts']=b4753(); if($_newsfeeds)$content['newsfeeds']=$_newsfeeds; ob_start(); i166b('head'); $r61ef8=ob_get_contents(); ob_end_clean(); ob_start(); i166b('scripts'); $zee59b=ob_get_contents(); ob_end_clean(); $q78e62=str_replace('<e2:head-data />',$r61ef8,$q78e62); $q78e62=str_replace('<e2:scripts-data />',$zee59b,$q78e62); if ( $ua0856=ne655() and !$_config['ignore_missing_template_files'] ) { echo '<h1>Templates missing</h1>'; echo '<ul>'; foreach ($ua0856 as $v380ec){ echo '<li>'. $v380ec.' </li>'; } echo '</ul>'; echo '<pre>'; print_r($content); echo '</pre>'; } else { echo $q78e62; } if(__LOG)__log('System: end'); if(DEV_TRACK_TIME and $z57de2==DEV_HOST){ $s06bc4=str_replace('.',',',round(r7f78()-$stopwatch,3)-$yc8542); echo '<div style="font-size: 300%; text-align: center; position: fixed; bottom: 0; width: 100%; background: #ffc; opacity: .88">'. '<span style="color: #f80">'. $content['engine']['pgt'] .' '. '<small>'. $content['engine']['qc'] .'q</small></span>'. '<span style="color: #08f"> + '. $s06bc4.' '. '<small>'. $_olba_includes .'i</small></span>'. '</div>'; } } if(__LOG)__log(''); ?>